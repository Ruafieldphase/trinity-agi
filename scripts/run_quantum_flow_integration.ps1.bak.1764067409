<#
.SYNOPSIS
    A PowerShell wrapper to execute the Quantum Flow to Goal System Python integration script.
.DESCRIPTION
    This script provides a controlled gateway for running the core Python integration process.
    It automatically locates the project's Python virtual environment, executes the script,
    checks the exit code for success, and can optionally open the resulting report file.
.PARAMETER OpenReport
    If specified, the script will attempt to open the latest JSON report in the default application upon successful completion.
.EXAMPLE
    .\run_quantum_flow_integration.ps1
    Runs the integration with standard output.
.EXAMPLE
    .\run_quantum_flow_integration.ps1 -OpenReport
    Runs the integration and opens the output JSON file if successful.
#>
[CmdletBinding()]
param(
    [switch]$OpenReport
)

# Stop script on non-terminating errors to ensure try/catch works reliably.
$ErrorActionPreference = "Stop"

# --- Configuration ---
# Determine workspace root from the script's location and define key paths.
$WorkspaceRoot    = $PSScriptRoot | Split-Path -Parent
$VenvRepoPath     = Join-Path -Path $WorkspaceRoot -ChildPath "fdo_agi_repo"
$PythonScriptPath = Join-Path -Path $WorkspaceRoot -ChildPath "scripts\integrate_quantum_flow_to_goals.py"
$LatestReportPath = Join-Path -Path $WorkspaceRoot -ChildPath "outputs\quantum_flow_latest.json"


# --- Helper Functions ---
function Get-PythonExecutable {
    param(
        [string]$BaseRepoPath
    )

    $venvPath = Join-Path -Path $BaseRepoPath -ChildPath ".venv"
    
    # Check for Linux/macOS path structure vs. Windows
    if ($IsCoreCLR -and -not $IsWindows) { # PowerShell 6+ on Linux/macOS
        $pythonExecutablePath = Join-Path -Path $venvPath -ChildPath "bin/python"
    }
    else { # Windows PowerShell or PowerShell Core on Windows
        $pythonExecutablePath = Join-Path -Path $venvPath -ChildPath "Scripts\python.exe"
    }

    if (Test-Path $pythonExecutablePath) {
        Write-Host "üêç Found Python virtual environment at: $pythonExecutablePath" -ForegroundColor DarkGray
        return $pythonExecutablePath
    }
    
    Write-Warning "Local Python virtual environment not found. Falling back to the 'python' command in PATH."
    return "python"
}


# --- Main Execution ---
try {
    Write-Host "üåä Quantum Flow ‚Üí Goal System ÌÜµÌï©..." -ForegroundColor Cyan
    Write-Host ""
    
    $pythonExecutable = Get-PythonExecutable -BaseRepoPath $VenvRepoPath

    # Execute the Python script. Stdout and Stderr will be handled by the PowerShell host.
    & $pythonExecutable $PythonScriptPath
    $exitCode = $LASTEXITCODE

    # Process results based on the Python script's exit code.
    if ($exitCode -eq 0) {
        Write-Host ""
        Write-Host "‚úÖ ÌÜµÌï© ÏôÑÎ£å!" -ForegroundColor Green
        
        if ($OpenReport) {
            if (Test-Path $LatestReportPath) {
                Write-Host "üìÑ Opening report: $LatestReportPath" -ForegroundColor Cyan
                Invoke-Item $LatestReportPath
            }
            else {
                Write-Warning "Report file not found at: $LatestReportPath"
            }
        }
        
        exit 0
    }
    else {
        # The Python script's stderr output should have already been displayed.
        # This provides a final, clear failure message and propagates the exit code.
        Write-Error "Python script failed with Exit Code: $exitCode."
        exit $exitCode
    }
}
catch {
    # This block catches terminating PowerShell errors (e.g., command not found).
    Write-Error "A script-level error occurred: $_"
    exit 1
}