<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Î™®ÎãàÌÑ∞ÎßÅ ÎåÄÏãúÎ≥¥Îìú</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --excellent: #10b981;
            --good: #3b82f6;
            --degraded: #f59e0b;
            --critical: #ef4444;
        }

        body {
            background-color: #f8f9fa;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #ffffff;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }

        .status-card {
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .status-card:hover {
            transform: translateY(-4px);
        }

        .status-EXCELLENT {
            border-left: 5px solid var(--excellent);
        }

        .status-GOOD {
            border-left: 5px solid var(--good);
        }

        .status-DEGRADED {
            border-left: 5px solid var(--degraded);
        }

        .status-CRITICAL {
            border-left: 5px solid var(--critical);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
        }

        .metric-label {
            font-size: 0.875rem;
            color: #6c757d;
            text-transform: uppercase;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 2rem;
        }

        .alert-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .alert-critical {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .alert-warning {
            background-color: #fef3c7;
            color: #92400e;
        }

        .alert-info {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .last-updated {
            font-size: 0.75rem;
            color: #e5e7eb;
        }

        .session-card {
            max-height: 420px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <div class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-0">Î™®ÎãàÌÑ∞ÎßÅ ÎåÄÏãúÎ≥¥Îìú</h1>
                    <p class="mb-0 mt-2">Ïã§ÏãúÍ∞Ñ ÏãúÏä§ÌÖú ÏÑ±Îä• Î∞è ÏÉÅÌÉú</p>
                    <p class="last-updated mb-0 mt-2">
                        ÎßàÏßÄÎßâ ÏóÖÎç∞Ïù¥Ìä∏: <span id="lastUpdate">Î∂àÎü¨Ïò§Îäî Ï§ë...</span>
                        <span class="ms-2">|</span>
                        ÎßàÏßÄÎßâ ÏÉàÎ°úÍ≥†Ïπ®: <span id="lastRefresh">ÏóÜÏùå</span>
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-outline-light me-2" onclick="refreshDashboard()">ÏßÄÍ∏à ÏÉàÎ°úÍ≥†Ïπ®</button>
                    <button class="btn btn-outline-primary" id="autoRefreshBtn" onclick="toggleAutoRefresh()">ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ®
                        ÌôúÏÑ±Ìôî</button>
                    <label for="autoRefreshInterval" class="ms-2 me-1 small"
                        style="color: rgba(255,255,255,0.9);">Í∞ÑÍ≤©</label>
                    <select id="autoRefreshInterval" class="form-select form-select-sm d-inline-block w-auto"
                        onchange="onRefreshIntervalChange(event)">
                        <option value="15000">15Ï¥à</option>
                        <option value="30000">30Ï¥à</option>
                        <option value="60000">60Ï¥à</option>
                        <option value="120000">2Î∂Ñ</option>
                        <option value="300000">5Î∂Ñ</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Closed-loop Snapshot -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0 d-inline">Closed-loop Snapshot</h5>
                            <small class="text-muted ms-2" id="clsLastTime">--</small>
                            <small class="text-muted ms-2" id="clsStatusMsg"></small>
                            <span class="spinner-border spinner-border-sm text-light ms-2" role="status"
                                aria-hidden="true" id="clsSpinner" style="display:none;"></span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <div class="metric-label">Realtime Strength</div>
                                <div class="metric-value" id="clsStrength">--</div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-label">Realtime Coherence</div>
                                <div class="metric-value" id="clsCoherence">--</div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-label">Realtime Phase</div>
                                <div class="metric-value" id="clsPhase">--</div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-label">Sim Resonance</div>
                                <div class="metric-value" id="clsSimRes">--</div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12 text-center">
                                <div class="metric-label">Sim Entropy</div>
                                <div class="metric-value" id="clsSimEntropy">--</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="container">
        <!-- ÏöîÏïΩ Ïπ¥Îìú -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card status-card status-EXCELLENT">
                    <div class="card-body text-center">
                        <div class="metric-label">ÏãúÏä§ÌÖú ÏÉÅÌÉú</div>
                        <div class="metric-value" id="healthStatus">--</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card">
                    <div class="card-body text-center">
                        <div class="metric-label">Í∞ÄÏö©ÏÑ±</div>
                        <div class="metric-value"><span id="availability">--</span>%</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card">
                    <div class="card-body text-center">
                        <div class="metric-label">Ï†ÑÏ≤¥ Í≤ΩÎ≥¥</div>
                        <div class="metric-value" id="totalAlerts">--</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card">
                    <div class="card-body text-center">
                        <div class="metric-label">Îç∞Ïù¥ÌÑ∞ Ìè¨Ïù∏Ìä∏</div>
                        <div class="metric-value" id="dataPoints">--</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Í≤ΩÎ≥¥ Ïã¨Í∞ÅÎèÑ Î∂ÑÌè¨ + ÏµúÍ∑º Í∏¥Í∏â Í≤ΩÎ≥¥ -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Í≤ΩÎ≥¥ Ïã¨Í∞ÅÎèÑ Î∂ÑÌè¨</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="severityChart"></canvas>
                        </div>
                        <div class="d-flex justify-content-around mt-3">
                            <div class="text-center">
                                <span class="alert-badge alert-critical" id="criticalCount">0</span>
                                <div class="small mt-1">Í∏¥Í∏â</div>
                            </div>
                            <div class="text-center">
                                <span class="alert-badge alert-warning" id="warningCount">0</span>
                                <div class="small mt-1">Í≤ΩÍ≥†</div>
                            </div>
                            <div class="text-center">
                                <span class="alert-badge alert-info" id="infoCount">0</span>
                                <div class="small mt-1">Ï†ïÎ≥¥</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">ÏµúÍ∑º Í∏¥Í∏â Í≤ΩÎ≥¥</h5>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <div id="criticalAlertsList">
                            <p class="text-muted">Í∏¥Í∏â Í≤ΩÎ≥¥ ÏóÜÏùå</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÏßÄÏó∞ ÏãúÍ∞Ñ Ï∂îÏù¥ -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">ÏßÄÏó∞ ÏãúÍ∞Ñ Ï∂îÏù¥(ÏãúÍ∞ÑÎ≥Ñ)</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="height: 400px;">
                            <canvas id="latencyChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Í∞ÄÏö©ÏÑ± ÌÉÄÏûÑÎùºÏù∏ -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Í∞ÄÏö©ÏÑ± ÌÉÄÏûÑÎùºÏù∏(ÏãúÍ∞ÑÎ≥Ñ)</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="availabilityChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ï±ÑÎÑê ÌÜµÍ≥Ñ Ìëú -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Ï±ÑÎÑê ÌÜµÍ≥Ñ</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Ï±ÑÎÑê</th>
                                        <th>Í∞ÄÏö©ÏÑ±</th>
                                        <th>ÌèâÍ∑† ÏßÄÏó∞</th>
                                        <th>95ÌçºÏÑºÌÉÄÏùº ÏßÄÏó∞</th>
                                        <th>ÌëúÏ§ÄÌé∏Ï∞®</th>
                                        <th>Ï∂îÏÑ∏</th>
                                        <th>Í≤ΩÎ≥¥</th>
                                    </tr>
                                </thead>
                                <tbody id="channelStatsTable">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">Î∂àÎü¨Ïò§Îäî Ï§ë...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AGI ÏãúÏä§ÌÖú ÏÉÅÌÉú -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">AGI ÏãúÏä§ÌÖú ÏÉÅÌÉú</h5>
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge bg-dark" id="safeModeBadge" style="display:none;">ÏïàÏ†Ñ Î™®Îìú</span>
                            <span class="badge bg-primary" id="agiStatusBadge">--</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="alert alert-info d-flex justify-content-between align-items-center mb-0">
                                    <div>
                                        <strong>Ìó¨Ïä§ Í≤åÏù¥Ìä∏:</strong>
                                        <span id="healthGateStatus" class="badge bg-secondary">Î∂àÎü¨Ïò§Îäî Ï§ë...</span>
                                        <span class="ms-2 text-muted small" id="healthGateDetails">--</span>
                                    </div>
                                    <button class="btn btn-sm btn-outline-primary"
                                        onclick="refreshHealthGate()">ÏÉàÎ°úÍ≥†Ïπ®</button>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="metric-value" id="agiTotalEvents">--</div>
                                    <div class="metric-label">Ï†ÑÏ≤¥ Ïù¥Î≤§Ìä∏</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="metric-value" id="agiTaskCount">--</div>
                                    <div class="metric-label">Í≥†Ïú† ÏûëÏóÖ</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="metric-value" id="agiQueueDepth">--</div>
                                    <div class="metric-label">ÎåÄÍ∏∞ ÏûëÏóÖ</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="metric-value" id="agiActiveWorkers">--</div>
                                    <div class="metric-label">ÌôúÏÑ± ÏõåÏª§</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resonance Policy Summary -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0 d-inline">Resonance Policy</h5>
                            <small class="text-muted ms-2" id="policyLastTime">--</small>
                            <small class="text-muted ms-2" id="policyStatusMsg"></small>
                        </div>
                        <div>
                            <span class="spinner-border spinner-border-sm text-light me-2" role="status"
                                aria-hidden="true" id="policySpinner" style="display:none;"></span>
                            <span class="badge bg-secondary" id="policyMode">mode: --</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-4">
                                <div class="metric-label">Allow</div>
                                <div class="metric-value" id="policyAllow">--</div>
                            </div>
                            <div class="col-md-4">
                                <div class="metric-label">Warn</div>
                                <div class="metric-value" id="policyWarn">--</div>
                            </div>
                            <div class="col-md-4">
                                <div class="metric-label">Block</div>
                                <div class="metric-value" id="policyBlock">--</div>
                            </div>
                        </div>
                        <hr />
                        <div>
                            <div class="metric-label">Configured Policy</div>
                            <div id="policyActive" class="mb-2">--</div>
                            <div class="metric-label">Last Observed</div>
                            <div id="policyObserved" class="mb-2">--</div>
                            <div class="metric-label">Last Reasons</div>
                            <pre id="policyReasons" class="mb-0"
                                style="white-space: pre-wrap; background:#f3f4f6; padding: 0.75rem; border-radius: 8px;">--</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stream Observer (Desktop Telemetry) -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0 d-inline">üîç Stream Observer</h5>
                            <small class="text-muted ms-2">Desktop Telemetry & Clipboard Monitoring</small>
                            <small class="text-muted ms-2" id="observerLastTime">--</small>
                        </div>
                        <div>
                            <span class="badge" id="observerStatus" style="background-color: #6c757d;">UNKNOWN</span>
                            <span class="spinner-border spinner-border-sm text-primary ms-2" role="status"
                                aria-hidden="true" id="observerSpinner" style="display:none;"></span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row text-center mb-4">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="metric-value" id="observerTotalRecords">--</div>
                                    <div class="metric-label">Ï†ÑÏ≤¥ Î†àÏΩîÎìú</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="metric-value" id="observerClipboardChanges">--</div>
                                    <div class="metric-label">ÌÅ¥Î¶ΩÎ≥¥Îìú Î≥ÄÍ≤Ω</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="metric-value" id="observerAvgTextLen">--</div>
                                    <div class="metric-label">ÌèâÍ∑† ÌÖçÏä§Ìä∏ Í∏∏Ïù¥</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="metric-value" id="observerDataSize">--</div>
                                    <div class="metric-label">Îç∞Ïù¥ÌÑ∞ ÌÅ¨Í∏∞</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="chart-container">
                                    <canvas id="observerActivityChart"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">Ïã§ÏãúÍ∞Ñ Î™®ÎãàÌÑ∞ÎßÅ ÏÉÅÌÉú</h6>
                                        <div class="mb-2">
                                            <span class="metric-label">PID:</span>
                                            <span id="observerPid" class="ms-2">--</span>
                                        </div>
                                        <div class="mb-2">
                                            <span class="metric-label">Îç∞Ïù¥ÌÑ∞ Ïã†ÏÑ†ÎèÑ:</span>
                                            <span id="observerFreshness" class="ms-2">--</span>
                                        </div>
                                        <div class="mb-2">
                                            <span class="metric-label">ÏµúÍ∑º ÌôúÎèô:</span>
                                            <span id="observerRecentActivity" class="ms-2">--</span>
                                        </div>
                                        <hr />
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-sm btn-outline-primary"
                                                onclick="refreshObserverData()">
                                                ÏÉàÎ°úÍ≥†Ïπ®
                                            </button>
                                            <button class="btn btn-sm btn-outline-success"
                                                onclick="viewObserverDetails()">
                                                ÏÉÅÏÑ∏ Î≥¥Í∏∞
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Top Processes and Windows Tables -->
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h6 class="text-muted">Top Processes</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th>Process</th>
                                                <th class="text-end">Count</th>
                                            </tr>
                                        </thead>
                                        <tbody id="observerTopProcesses">
                                            <tr>
                                                <td colspan="2" class="text-muted text-center">Loading...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted">Top Windows</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th>Window Title</th>
                                                <th class="text-end">Count</th>
                                            </tr>
                                        </thead>
                                        <tbody id="observerTopWindows">
                                            <tr>
                                                <td colspan="2" class="text-muted text-center">Loading...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Legend -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0">Resonance Optimization Signals</h5>
                            <small class="text-muted" id="optStatusMsg">--</small>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row text-center mb-3">
                            <div class="col-4">
                                <div class="metric-label">Total</div>
                                <div class="metric-value" id="optTotal">--</div>
                            </div>
                            <div class="col-4">
                                <div class="metric-label">Peak</div>
                                <div class="metric-value" id="optPeak">--</div>
                            </div>
                            <div class="col-4">
                                <div class="metric-label">Off-peak</div>
                                <div class="metric-value" id="optOffpeak">--</div>
                            </div>
                        </div>
                        <div class="row text-center mb-3">
                            <div class="col-4">
                                <div class="metric-label">Throttle</div>
                                <div class="metric-value" id="optThrottle">--</div>
                            </div>
                            <div class="col-4">
                                <div class="metric-label">Gateway Pref</div>
                                <div class="metric-value" id="optPreferGateway">--</div>
                            </div>
                            <div class="col-4">
                                <div class="metric-label">Primary</div>
                                <div class="metric-value" style="font-size: 1rem;" id="optPrimary">--</div>
                            </div>
                        </div>
                        <hr />
                        <div class="metric-label">ÎßàÏßÄÎßâ Ïù¥Î≤§Ìä∏</div>
                        <ul class="list-unstyled small mb-0">
                            <li>Time: <span id="optLastTime">--</span></li>
                            <li>Phase: <span id="optLastPhase">--</span></li>
                            <li>Channels: <span id="optLastChannels">--</span></li>
                            <li>Off-peak Mode: <span id="optLastOffpeakMode">--</span></li>
                            <li>Batch Compression: <span id="optLastCompression">--</span></li>
                            <li>Learning Bias: <span id="optLastLearning">--</span></li>
                            <li>Throttle: <span id="optLastThrottle">--</span></li>
                        </ul>
                        <div class="mt-3">
                            <canvas id="optChart" height="140"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0">Gateway Optimizer</h5>
                            <small class="text-muted" id="goptStatusMsg">--</small>
                        </div>
                        <span class="badge bg-secondary" id="goptMode">--</span>
                    </div>
                    <div class="card-body">
                        <div class="row text-center mb-3">
                            <div class="col-3">
                                <div class="metric-label">Entries</div>
                                <div class="metric-value" id="goptEntries">--</div>
                            </div>
                            <div class="col-3">
                                <div class="metric-label">Peak</div>
                                <div class="metric-value" id="goptPeakEntries">--</div>
                            </div>
                            <div class="col-3">
                                <div class="metric-label">Off-peak</div>
                                <div class="metric-value" id="goptOffpeakEntries">--</div>
                            </div>
                            <div class="col-3">
                                <div class="metric-label">Warmups</div>
                                <div class="metric-value" id="goptWarmups">--</div>
                            </div>
                        </div>
                        <div class="row text-center mb-3">
                            <div class="col-3">
                                <div class="metric-label">Target</div>
                                <div class="metric-value" id="goptTarget">--</div>
                            </div>
                            <div class="col-3">
                                <div class="metric-label">Warn</div>
                                <div class="metric-value" id="goptWarning">--</div>
                            </div>
                            <div class="col-3">
                                <div class="metric-label">Critical</div>
                                <div class="metric-value" id="goptCritical">--</div>
                            </div>
                            <div class="col-3">
                                <div class="metric-label">œÉ Target</div>
                                <div class="metric-value" id="goptSigma">--</div>
                            </div>
                        </div>
                        <hr />
                        <div class="metric-label">ÎßàÏßÄÎßâ Ïã§Ìñâ</div>
                        <ul class="list-unstyled small mb-0">
                            <li>Time: <span id="goptLastTime">--</span></li>
                            <li>Phase: <span id="goptLastPhase">--</span></li>
                            <li>Timeout: <span id="goptLastTimeout">--</span></li>
                            <li>Concurrency: <span id="goptLastConcurrency">--</span></li>
                            <li>Warmup: <span id="goptLastWarmup">--</span></li>
                            <li>Next Warmup: <span id="goptLastNext">--</span></li>
                        </ul>
                        <div class="mt-3">
                            <canvas id="goptChart" height="140"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-body py-2">
                        <span class="badge bg-success me-2">Allow</span>
                        <span class="badge bg-warning text-dark me-2">Warn</span>
                        <span class="badge bg-danger me-2">Block</span>
                        <span class="ms-3 text-muted">Color reflects counts in current window</span>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ÏûêÎ¶¨ÌëúÏãúÏûê: ÌéòÏù¥ÏßÄ Î°úÎçî/Ïò§ÌÜ†Î¶¨ÌîÑÎ†àÏãú ÌõÖ
        const DEFAULT_REFRESH_INTERVAL = 30000;
        let autoRefreshEnabled = false;
        let autoRefreshIntervalMs = DEFAULT_REFRESH_INTERVAL;
        let refreshIntervalId = null;
        let optChartInstance = null;
        let goptChartInstance = null;

        function refreshDashboard() {
            // Ïô∏Î∂Ä Ïä§ÌÅ¨Î¶ΩÌä∏/Î∞±ÏóîÎìúÍ∞Ä Îç∞Ïù¥ÌÑ∞Î•º Ï£ºÏûÖÌïúÎã§Îäî Í∞ÄÏ†ï
            // Ïó¨Í∏∞ÏÑúÎäî 'ÎßàÏßÄÎßâ ÏÉàÎ°úÍ≥†Ïπ®'Îßå Í∞±Ïã†
            const now = new Date().toLocaleString('ko-KR');
            const lastRefreshEl = document.getElementById('lastRefresh');
            if (lastRefreshEl) lastRefreshEl.textContent = now;
        }

        function toggleAutoRefresh() {
            const btn = document.getElementById('autoRefreshBtn');
            if (!autoRefreshEnabled) {
                refreshIntervalId = setInterval(refreshDashboard, autoRefreshIntervalMs);
                autoRefreshEnabled = true;
                if (btn) btn.textContent = 'ÏùºÏãúÏ†ïÏßÄ: ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ®';
            } else {
                if (refreshIntervalId) clearInterval(refreshIntervalId);
                refreshIntervalId = null;
                autoRefreshEnabled = false;
                if (btn) btn.textContent = 'ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® ÌôúÏÑ±Ìôî';
            }
        }

        function onRefreshIntervalChange(e) {
            const ms = parseInt(e.target.value, 10);
            if (!isNaN(ms)) {
                autoRefreshIntervalMs = ms;
                if (autoRefreshEnabled) {
                    if (refreshIntervalId) clearInterval(refreshIntervalId);
                    refreshIntervalId = setInterval(refreshDashboard, autoRefreshIntervalMs);
                }
            }
        }

        function refreshHealthGate() {
            // ÏûêÎ¶¨ÌëúÏãúÏûê: Ïô∏Î∂Ä Îç∞Ïù¥ÌÑ∞ ÏÜåÏä§Î•º ÌÜµÌï¥ Í∞±Ïã†
            const st = document.getElementById('healthGateStatus');
            if (st) st.textContent = 'Í∞±Ïã†Îê®';
        }
    </script>

    <script>
        // Load Closed-loop Snapshot from metrics JSON
        async function loadClosedLoopSnapshot() {
            try {
                const sp = document.getElementById('clsSpinner'); if (sp) sp.style.display = '';
                let res = await fetch('../outputs/monitoring_metrics_latest.json').catch(() => null);
                if (!res || !res.ok) { res = await fetch('outputs/monitoring_metrics_latest.json').catch(() => null); }
                if (!res || !res.ok) {
                    const m = document.getElementById('clsStatusMsg');
                    if (m) m.textContent = 'no data (fetch failed)';
                    if (sp) sp.style.display = 'none';
                    return;
                }
                const data = await res.json();
                const cls = (data && data.AGI && data.AGI.ClosedLoop) ? data.AGI.ClosedLoop : {};
                const rt = cls.realtime || {};
                const sim = cls.simulator || {};
                const setText = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = (val ?? '--'); };
                setText('clsStrength', rt.strength);
                setText('clsCoherence', rt.coherence);
                setText('clsPhase', rt.phase);
                setText('clsSimRes', sim.last_resonance);
                setText('clsSimEntropy', sim.last_entropy);
                if (cls.last_time) { setText('clsLastTime', cls.last_time); }
                const m = document.getElementById('clsStatusMsg');
                if (m) {
                    const anyVal = (rt.strength ?? rt.coherence ?? rt.phase ?? sim.last_resonance ?? sim.last_entropy);
                    m.textContent = anyVal ? '' : 'no snapshot in window';
                }
                if (sp) sp.style.display = 'none';
            } catch { }
        }
        window.addEventListener('DOMContentLoaded', loadClosedLoopSnapshot);
    </script>

    <script>
        // Lightweight fetch to populate Resonance Policy from metrics JSON
        async function loadPolicySummary() {
            try {
                const sp = document.getElementById('policySpinner'); if (sp) sp.style.display = '';
                let res = await fetch('../outputs/monitoring_metrics_latest.json').catch(() => null);
                if (!res || !res.ok) {
                    res = await fetch('outputs/monitoring_metrics_latest.json').catch(() => null);
                }
                if (!res || !res.ok) {
                    const m = document.getElementById('policyStatusMsg');
                    if (m) m.textContent = 'no data (fetch failed)';
                    if (sp) sp.style.display = 'none';
                    return;
                }
                const data = await res.json();
                const policy = (data && data.AGI && data.AGI.Policy) ? data.AGI.Policy : {};
                const counts = policy.counts || { allow: 0, warn: 0, block: 0 };
                const last = policy.last || {};

                const setText = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
                setText('policyAllow', counts.allow ?? 0);
                setText('policyWarn', counts.warn ?? 0);
                setText('policyBlock', counts.block ?? 0);
                const modeText = `mode: ${last.mode ?? '--'}`;
                setText('policyMode', modeText);
                setText('policyActive', `${policy.active ?? '--'}`);
                setText('policyObserved', `${last.policy ?? '--'}`);
                const reasons = Array.isArray(last.reasons) ? last.reasons.join('\n') : (last.reasons ?? '--');
                setText('policyReasons', reasons || '--');
                if (policy.last_time) { setText('policyLastTime', policy.last_time); }

                const opt = policy.optimization || {};
                setText('optTotal', opt.total ?? 0);
                setText('optPeak', opt.peak ?? 0);
                setText('optOffpeak', opt.offpeak ?? 0);
                setText('optThrottle', opt.throttle ?? 0);
                setText('optPreferGateway', opt.prefer_gateway ?? 0);
                let primaryText = '--';
                if (opt.preferred_primary && typeof opt.preferred_primary === 'object') {
                    const entries = [];
                    for (const [key, value] of Object.entries(opt.preferred_primary)) {
                        entries.push(`${key}:${value}`);
                    }
                    if (entries.length) {
                        primaryText = entries.join(', ');
                    }
                }
                setText('optPrimary', primaryText);
                const optLast = opt.last || {};
                setText('optLastTime', optLast.timestamp || '--');
                const optLastPhase = optLast.is_peak_now === true ? 'PEAK' : (optLast.is_peak_now === false ? 'OFF-PEAK' : '--');
                setText('optLastPhase', optLastPhase);
                const optChannels = Array.isArray(optLast.preferred_channels)
                    ? optLast.preferred_channels.join(', ')
                    : (optLast.preferred_channels || '--');
                setText('optLastChannels', optChannels);
                setText('optLastOffpeakMode', optLast.offpeak_mode || '--');
                setText('optLastCompression', optLast.batch_compression || '--');
                setText('optLastLearning', optLast.learning_bias || '--');
                const optThrottleText = optLast.should_throttle === true ? 'YES' : (optLast.should_throttle === false ? 'NO' : '--');
                setText('optLastThrottle', optThrottleText);
                const optStatus = document.getElementById('optStatusMsg');
                if (optStatus) {
                    optStatus.textContent = (opt.total ?? 0) > 0 ? '' : 'Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå';
                }

                const gatewayOpt = (data && data.GatewayOptimizer) ? data.GatewayOptimizer : {};
                setText('goptEntries', gatewayOpt.total_entries ?? 0);
                setText('goptPeakEntries', gatewayOpt.peak_entries ?? 0);
                setText('goptOffpeakEntries', gatewayOpt.offpeak_entries ?? 0);
                setText('goptWarmups', gatewayOpt.warmup_triggers ?? 0);
                const goptThresholds = gatewayOpt.thresholds || {};
                setText('goptTarget', goptThresholds.latency_target_ms ?? '--');
                setText('goptWarning', goptThresholds.latency_warning_ms ?? '--');
                setText('goptCritical', goptThresholds.latency_critical_ms ?? '--');
                setText('goptSigma', goptThresholds.stability_target_sigma ?? '--');
                const goptMode = gatewayOpt.dry_run === true ? 'DRY-RUN' : (gatewayOpt.dry_run === false ? 'ACTIVE' : '--');
                const goptBadge = document.getElementById('goptMode');
                if (goptBadge) {
                    goptBadge.classList.remove('bg-secondary', 'bg-success', 'bg-warning', 'bg-danger', 'text-dark');
                    goptBadge.textContent = goptMode;
                    if (goptMode === 'DRY-RUN') {
                        goptBadge.classList.add('bg-warning', 'text-dark');
                    } else if (goptMode === 'ACTIVE') {
                        goptBadge.classList.add('bg-success');
                    } else {
                        goptBadge.classList.add('bg-secondary');
                    }
                }
                const goptLast = gatewayOpt.last || {};
                const goptStatus = document.getElementById('goptStatusMsg');
                if (goptStatus) {
                    goptStatus.textContent = gatewayOpt.total_entries ? '' : 'Í∏∞Î°ù ÏóÜÏùå';
                }
                setText('goptLastTime', goptLast.timestamp || '--');
                const goptLastPhase = goptLast.phase
                    ? String(goptLast.phase).toUpperCase()
                    : (goptLast.is_peak_now === true ? 'PEAK' : (goptLast.is_peak_now === false ? 'OFF-PEAK' : '--'));
                setText('goptLastPhase', goptLastPhase);
                const goptLastTimeout = goptLast.timeout_ms != null ? `${goptLast.timeout_ms} ms` : '--';
                setText('goptLastTimeout', goptLastTimeout);
                setText('goptLastConcurrency', goptLast.concurrency != null ? goptLast.concurrency : '--');
                const goptLastWarmup = goptLast.warmup_active === true ? 'ACTIVE' : (goptLast.warmup_active === false ? 'IDLE' : '--');
                setText('goptLastWarmup', goptLastWarmup);
                setText('goptLastNext', goptLast.next_warmup || '--');

                const palette = ['#10b981', '#3b82f6', '#f59e0b', '#6366f1'];
                const optChartCanvas = document.getElementById('optChart');
                if (optChartCanvas) {
                    const optValues = [
                        opt.peak ?? 0,
                        opt.offpeak ?? 0,
                        opt.throttle ?? 0,
                        opt.prefer_gateway ?? 0,
                    ];
                    if (optChartInstance) {
                        optChartInstance.destroy();
                    }
                    optChartInstance = new Chart(optChartCanvas, {
                        type: 'bar',
                        data: {
                            labels: ['Peak', 'Off-peak', 'Throttle', 'Gateway Pref'],
                            datasets: [{
                                data: optValues,
                                backgroundColor: palette,
                                borderRadius: 6,
                            }],
                        },
                        options: {
                            responsive: true,
                            plugins: { legend: { display: false } },
                            scales: {
                                x: { grid: { display: false } },
                                y: {
                                    beginAtZero: true,
                                    grid: { color: 'rgba(148, 163, 184, 0.2)' },
                                    ticks: { precision: 0 },
                                },
                            },
                        },
                    });
                }

                const goptChartCanvas = document.getElementById('goptChart');
                if (goptChartCanvas) {
                    const goptValues = [
                        gatewayOpt.total_entries ?? 0,
                        gatewayOpt.peak_entries ?? 0,
                        gatewayOpt.offpeak_entries ?? 0,
                        gatewayOpt.warmup_triggers ?? 0,
                    ];
                    if (goptChartInstance) {
                        goptChartInstance.destroy();
                    }
                    goptChartInstance = new Chart(goptChartCanvas, {
                        type: 'bar',
                        data: {
                            labels: ['Total', 'Peak', 'Off-peak', 'Warmups'],
                            datasets: [{
                                data: goptValues,
                                backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'],
                                borderRadius: 6,
                            }],
                        },
                        options: {
                            responsive: true,
                            plugins: { legend: { display: false } },
                            scales: {
                                x: { grid: { display: false } },
                                y: {
                                    beginAtZero: true,
                                    grid: { color: 'rgba(148, 163, 184, 0.2)' },
                                    ticks: { precision: 0 },
                                },
                            },
                        },
                    });
                }

                // Badge coloring: block>0 => danger, warn>0 => warning, else success
                const badge = document.getElementById('policyMode');
                if (badge) {
                    badge.classList.remove('bg-secondary', 'bg-success', 'bg-warning', 'bg-danger');
                    if ((counts.block ?? 0) > 0) {
                        badge.classList.add('bg-danger');
                    } else if ((counts.warn ?? 0) > 0) {
                        badge.classList.add('bg-warning');
                    } else {
                        badge.classList.add('bg-success');
                    }
                }
                const m = document.getElementById('policyStatusMsg');
                if (m) {
                    const total = (counts.allow ?? 0) + (counts.warn ?? 0) + (counts.block ?? 0);
                    m.textContent = total > 0 ? '' : 'no policy events in window';
                }
                if (sp) sp.style.display = 'none';
            } catch { }
        }
        window.addEventListener('DOMContentLoaded', loadPolicySummary);
    </script>

    <script>
        // Load Stream Observer Telemetry Data
        let observerActivityChartInstance = null;
        async function loadStreamObserverData() {
            try {
                const sp = document.getElementById('observerSpinner'); if (sp) sp.style.display = '';
                let res = await fetch('../outputs/stream_observer_summary_latest.json').catch(() => null);
                if (!res || !res.ok) {
                    res = await fetch('outputs/stream_observer_summary_latest.json').catch(() => null);
                }
                if (!res || !res.ok) {
                    const status = document.getElementById('observerStatus');
                    if (status) {
                        status.textContent = 'NO DATA';
                        status.style.backgroundColor = '#6c757d';
                    }
                    if (sp) sp.style.display = 'none';
                    return;
                }
                const data = await res.json();

                const setText = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };

                // Update metrics
                setText('observerTotalRecords', data.total_records || 0);
                setText('observerClipboardChanges', data.total_changes || 0);
                setText('observerAvgTextLen', data.avg_text_length ? Math.round(data.avg_text_length) : 0);
                setText('observerDataSize', data.data_file_size || '--');

                // Update status badge
                const status = document.getElementById('observerStatus');
                if (status) {
                    const isHealthy = data.total_records > 0 && (new Date() - new Date(data.data_modified || 0)) < 300000; // 5min
                    status.textContent = isHealthy ? 'HEALTHY' : 'STALE';
                    status.style.backgroundColor = isHealthy ? '#10b981' : '#f59e0b';
                }

                // Update last time
                setText('observerLastTime', data.last_change_time || '--');

                // Update monitoring status
                setText('observerPid', data.monitor_pid || '--');
                const freshness = data.data_modified ? `${Math.round((new Date() - new Date(data.data_modified)) / 1000)}s ago` : '--';
                setText('observerFreshness', freshness);
                setText('observerRecentActivity', data.changes_last_hour || 0);

                // Update Top Processes table
                const topProcesses = data.summary?.top_processes || data.top_processes || [];
                const processesBody = document.getElementById('observerTopProcesses');
                if (processesBody && topProcesses.length > 0) {
                    processesBody.innerHTML = topProcesses.slice(0, 5).map(([name, count]) =>
                        `<tr><td>${name}</td><td class="text-end">${count}</td></tr>`
                    ).join('');
                } else if (processesBody) {
                    processesBody.innerHTML = '<tr><td colspan="2" class="text-muted text-center">No data</td></tr>';
                }

                // Update Top Windows table
                const topWindows = data.summary?.top_window_titles || data.top_window_titles || [];
                const windowsBody = document.getElementById('observerTopWindows');
                if (windowsBody && topWindows.length > 0) {
                    windowsBody.innerHTML = topWindows.slice(0, 5).map(([title, count]) => {
                        const shortTitle = title.length > 50 ? title.substring(0, 50) + '...' : title;
                        return `<tr><td title="${title}">${shortTitle}</td><td class="text-end">${count}</td></tr>`;
                    }).join('');
                } else if (windowsBody) {
                    windowsBody.innerHTML = '<tr><td colspan="2" class="text-muted text-center">No data</td></tr>';
                }

                // Create activity chart
                const canvas = document.getElementById('observerActivityChart');
                if (canvas && data.hourly_activity) {
                    if (observerActivityChartInstance) {
                        observerActivityChartInstance.destroy();
                    }
                    observerActivityChartInstance = new Chart(canvas, {
                        type: 'line',
                        data: {
                            labels: data.hourly_activity.map(h => h.hour),
                            datasets: [{
                                label: 'Clipboard Changes',
                                data: data.hourly_activity.map(h => h.changes),
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: true, position: 'top' },
                                title: { display: true, text: 'ÏãúÍ∞ÑÎ≥Ñ ÌÅ¥Î¶ΩÎ≥¥Îìú ÌôúÎèô' }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: { color: 'rgba(148, 163, 184, 0.2)' },
                                    ticks: { precision: 0 }
                                },
                                x: { grid: { display: false } }
                            }
                        }
                    });
                }

                if (sp) sp.style.display = 'none';
            } catch (err) {
                console.error('Failed to load Stream Observer data:', err);
                const sp = document.getElementById('observerSpinner');
                if (sp) sp.style.display = 'none';

                // Show error in status
                const status = document.getElementById('observerStatus');
                if (status) {
                    status.textContent = 'ERROR';
                    status.style.backgroundColor = '#ef4444';
                    status.title = err.message || 'Failed to load data';
                }

                // Clear tables
                const processesBody = document.getElementById('observerTopProcesses');
                if (processesBody) {
                    processesBody.innerHTML = '<tr><td colspan="2" class="text-danger text-center">Error loading data</td></tr>';
                }
                const windowsBody = document.getElementById('observerTopWindows');
                if (windowsBody) {
                    windowsBody.innerHTML = '<tr><td colspan="2" class="text-danger text-center">Error loading data</td></tr>';
                }
            }
        }

        function refreshObserverData() {
            loadStreamObserverData();
        }

        function viewObserverDetails() {
            window.open('../outputs/stream_observer_summary_latest.md', '_blank');
        }

        window.addEventListener('DOMContentLoaded', loadStreamObserverData);
    </script>
</body>

</html>