param(
    [switch]$Register,
    [switch]$Unregister,
    [string]$Time = "12:30",
    [string]$TaskName = "BreakMaintenance_Lunch",
    [string]$Description = "Run light maintenance during human break",
    [switch]$RunNow
)

$ErrorActionPreference = 'Stop'

function Get-WorkspaceRoot {
    $here = $PSScriptRoot
    if (-not $here) { $here = Split-Path -Parent $MyInvocation.MyCommand.Path }
    return (Split-Path -Parent $here)
}

if (-not ($Register -or $Unregister)) {
    Write-Host "Specify -Register or -Unregister" -ForegroundColor Yellow
    exit 1
}

$root = Get-WorkspaceRoot
$scriptPath = Join-Path $root 'scripts/daily_monitoring_maintenance.ps1'
if (-not (Test-Path -LiteralPath $scriptPath)) {
    Write-Host "daily_monitoring_maintenance.ps1 not found at $scriptPath" -ForegroundColor Red
    exit 1
}

if ($Unregister) {
    try {
        Unregister-ScheduledTask -TaskName $TaskName -Confirm:$false -ErrorAction Stop
        Write-Host "Unregistered task: $TaskName" -ForegroundColor Green
    }
    catch {
        Write-Host "Task not found or could not unregister: $TaskName" -ForegroundColor Yellow
    }
    exit 0
}

# Register
try {
    $at = [DateTime]::Parse($Time)
}
catch {
    Write-Host "Invalid -Time format. Use HH:mm (e.g., 12:30)" -ForegroundColor Red
    exit 1
}

$action = New-ScheduledTaskAction -Execute 'powershell.exe' -Argument "-NoProfile -ExecutionPolicy Bypass -File `"$scriptPath`""
$dt = Get-Date -Hour $at.Hour -Minute $at.Minute -Second 0
$trigger = New-ScheduledTaskTrigger -Daily -At $dt
$settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -StartWhenAvailable
$settings.Hidden = $true

try {
    Register-ScheduledTask -TaskName $TaskName -Action $action -Trigger $trigger -Settings $settings -Description $Description -ErrorAction Stop | Out-Null
    Write-Host "Registered task: $TaskName at $($at.ToString('HH:mm'))" -ForegroundColor Green
}
catch {
    # Try to update existing task
    try {
        Set-ScheduledTask -TaskName $TaskName -Trigger $trigger -Action $action -Settings $settings | Out-Null
        Write-Host "Updated task: $TaskName to $($at.ToString('HH:mm'))" -ForegroundColor Green
    }
    catch {
        Write-Host "Failed to register or update task: $TaskName. $_" -ForegroundColor Red
        exit 1
    }
}

if ($RunNow) {
    try {
        Start-ScheduledTask -TaskName $TaskName
        Write-Host "Started task now: $TaskName" -ForegroundColor Cyan
    }
    catch {
        Write-Host "Could not start task now: $TaskName" -ForegroundColor Yellow
    }
}

exit 0
