<#
.SYNOPSIS
    ChatGPT(Lua)ìš© AGI ì»¨í…ìŠ¤íŠ¸ ìš”ì•½ì„ ìƒì„±í•˜ì—¬ íŒŒì¼ ì €ì¥ ë° í´ë¦½ë³´ë“œ ë³µì‚¬ (v2 - Clean)

.DESCRIPTION
    ë‹¤ìŒ ì†ŒìŠ¤ì—ì„œ ìµœì‹  ì‹ í˜¸ë¥¼ ìˆ˜ì§‘í•´ Lua ì¹œí™”ì ì¸ ë§ˆí¬ë‹¤ìš´ ìš”ì•½ê³¼ JSONì„ ìƒì„±í•©ë‹ˆë‹¤:
        1. outputs/.copilot_context_summary.md (Copilot ì»¨í…ìŠ¤íŠ¸ - ìµœìš°ì„ )
        2. outputs/session_continuity_latest.md (ì„¸ì…˜ ì—°ì†ì„±)
        3. fdo_agi_repo/memory/goal_tracker.json (ììœ¨ ëª©í‘œ)
        4. outputs/quick_status_latest.json (ì‹œìŠ¤í…œ ìƒíƒœ)
        5. outputs/RHYTHM_*.md (ë¦¬ë“¬ ìƒíƒœ)

    ìƒì„±ë¬¼:
        - MD: outputs/chatgpt_lua_handoff_latest.md (í´ë¦½ë³´ë“œ ìë™ ë³µì‚¬)
        - JSON: outputs/chatgpt_lua_handoff_latest.json

.PARAMETER Hours
    ì¡°íšŒ ì‹œê°„ ë²”ìœ„ íŒíŠ¸ (í‘œì‹œìš©, ê¸°ë³¸ 24ì‹œê°„)

.PARAMETER Format
    ì¶œë ¥ í˜•ì‹: 'concise'(ê°„ê²°) | 'detailed'(ìƒì„¸). ê¸°ë³¸ 'concise'

.PARAMETER OpenChatGPT
    ìƒì„± í›„ ChatGPT ì›¹ ë¸Œë¼ìš°ì € ìë™ ì—´ê¸°

.PARAMETER OutFile
    ì¶œë ¥ Markdown íŒŒì¼ ê²½ë¡œ

.PARAMETER OutJson
    ì¶œë ¥ JSON íŒŒì¼ ê²½ë¡œ

.PARAMETER NoCopy
    í´ë¦½ë³´ë“œ ë³µì‚¬ ë¹„í™œì„±í™”

.EXAMPLE
    .\send_to_chatgpt_lua.ps1
    # ê¸°ë³¸: 24h ê°„ê²° ëª¨ë“œ, íŒŒì¼ ì €ì¥ + í´ë¦½ë³´ë“œ ë³µì‚¬

.EXAMPLE
    .\send_to_chatgpt_lua.ps1 -Format detailed -OpenChatGPT
    # ìƒì„¸ ëª¨ë“œë¡œ ìƒì„± í›„ ChatGPT ì›¹ ì—´ê¸°
#>

[CmdletBinding()]
param(
    [int]$Hours = 24,
    [ValidateSet('concise', 'detailed')]
    [string]$Format = 'concise',
    [switch]$OpenChatGPT,
    [string]$OutFile = '',
    [string]$OutJson = '',
    [switch]$NoCopy
)

Set-StrictMode -Version Latest
$ErrorActionPreference = 'Stop'

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# ğŸ”§ Helper Functions
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

function Get-WorkspaceRoot {
    return (Split-Path -Parent $PSScriptRoot)
}

function Get-SafePath {
    param([string]$RelativePath)
    return Join-Path (Get-WorkspaceRoot) $RelativePath
}

function Read-TextFile {
    param([string]$Path)
    try {
        if (Test-Path -LiteralPath $Path) {
            return [string](Get-Content -LiteralPath $Path -Raw -Encoding UTF8)
        }
    }
    catch {}
    return $null
}

function Read-JsonFile {
    param([string]$Path)
    try {
        if (Test-Path -LiteralPath $Path) {
            $text = Get-Content -LiteralPath $Path -Raw -Encoding UTF8
            if (-not [string]::IsNullOrWhiteSpace($text)) {
                return ($text | ConvertFrom-Json -ErrorAction Stop)
            }
        }
    }
    catch {}
    return $null
}

function Truncate-String {
    param([string]$Text, [int]$MaxLength = 2000)
    if ([string]::IsNullOrWhiteSpace($Text)) { return '' }
    if ($Text.Length -le $MaxLength) { return $Text }
    return $Text.Substring(0, $MaxLength) + "`n`n... (truncated)"
}

function New-ParentDirectory {
    param([string]$FilePath)
    $dir = Split-Path -LiteralPath $FilePath -Parent
    if (![string]::IsNullOrWhiteSpace($dir) -and -not (Test-Path -LiteralPath $dir)) {
        New-Item -ItemType Directory -Path $dir -Force | Out-Null
    }
}

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# ğŸ“Š Data Collection Functions
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

function Get-CopilotContext {
    $path = Get-SafePath 'outputs/.copilot_context_summary.md'
    $content = Read-TextFile $path
    return @{
        Available = ($null -ne $content)
        Content   = if ($content) { Truncate-String $content 3000 } else { '' }
        Source    = $path
    }
}

function Get-SessionContinuity {
    $path = Get-SafePath 'outputs/session_continuity_latest.md'
    $content = Read-TextFile $path
    return @{
        Available = ($null -ne $content)
        Content   = if ($content) { Truncate-String $content 2000 } else { '' }
        Source    = $path
    }
}

function Get-GoalTracker {
    $path = Get-SafePath 'fdo_agi_repo/memory/goal_tracker.json'
    $data = Read-JsonFile $path
    
    if ($null -eq $data) {
        return @{ Available = $false; ActiveCount = 0; RecentGoals = @() }
    }
    
    $active = @($data.goals | Where-Object { $_.status -eq 'in_progress' })
    $recent = @($data.goals | Sort-Object -Property @{Expression = { $_.updated_at }; Descending = $true } | Select-Object -First 3)
    
    return @{
        Available   = $true
        ActiveCount = $active.Count
        TotalCount  = $data.goals.Count
        RecentGoals = $recent | ForEach-Object {
            @{
                id       = $_.id
                title    = $_.title
                status   = $_.status
                progress = if ($_.progress) { $_.progress } else { 0 }
            }
        }
        Source      = $path
    }
}

function Get-SystemStatus {
    $path = Get-SafePath 'outputs/quick_status_latest.json'
    $data = Read-JsonFile $path
    
    if ($null -eq $data) {
        return @{ Available = $false }
    }
    
    return @{
        Available   = $true
        Health      = if ($data.health_score) { $data.health_score } else { 'N/A' }
        QueueServer = if ($data.queue_server) { $data.queue_server } else { 'Unknown' }
        RpaWorker   = if ($data.rpa_worker) { $data.rpa_worker } else { 'Unknown' }
        Timestamp   = if ($data.timestamp) { $data.timestamp } else { 'N/A' }
        Source      = $path
    }
}

function Get-RhythmStatus {
    $restPath = Get-SafePath 'outputs/RHYTHM_REST_PHASE_*.md'
    $statusPath = Get-SafePath 'outputs/RHYTHM_SYSTEM_STATUS_REPORT.md'
    
    $restFiles = @(Get-ChildItem -Path (Split-Path $restPath) -Filter (Split-Path $restPath -Leaf) -ErrorAction SilentlyContinue | 
        Sort-Object LastWriteTime -Descending | Select-Object -First 1)
    
    $restContent = if ($restFiles.Count -gt 0) { Read-TextFile $restFiles[0].FullName } else { $null }
    $statusContent = Read-TextFile $statusPath
    
    return @{
        Available    = ($null -ne $restContent -or $null -ne $statusContent)
        RestPhase    = if ($restContent) { Truncate-String $restContent 500 } else { '' }
        StatusReport = if ($statusContent) { Truncate-String $statusContent 500 } else { '' }
    }
}

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# ğŸ“ Report Generation Functions
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

function New-MarkdownReport {
    param(
        [hashtable]$Copilot,
        [hashtable]$Session,
        [hashtable]$Goals,
        [hashtable]$System,
        [hashtable]$Rhythm,
        [int]$Hours,
        [string]$Format
    )
    
    $timestamp = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
    $sb = [System.Text.StringBuilder]::new()
    
    # Header
    [void]$sb.AppendLine("# ğŸ¤– AGI â†’ ChatGPT(Lua) Handoff Report")
    [void]$sb.AppendLine("")
    [void]$sb.AppendLine("**Generated**: $timestamp")
    [void]$sb.AppendLine("**Window**: Last $Hours hours")
    [void]$sb.AppendLine("**Format**: $Format")
    [void]$sb.AppendLine("")
    [void]$sb.AppendLine("---")
    [void]$sb.AppendLine("")
    
    # 1. Quick Summary
    [void]$sb.AppendLine("## ğŸ“Š Quick Summary")
    [void]$sb.AppendLine("")
    [void]$sb.AppendLine("- **Active Goals**: $($Goals.ActiveCount) / $($Goals.TotalCount)")
    [void]$sb.AppendLine("- **System Health**: $($System.Health)")
    [void]$sb.AppendLine("- **Queue Server**: $($System.QueueServer)")
    [void]$sb.AppendLine("- **RPA Worker**: $($System.RpaWorker)")
    [void]$sb.AppendLine("- **Rhythm**: $(if ($Rhythm.Available) { 'Available' } else { 'N/A' })")
    [void]$sb.AppendLine("")
    
    # 2. Copilot Context (Priority #1)
    if ($Copilot.Available) {
        [void]$sb.AppendLine("## ğŸ§  Copilot Context (Primary)")
        [void]$sb.AppendLine("")
        [void]$sb.AppendLine("```")
        [void]$sb.AppendLine($Copilot.Content)
        [void]$sb.AppendLine("```")
        [void]$sb.AppendLine("")
    }
    
    # 3. Session Continuity
    if ($Session.Available) {
        [void]$sb.AppendLine("## ğŸ”„ Session Continuity")
        [void]$sb.AppendLine("")
        [void]$sb.AppendLine("```")
        [void]$sb.AppendLine($Session.Content)
        [void]$sb.AppendLine("```")
        [void]$sb.AppendLine("")
    }
    
    # 4. Recent Goals
    if ($Goals.Available -and $Goals.RecentGoals.Count -gt 0) {
        [void]$sb.AppendLine("## ğŸ¯ Recent Goals")
        [void]$sb.AppendLine("")
        foreach ($goal in $Goals.RecentGoals) {
            [void]$sb.AppendLine("- **[$($goal.id)]** $($goal.title)")
            [void]$sb.AppendLine("  - Status: $($goal.status)")
            [void]$sb.AppendLine("  - Progress: $($goal.progress)%")
        }
        [void]$sb.AppendLine("")
    }
    
    # 5. Rhythm Status (if detailed)
    if ($Format -eq 'detailed' -and $Rhythm.Available) {
        [void]$sb.AppendLine("## ğŸŒŠ Rhythm Status")
        [void]$sb.AppendLine("")
        if ($Rhythm.RestPhase) {
            [void]$sb.AppendLine("### Rest Phase")
            [void]$sb.AppendLine("```")
            [void]$sb.AppendLine($Rhythm.RestPhase)
            [void]$sb.AppendLine("```")
            [void]$sb.AppendLine("")
        }
        if ($Rhythm.StatusReport) {
            [void]$sb.AppendLine("### Status Report")
            [void]$sb.AppendLine("```")
            [void]$sb.AppendLine($Rhythm.StatusReport)
            [void]$sb.AppendLine("```")
            [void]$sb.AppendLine("")
        }
    }
    
    # Footer
    [void]$sb.AppendLine("---")
    [void]$sb.AppendLine("")
    [void]$sb.AppendLine("**ğŸ’¡ Next Steps**:")
    [void]$sb.AppendLine("1. Review recent goals and progress")
    [void]$sb.AppendLine("2. Check system health status")
    [void]$sb.AppendLine("3. Continue autonomous work or wait for human input")
    [void]$sb.AppendLine("")
    
    return $sb.ToString()
}

function New-JsonReport {
    param(
        [hashtable]$Copilot,
        [hashtable]$Session,
        [hashtable]$Goals,
        [hashtable]$System,
        [hashtable]$Rhythm,
        [int]$Hours
    )
    
    return @{
        generated_at       = (Get-Date -Format 'o')
        window_hours       = $Hours
        sources            = @{
            copilot = @{
                available = $Copilot.Available
                source    = $Copilot.Source
            }
            session = @{
                available = $Session.Available
                source    = $Session.Source
            }
            goals   = @{
                available = $Goals.Available
                source    = $Goals.Source
            }
            system  = @{
                available = $System.Available
                source    = $System.Source
            }
            rhythm  = @{
                available = $Rhythm.Available
            }
        }
        summary            = @{
            active_goals = $Goals.ActiveCount
            total_goals  = $Goals.TotalCount
            health       = $System.Health
            queue_server = $System.QueueServer
            rpa_worker   = $System.RpaWorker
        }
        goals              = $Goals.RecentGoals
        copilot_context    = if ($Copilot.Available) { $Copilot.Content } else { $null }
        session_continuity = if ($Session.Available) { $Session.Content } else { $null }
    }
}

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# ğŸš€ Main Execution
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

try {
    Write-Host ""
    Write-Host "ğŸ¤– ChatGPT(Lua) Handoff Generator v2" -ForegroundColor Cyan
    Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
    Write-Host ""
    
    # Set default output paths if not specified
    if ([string]::IsNullOrWhiteSpace($OutFile)) {
        $OutFile = Get-SafePath 'outputs/chatgpt_lua_handoff_latest.md'
    }
    if ([string]::IsNullOrWhiteSpace($OutJson)) {
        $OutJson = Get-SafePath 'outputs/chatgpt_lua_handoff_latest.json'
    }
    
    # Collect data
    Write-Host "ğŸ“¡ Collecting data..." -ForegroundColor Yellow
    $copilot = Get-CopilotContext
    $session = Get-SessionContinuity
    $goals = Get-GoalTracker
    $system = Get-SystemStatus
    $rhythm = Get-RhythmStatus
    
    Write-Host "   âœ“ Copilot Context: $(if ($copilot.Available) { 'OK' } else { 'N/A' })" -ForegroundColor DarkGray
    Write-Host "   âœ“ Session: $(if ($session.Available) { 'OK' } else { 'N/A' })" -ForegroundColor DarkGray
    Write-Host "   âœ“ Goals: $(if ($goals.Available) { "$($goals.ActiveCount) active" } else { 'N/A' })" -ForegroundColor DarkGray
    Write-Host "   âœ“ System: $(if ($system.Available) { $system.Health } else { 'N/A' })" -ForegroundColor DarkGray
    Write-Host "   âœ“ Rhythm: $(if ($rhythm.Available) { 'OK' } else { 'N/A' })" -ForegroundColor DarkGray
    Write-Host ""
    
    # Generate reports
    Write-Host "ğŸ“ Generating reports..." -ForegroundColor Yellow
    $markdown = New-MarkdownReport -Copilot $copilot -Session $session -Goals $goals -System $system -Rhythm $rhythm -Hours $Hours -Format $Format
    $json = New-JsonReport -Copilot $copilot -Session $session -Goals $goals -System $system -Rhythm $rhythm -Hours $Hours
    
    # Save Markdown
    New-ParentDirectory $OutFile
    $markdown | Out-File -FilePath $OutFile -Encoding UTF8 -Force
    Write-Host "   âœ“ Markdown saved: $OutFile" -ForegroundColor Green
    
    # Save JSON
    New-ParentDirectory $OutJson
    $json | ConvertTo-Json -Depth 10 | Out-File -FilePath $OutJson -Encoding UTF8 -Force
    Write-Host "   âœ“ JSON saved: $OutJson" -ForegroundColor Green
    Write-Host ""
    
    # Copy to clipboard
    if (-not $NoCopy) {
        $markdown | Set-Clipboard
        Write-Host "ğŸ“‹ Copied to clipboard!" -ForegroundColor Green
        Write-Host "   ğŸ‘‰ Paste into ChatGPT: Ctrl+V â†’ Enter" -ForegroundColor Yellow
        Write-Host ""
    }
    
    # Open ChatGPT if requested
    if ($OpenChatGPT) {
        Write-Host "ğŸŒ Opening ChatGPT..." -ForegroundColor Cyan
        Start-Process "https://chat.openai.com"
        Start-Sleep -Seconds 1
        Write-Host "   âœ“ Browser opened!" -ForegroundColor Green
        Write-Host ""
    }
    
    # Summary
    Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
    Write-Host "âœ… Handoff Complete!" -ForegroundColor Green
    Write-Host ""
    Write-Host "ğŸ“Š Summary:" -ForegroundColor White
    Write-Host "   â€¢ Active Goals: $($goals.ActiveCount) / $($goals.TotalCount)" -ForegroundColor White
    Write-Host "   â€¢ System Health: $($system.Health)" -ForegroundColor White
    Write-Host "   â€¢ Queue Server: $($system.QueueServer)" -ForegroundColor White
    Write-Host "   â€¢ Format: $Format ($Hours hours)" -ForegroundColor White
    Write-Host ""
    Write-Host "ğŸ’¡ Tip: Run again anytime with VS Code Task" -ForegroundColor Magenta
    Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
    Write-Host ""
    
    exit 0
}
catch {
    Write-Host ""
    Write-Host "âŒ Error: $($_.Exception.Message)" -ForegroundColor Red
    Write-Host "   Location: $($_.InvocationInfo.ScriptName):$($_.InvocationInfo.ScriptLineNumber)" -ForegroundColor Red
    Write-Host ""
    Write-Host "ğŸ“‹ Debug Info:" -ForegroundColor Yellow
    Write-Host "   - Copilot: $($copilot.Available)" -ForegroundColor DarkGray
    Write-Host "   - Session: $($session.Available)" -ForegroundColor DarkGray
    Write-Host "   - Goals: $($goals.Available)" -ForegroundColor DarkGray
    Write-Host "   - System: $($system.Available)" -ForegroundColor DarkGray
    Write-Host ""
    exit 1
}

if ($Text.Length -le $Max) { return $Text }
return ($Text.Substring(0, [Math]::Min($Max, [Math]::Max(0, $Text.Length)))) + "..."
}

function Summarize-Goals {
    param($GoalJson, [int]$Top = 5)
    if (-not $GoalJson) { return @{ count = 0; active = @(); byStatus = @{} } }

    # goal_tracker.jsonì´ ë°°ì—´ ë˜ëŠ” ê°ì²´(goals í•„ë“œ)ë¥¼ ê°€ì •í•˜ê³  ìœ ì—° ì²˜ë¦¬
    $goals = $null
    if ($GoalJson -is [System.Collections.IEnumerable]) { $goals = @($GoalJson) }
    elseif ($GoalJson.PSObject.Properties.Name -contains 'goals') { $goals = @($GoalJson.goals) }
    else { $goals = @() }

    $goals = $goals | Where-Object { $_ } | ForEach-Object { $_ }
    $by = @{}
    foreach ($g in $goals) {
        $st = if ($g.status) { [string]$g.status } else { 'unknown' }
        if (-not $by.ContainsKey($st)) { $by[$st] = 0 }
        $by[$st]++
    }
    $active = $goals | Where-Object { $_.status -in @('in_progress', 'pending', 'planned', 'open') -or -not $_.status } |
    Select-Object -First $Top
    return @{ count = $goals.Count; active = $active; byStatus = $by }
}

function Summarize-SystemHealth {
    param($QuickJson)
    if (-not $QuickJson) { return @{ available = $false } }

    $summary = [ordered]@{ available = $true }
    foreach ($k in @('status', 'cpu', 'memory', 'process', 'queue', 'api', 'watchdog', 'workers')) {
        if ($QuickJson.PSObject.Properties.Name -contains $k) { $summary[$k] = $QuickJson.$k }
    }
    return $summary
}

function Build-Markdown {
    param(
        [Parameter(Mandatory)]$Ctx,
        [ValidateSet('concise', 'detailed')][string]$Mode
    )
    $nl = "`n"
    $sb = New-Object System.Text.StringBuilder

    [void]$sb.AppendLine("# ChatGPT Lua Handoff (AGI)  ")
    [void]$sb.AppendLine("- Generated: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')  ")
    [void]$sb.AppendLine("- Window: last $($Ctx.hours)h  ")
    [void]$sb.AppendLine("- Format: $Mode  ")

    # ì¶”ì²œ ë‹¤ìŒ í–‰ë™(ìˆìœ¼ë©´ Copilot ìš”ì•½ì—ì„œ ìš°ì„ )
    if ($Ctx.copilotSummary) {
        [void]$sb.AppendLine("\n## next actions")
        $block = ($Ctx.copilotSummary -replace "\r", "")
        [void]$sb.AppendLine($block)
    }
    elseif ($Ctx.sessionMd) {
        # ì„¸ì…˜ ë¦¬í¬íŠ¸ì—ì„œ 'ì¶”ì²œ ë‹¤ìŒ í–‰ë™' ì„¹ì…˜ ì¶”ì¶œ(ê°„ë‹¨ íŒ¨í„´)
        $pat = '(?ms)^\s*ğŸ’¡\s*ì¶”ì²œ ë‹¤ìŒ í–‰ë™\s*:?(.*?)(?:^\s*[-#]|\z)'
        $m = [regex]::Match($Ctx.sessionMd, $pat)
        if ($m.Success) {
            [void]$sb.AppendLine("\n## next actions")
            [void]$sb.AppendLine(($m.Groups[1].Value.Trim()))
        }
    }

    # Goals
    [void]$sb.AppendLine("\n## goals")
    if ($Ctx.goals.count -gt 0) {
        [void]$sb.AppendLine("- total: $($Ctx.goals.count)")
        if ($Ctx.goals.byStatus.Count -gt 0) {
            [void]$sb.AppendLine("- by status:")
            foreach ($k in ($Ctx.goals.byStatus.Keys | Sort-Object)) {
                [void]$sb.AppendLine("  - $k: $($Ctx.goals.byStatus[$k])")
            }
        }
        if ($Ctx.goals.active.Count -gt 0) {
            [void]$sb.AppendLine("- active top:")
            foreach ($g in $Ctx.goals.active) {
                $title = if ($g.title) { $g.title } elseif ($g.name) { $g.name } else { '<untitled>' }
                $st = if ($g.status) { $g.status } else { 'unknown' }
                [void]$sb.AppendLine("  - [$st] $title")
            }
        }
    }
    else {
        [void]$sb.AppendLine("- no goals found")
    }

    # System
    [void]$sb.AppendLine("\n## system")
    if ($Ctx.system.available) {
        foreach ($p in $Ctx.system.Keys) {
            if ($p -eq 'available') { continue }
            $val = $Ctx.system[$p]
            if ($val -is [string] -or $val -is [ValueType]) {
                [void]$sb.AppendLine("- $p: $val")
            }
            elseif ($Mode -eq 'detailed') {
                $snippet = ($val | ConvertTo-Json -Depth 6)
                $snippet = Truncate-Text -Text $snippet -Max 1500
                [void]$sb.AppendLine("- $p:")
                [void]$sb.AppendLine("  ```json")
                [void]$sb.AppendLine(($snippet -replace "`r", ""))
                [void]$sb.AppendLine("  ```")
            }
        }
    } else {
        [void]$sb.AppendLine("- quick_status not available")
    }

    # Raw appendix (detailedì¼ ë•Œë§Œ ê°„ë‹¨íˆ ì²¨ë¶€)
    if ($Mode -eq 'detailed') {
        if ($Ctx.copilotSummary) {
            [void]$sb.AppendLine("\n---\n### appendix: copilot summary (raw)")
            [void]$sb.AppendLine("\n````markdown")
            [void]$sb.AppendLine(($Ctx.copilotSummary -replace "\r",""))
            [void]$sb.AppendLine("````")
        }
        if ($Ctx.sessionMd) {
            [void]$sb.AppendLine("\n---\n### appendix: session continuity (raw)")
            $sess = Truncate-Text -Text $Ctx.sessionMd -Max 4000
            [void]$sb.AppendLine("\n````markdown")
            [void]$sb.AppendLine(($sess -replace "\r",""))
            [void]$sb.AppendLine("````")
        }
    }

    return $sb.ToString()
}

function Build-JsonObject {
    param([Parameter(Mandatory)]$Ctx,[string]$Mode)
    $o = [ordered]@{
        generated_at = (Get-Date).ToString('o')
        hours = $Ctx.hours
        format = $Mode
        sources = [ordered]@{
            copilot_context_summary = [bool]$Ctx.flags.copilot
            session_continuity = [bool]$Ctx.flags.session
            goal_tracker = [bool]$Ctx.flags.goals
            quick_status = [bool]$Ctx.flags.quick
        }
        next_actions = $null
        goals = [ordered]@{
            total = $Ctx.goals.count
            by_status = $Ctx.goals.byStatus
            active = $Ctx.goals.active
        }
        system = $Ctx.system
    }

    # next_actions ê°„ë‹¨ ì¶”ì¶œ (copilotSummaryë‚˜ sessionMdì—ì„œ)
    if ($Ctx.copilotSummary) {
        $o.next_actions = Truncate-Text -Text $Ctx.copilotSummary -Max 1500
    } elseif ($Ctx.sessionMd) {
        $pat = '(?ms)^\s*ğŸ’¡\s*ì¶”ì²œ ë‹¤ìŒ í–‰ë™\s*:?(.*?)(?:^\s*[-#]|\z)'
        $m = [regex]::Match($Ctx.sessionMd,$pat)
        if ($m.Success) { $o.next_actions = ($m.Groups[1].Value.Trim()) }
    }
    return [pscustomobject]$o
}

try {
    Write-Host "Preparing Lua-friendly ChatGPT handoff..." -ForegroundColor Cyan

    $copilotPath = Get-PathSafe 'outputs/.copilot_context_summary.md'
    $sessionPath = Get-PathSafe 'outputs/session_continuity_latest.md'
    $goalsPath   = Get-PathSafe 'fdo_agi_repo/memory/goal_tracker.json'
    $quickPath   = Get-PathSafe 'outputs/quick_status_latest.json'

    $copilotMd = Get-ContentSafeText -FullPath $copilotPath
    $sessionMd = Get-ContentSafeText -FullPath $sessionPath
    $goalJson  = Get-ContentSafeJson -FullPath $goalsPath
    $quickJson = Get-ContentSafeJson -FullPath $quickPath

    $ctx = [ordered]@{
        hours = $Hours
        flags = @{ copilot=($null -ne $copilotMd); session=($null -ne $sessionMd); goals=($null -ne $goalJson); quick=($null -ne $quickJson) }
        copilotSummary = $copilotMd
        sessionMd = $sessionMd
        goals = (Summarize-Goals -GoalJson $goalJson)
        system = (Summarize-SystemHealth -QuickJson $quickJson)
    }

    $md = Build-Markdown -Ctx $ctx -Mode $Format
    $jsonObj = Build-JsonObject -Ctx $ctx -Mode $Format

    # ì €ì¥
    New-ParentDirIfNeeded -Path $OutFile
    Set-Content -LiteralPath $OutFile -Value $md -Encoding UTF8
    Write-Host "âœ… Markdown saved: $OutFile" -ForegroundColor Green

    if ($OutJson) {
        New-ParentDirIfNeeded -Path $OutJson
        ($jsonObj | ConvertTo-Json -Depth 6) | Set-Content -LiteralPath $OutJson -Encoding UTF8
        Write-Host "âœ… JSON saved: $OutJson" -ForegroundColor Green
    }

    # í´ë¦½ë³´ë“œ
    if (-not $NoCopy) {
        try {
            if (Get-Command Set-Clipboard -ErrorAction SilentlyContinue) {
                $md | Set-Clipboard
            } else {
                $p = [System.Diagnostics.Process]::Start('cmd.exe','/c clip')
                $p.StandardInput.Write($md)
                $p.StandardInput.Close()
            }
            Write-Host "ğŸ“‹ Copied to clipboard" -ForegroundColor Yellow
        } catch {
            Write-Warning "Failed to copy to clipboard: $($_.Exception.Message)"
        }
    }

    if ($OpenChatGPT) {
        try { Start-Process 'https://chat.openai.com' | Out-Null } catch {}
    }

    Write-Host "Done." -ForegroundColor Cyan
    exit 0
} catch {
    Write-Error "send_to_chatgpt_lua.ps1 failed: $($_.Exception.Message)"
    exit 1
}
        Write-Host "ğŸ“„ Markdown íŒŒì¼: $outputPath" -ForegroundColor Cyan
    }
    
    if ($OutputJson -and (Test-Path $jsonOutputPath)) {
        Write-Host "ğŸ“Š JSON íŒŒì¼: $jsonOutputPath" -ForegroundColor Cyan
    }
    
    exit 0
} catch {
    Write-Host "`nâŒ ì˜¤ë¥˜ ë°œìƒ: $_" -ForegroundColor Red
    Write-Host "ìŠ¤íƒ ì¶”ì : $($_.ScriptStackTrace)" -ForegroundColor Yellow
    exit 1
}
$ErrorActionPreference = 'Stop'

function Ensure-ParentDirectory {
    param([string]$Path)
    $dir = Split-Path -Parent $Path
    if (![string]::IsNullOrWhiteSpace($dir) -and !(Test-Path -LiteralPath $dir)) {
        New-Item -ItemType Directory -Path $dir -Force | Out-Null
    }
}

function Truncate-Text {
    param(
        [string]$Text,
        [int]$MaxChars = 4000
    )
    if ([string]::IsNullOrEmpty($Text)) { return $Text }
    if ($Text.Length -le $MaxChars) { return $Text }
    return ($Text.Substring(0, $MaxChars) + "\n\nâ€¦(truncated)â€¦")
}

function Read-FileSafe {
    param([string]$Path)
    if (Test-Path -LiteralPath $Path) {
        return Get-Content -LiteralPath $Path -Raw -ErrorAction Stop
    }
    return $null
}

function Read-JsonSafe {
    param([string]$Path)
    $raw = Read-FileSafe -Path $Path
    if ($null -ne $raw -and -not [string]::IsNullOrWhiteSpace($raw)) {
        try { return $raw | ConvertFrom-Json -ErrorAction Stop } catch { return $null }
    }
    return $null
}

function Get-SessionSummarySection {
    param([int]$MaxChars = 4000)
    $ws = (Resolve-Path (Join-Path $PSScriptRoot '..')).Path
    $copilot = Join-Path $ws 'outputs/.copilot_context_summary.md'
    $session = Join-Path $ws 'outputs/session_continuity_latest.md'
    $content = Read-FileSafe $copilot
    if (-not $content) { $content = Read-FileSafe $session }
    if (-not $content) { return $null }
    $content = Truncate-Text -Text $content -MaxChars $MaxChars
    return @(
        '## ì»¨í…ìŠ¤íŠ¸ ê°œìš”',
        '',
        $content
    ) -join "`n"
}

function Get-GoalsSection {
    param([int]$MaxItems = 5)
    $ws = (Resolve-Path (Join-Path $PSScriptRoot '..')).Path
    $trackerPath = Join-Path $ws 'fdo_agi_repo/memory/goal_tracker.json'
    $tracker = Read-JsonSafe $trackerPath
    if ($null -eq $tracker) { return $null }

    $active = @()
    $completed = @()
    $failed = @()
    if ($tracker.active) { $active = @($tracker.active) }
    if ($tracker.completed) { $completed = @($tracker.completed) }
    if ($tracker.failed) { $failed = @($tracker.failed) }

    $lines = @('## ëª©í‘œ í˜„í™©', '')
    $lines += "- í™œì„±: $($active.Count) | ì™„ë£Œ: $($completed.Count) | ì‹¤íŒ¨: $($failed.Count)"

    if ($active.Count -gt 0) {
        $lines += ''
        $lines += 'ìµœê·¼ í™œì„± ëª©í‘œ:'
        $active | Select-Object -First $MaxItems | ForEach-Object {
            $title = $_.title
            if (-not $title) { $title = $_.name }
            $status = $_.status
            $lines += "- [ACTIVE] $title" + ($(if ($status) { " ($status)" } else { '' }))
        }
    }
    if ($completed.Count -gt 0) {
        $lines += ''
        $lines += 'ìµœê·¼ ì™„ë£Œ ëª©í‘œ:'
        $completed | Select-Object -Last ([Math]::Min($MaxItems, $completed.Count)) | ForEach-Object {
            $title = $_.title
            if (-not $title) { $title = $_.name }
            $lines += "- [DONE] $title"
        }
    }
    if ($failed.Count -gt 0) {
        $lines += ''
        $lines += 'ìµœê·¼ ì‹¤íŒ¨ ëª©í‘œ:'
        $failed | Select-Object -Last ([Math]::Min($MaxItems, $failed.Count)) | ForEach-Object {
            $title = $_.title
            if (-not $title) { $title = $_.name }
            $lines += "- [FAIL] $title"
        }
    }
    return ($lines -join "`n")
}

function Get-QuickStatusSection {
    $ws = (Resolve-Path (Join-Path $PSScriptRoot '..')).Path
    $statusPath = Join-Path $ws 'outputs/quick_status_latest.json'
    $s = Read-JsonSafe $statusPath
    if ($null -eq $s) { return $null }
    $health = $s.health
    $cpu = $s.system.cpu_percent
    $mem = $s.system.available_memory_mb
    $queue = $s.queue.status
    $lines = @('## ì‹œìŠ¤í…œ ìƒíƒœ', '')
    if ($health) { $lines += "- ìƒíƒœ: $health" }
    if ($cpu -ne $null) { $lines += "- CPU: $cpu%" }
    if ($mem -ne $null) { $lines += "- ê°€ìš© ë©”ëª¨ë¦¬: ${mem}MB" }
    if ($queue) { $lines += "- í: $queue" }
    return ($lines -join "`n")
}

function Get-NextActionsSection {
    param([string]$Health)
    $lines = @('## ì¶”ì²œ ë‹¤ìŒ í–‰ë™', '')
    if ($Health -and $Health -match 'degraded|alert|fail|error') {
        $lines += '- ìƒíƒœê°€ ì €í•˜ë¨: ëŒ€ì‹œë³´ë“œ ìµœì‹ í™” ë° ì›Œì»¤/í ì ê²€'
        $lines += "- VS Code ì‘ì—…: 'Monitoring: Unified Dashboard (AGI + Lumen)' ì‹¤í–‰"
        $lines += "- í•„ìš” ì‹œ 'Queue: Ensure Worker' ì¬ê°€ë™"
    }
    else {
        $lines += '- ì§„í–‰ ì¤‘ì¸ ëª©í‘œì—ì„œ 1~2ê°œë¥¼ ì„ íƒí•´ ì¦‰ì‹œ ì‹¤í–‰'
        $lines += "- VS Code ì‘ì—…: 'ğŸ¯ Goal: Execute + Open Tracker'"
        $lines += "- 24h ë¦¬í¬íŠ¸ ê°±ì‹ : 'Monitoring: Generate Report (24h) + Open'"
    }
    return ($lines -join "`n")
}

function Compose-Handoff {
    param([string]$Mode)
    $now = Get-Date
    $header = @(
        "# ChatGPT Lua Handoff",
        "- ìƒì„± ì‹œê°: $($now.ToString('yyyy-MM-dd HH:mm:ss'))",
        "- ì¡°íšŒ ìœˆë„ìš°: ${Hours}h",
        "- ëª¨ë“œ: $Mode",
        '',
        'ë‹¹ì‹ ì€ Lua í†µí•© ë³´ì¡°ìì…ë‹ˆë‹¤. ì•„ë˜ ì»¨í…ìŠ¤íŠ¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‹¤ìŒ ì‘ì—…ì„ ì œì•ˆ/ì‹¤í–‰ ê³„íšìœ¼ë¡œ ë°˜í™˜í•˜ì„¸ìš”.',
        ''
    ) -join "`n"

    $sections = @()
    $sections += (Get-SessionSummarySection -MaxChars ($(if ($Mode -eq 'concise') { 3500 } else { 9000 })))
    $sections += ''
    $sections += (Get-GoalsSection -MaxItems ($(if ($Mode -eq 'concise') { 5 } else { 10 })))
    $sections += ''
    $qs = (Get-QuickStatusSection)
    if ($qs) { $sections += $qs; $sections += '' }

    # ê±´ê°•ë„ ì¶”ì¶œ(ì¶”ì²œ ë‹¤ìŒ í–‰ë™ ì¡°ê±´ìš©)
    $ws = (Resolve-Path (Join-Path $PSScriptRoot '..')).Path
    $statusPath = Join-Path $ws 'outputs/quick_status_latest.json'
    $s = Read-JsonSafe $statusPath
    $health = if ($s -and $s.health) { [string]$s.health } else { $null }
    $sections += (Get-NextActionsSection -Health $health)

    return ($header + "`n" + ($sections -join "`n")).Trim()
}

try {
    Ensure-ParentDirectory -Path $OutFile
    $content = Compose-Handoff -Mode $Format
    if (-not $content) { throw "ìš”ì•½ ìƒì„± ì‹¤íŒ¨: ë¹ˆ ì½˜í…ì¸ " }
    Set-Content -LiteralPath $OutFile -Value $content -Encoding UTF8 -Force

    if (-not $NoCopy) {
        $copied = $false
        try { Set-Clipboard -Value $content -ErrorAction Stop; $copied = $true } catch {}
        if (-not $copied) {
            try {
                $p = Start-Process -FilePath 'cmd.exe' -ArgumentList '/c clip.exe' -NoNewWindow -PassThru -RedirectStandardInput 'Pipe'
                $sw = New-Object System.IO.StreamWriter($p.StandardInput.BaseStream, [System.Text.Encoding]::Unicode)
                $sw.Write($content); $sw.Close(); $copied = $true
            }
            catch {}
        }
        if (-not $copied) {
            try {
                Add-Type -AssemblyName PresentationCore -ErrorAction SilentlyContinue
                $tb = New-Object System.Windows.Clipboard
                [System.Windows.Clipboard]::SetText($content)
                $copied = $true
            }
            catch {}
        }
        if ($copied) {
            Write-Host "âœ… í´ë¦½ë³´ë“œ ë³µì‚¬ ì™„ë£Œ" -ForegroundColor Green
        }
        else {
            Write-Host "âš ï¸ í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨ (íŒŒì¼ì€ ì €ì¥ë¨): $OutFile" -ForegroundColor Yellow
        }
    }
    else {
        Write-Host "â„¹ï¸ NoCopy ì˜µì…˜ìœ¼ë¡œ í´ë¦½ë³´ë“œ ë³µì‚¬ë¥¼ ê±´ë„ˆëœ€" -ForegroundColor Yellow
    }

    Write-Host "ğŸ“ ì¶œë ¥: $OutFile" -ForegroundColor Cyan
    Write-Host "--- ë¯¸ë¦¬ë³´ê¸°(ìƒìœ„ 20ì¤„) ---" -ForegroundColor DarkGray
    ($content -split "`n") | Select-Object -First 20 | ForEach-Object { Write-Host $_ }

    if ($OpenChatGPT) {
        try { Start-Process 'https://chat.openai.com' | Out-Null } catch {}
    }

}

try {
    $agi = Get-AGISnapshot
    $lumen = Get-LumenSnapshot
    $queue = Get-QueueSnapshot
    $goals = Get-GoalsSnapshot
    $rhythm = Get-RhythmSnapshot
    $critical = Get-CriticalInsights
    $recommendations = Get-ActionRecommendations

    # ì»¨í…ìŠ¤íŠ¸ ìƒì„±
    $context = New-ChatGPTContext -AGI $agi -Lumen $lumen -Queue $queue -Goals $goals -Rhythm $rhythm -Critical $critical -Recommendations $recommendations

    # í´ë¦½ë³´ë“œ ë³µì‚¬
    $context.Markdown | Set-Clipboard
    Write-Host "`nâœ… Context copied to clipboard!" -ForegroundColor Green
    Write-Host "ğŸ“‹ Paste in ChatGPT and add your request." -ForegroundColor Yellow

    # íŒŒì¼ ì €ì¥ (ì˜µì…˜)
    if ($SaveFile) {
        $outPath = Join-Path $PSScriptRoot "..\outputs\chatgpt_handoff_latest.md"
        $context.Markdown | Out-File -FilePath $outPath -Encoding utf8 -Force
        Write-Host "ğŸ’¾ Saved to: $outPath" -ForegroundColor Cyan
    }

    # JSON ì €ì¥ (ì˜µì…˜)
    if ($OutJson) {
        $context.JSON | Out-File -FilePath $OutJson -Encoding utf8 -Force
        Write-Host "ğŸ’¾ JSON saved to: $OutJson" -ForegroundColor Cyan
    }

    exit 0
}
catch {
    Write-Host "`nâŒ Error generating context:" -ForegroundColor Red
    Write-Host $_.Exception.Message -ForegroundColor Red
    Write-Host $_.ScriptStackTrace -ForegroundColor DarkGray
    exit 1
        # ê°„ë‹¨í•œ Score ì¶”ì¶œ
        $score = ($joined | Select-String -Pattern '(?i)score\s*[:=]\s*(\d+(\.\d+)?)' | Select-Object -First 1).Matches.Groups[1].Value
        $phase = ($joined | Select-String -Pattern '(?i)phase\s*[:=]\s*(\w+)' | Select-Object -First 1).Matches.Groups[1].Value
        [PSCustomObject]@{
            File  = $file
            Score = if ($score) { [double]$score } else { $null }
            Phase = if ($phase) { $phase } else { $null }
            Raw   = $joined
        }
        if (Test-Path $trackerFile) {
            else {
                [PSCustomObject]@{ File = $null; Score = $null; Phase = $null; Raw = $null }
            }
            $tracker = Get-Content $trackerFile -Raw | ConvertFrom-Json

            function Get-GoalTracker {
                $goalFile = Join-Path $WorkspaceRoot 'fdo_agi_repo/memory/goal_tracker.json'
                if (!(Test-Path $goalFile)) { return $null }
                try {
                    $json = Get-Content -LiteralPath $goalFile -Raw | ConvertFrom-Json
                    $active = @($json.goals | Where-Object { $_.status -eq 'in_progress' })
                    $completed = @($json.goals | Where-Object { $_.status -eq 'completed' })
                    $failed = @($json.goals | Where-Object { $_.status -eq 'failed' })
                    [PSCustomObject]@{
                        CountActive    = $active.Count
                        CountCompleted = $completed.Count
                        CountFailed    = $failed.Count
                        ActiveTitles   = $active.title
                        Raw            = $json
                    }
                }
                catch {
                    Write-Log "Goal tracker íŒŒì‹± ì‹¤íŒ¨: $($_.Exception.Message)" 'Yellow'
                    return $null
                }
            }

            function Get-RhythmState {
                $rhythmFiles = @(
                    'outputs/RHYTHM_SYSTEM_STATUS_REPORT.md',
                    'outputs/RHYTHM_REST_PHASE_*.md'
                )
                $resolved = foreach ($pattern in $rhythmFiles) { Get-ChildItem -Path (Join-Path $WorkspaceRoot $pattern) -ErrorAction SilentlyContinue }
                $file = $resolved | Sort-Object LastWriteTime -Descending | Select-Object -First 1
                if ($file) {
                    $raw = Get-Content -LiteralPath $file.FullName
                    $joined = $raw -join "`n"
                    $health = ($joined | Select-String -Pattern '(?i)(health|score)\s*[:=]\s*(\d+(\.\d+)?)' | Select-Object -First 1).Matches.Groups[2].Value
                    $phase = ($joined | Select-String -Pattern '(?i)(rest|focus|flow)\s*phase' | Select-Object -First 1).Matches.Groups[0].Value
                    [PSCustomObject]@{
                        File      = $file.FullName
                        Health    = if ($health) { [double]$health } else { $null }
                        PhaseDesc = $phase
                        Raw       = $joined
                    }
                }
                else { $null }
            }

            function Get-SystemHealth {
                $qs = Join-Path $WorkspaceRoot 'outputs/quick_status_latest.json'
                if (!(Test-Path $qs)) { return $null }
                try {
                    $json = Get-Content -LiteralPath $qs -Raw | ConvertFrom-Json
                    $status = if ($json.health_overall) { $json.health_overall } elseif ($json.overall) { $json.overall } else { 'unknown' }
                    [PSCustomObject]@{ Status = $status; Raw = $json }
                }
                catch {
                    Write-Log "System health íŒŒì‹± ì‹¤íŒ¨: $($_.Exception.Message)" 'Yellow'
                    $null
                }
            }

            function Set-ClipboardSafe($text) {
                try { Set-Clipboard -Value $text; return }
                catch { Write-Log 'Set-Clipboard ì‹¤íŒ¨, clip.exe í´ë°± ì‹œë„' 'Yellow' }
                $clip = Get-Command clip.exe -ErrorAction SilentlyContinue
                if ($clip) { $text | clip.exe; return }
                try {
                    Add-Type -AssemblyName PresentationCore -ErrorAction Stop
                    [System.Windows.Clipboard]::SetText($text)
                }
                catch {
                    Write-Log 'PresentationCore í´ë°± ì‹¤íŒ¨: í´ë¦½ë³´ë“œ ë³µì‚¬ ë¶ˆê°€' 'Red'
                }
            }

            function Build-NextActions($trinity, $goals, $rhythm, $sys) {
                $actions = [System.Collections.Generic.List[string]]::new()
                if (-not $trinity.Raw) { $actions.Add('Trinity ë¦¬í¬íŠ¸ ìƒì„±: Autopoietic 24h ë¦¬í¬íŠ¸ ì‹¤í–‰') }
                elseif ($trinity.Score -lt 70) { $actions.Add("Trinity ê°œì„ : ë‚®ì€ Score ($($trinity.Score)) ì›ì¸ ë¶„ì„") }
                if ($goals) {
                    if ($goals.CountFailed -gt 0) { $actions.Add("ì‹¤íŒ¨ ëª©í‘œ ì¬í‰ê°€ ($($goals.CountFailed)) â†’ ì¬ë“±ë¡ ë˜ëŠ” íê¸°") }
                    if ($goals.CountActive -eq 0) { $actions.Add('í™œì„± ëª©í‘œ ì—†ìŒ â†’ ìƒˆ ëª©í‘œ ìƒì„± (Goal Generator)') }
                }
                else { $actions.Add('Goal Tracker ì—†ìŒ â†’ autonomous_goal_executor ì‹¤í–‰ ê²€í† ') }
                if ($IncludeRhythm) {
                    if (-not $rhythm) { $actions.Add('Rhythm ìƒíƒœ ì—†ìŒ â†’ Rhythm ì‹œìŠ¤í…œ ì ê²€') }
                    elseif ($rhythm.Health -and $rhythm.Health -lt 80) { $actions.Add("ë¦¬ë“¬ íšŒë³µ: íœ´ì‹/ì €ê°•ë„ í˜ì´ì¦ˆ ìœ ì§€ (Health=$($rhythm.Health))") }
                }
                if ($sys -and ($sys.Status -notmatch 'healthy|excellent')) { $actions.Add("ì‹œìŠ¤í…œ ë³µêµ¬: quick_status.ps1 / watchdog í™•ì¸ (ìƒíƒœ=$($sys.Status))") }
                if ($actions.Count -eq 0) { $actions.Add('ëª¨ë“  í•µì‹¬ ì§€í‘œ ì–‘í˜¸ â†’ í˜„ì¬ íë¦„ ìœ ì§€') }
                return $actions
            }

            function Build-MarkdownSummary($Format, $Hours, $trinity, $goals, $rhythm, $sys) {
                $ts = (Get-Date).ToString('yyyy-MM-dd HH:mm:ss')
                $actions = Build-NextActions $trinity $goals $rhythm $sys
                $header = @(
                    '# Lua Handoff Summary',
                    "**Generated**: $ts", "**Window**: Last $Hours h", ''
                )

                $triSection = if ($trinity.Raw) {
                    $scoreStr = if ($trinity.Score) { "Score: $($trinity.Score)" } else { 'Score: N/A' }
                    $phaseStr = if ($trinity.Phase) { "Phase: $($trinity.Phase)" } else { 'Phase: N/A' }
                    "## Trinity
                    $total = $tracker.goals.Count
                    $inProgress = ($tracker.goals | Where-Object { $_.status -eq "in_progress" }).Count
                }
                else {
                    '## Trinity
        $completed = ($tracker.goals | Where-Object { $_.status -eq "completed" }).Count

    $goalSection = if ($goals -and $IncludeGoals) {
        $active = if ($goals.CountActive -gt 0) { ($goals.ActiveTitles | ForEach-Object { "- $_" }) -join "`n" } else { '- (none)' }
        @(
            '## Goals',
                    "Active: $($goals.CountActive) | Completed: $($goals.CountCompleted) | Failed: $($goals.CountFailed)",
                    'Active Titles:', $active
                ) -join "`n"
            }
            elseif ($IncludeGoals) { '## Goals
        $failed = ($tracker.goals | Where-Object { $_.status -eq "failed" }).Count

    $rhythmSection = if ($IncludeRhythm) {
        if ($rhythm) {
            $h = if ($rhythm.Health) { $rhythm.Health } else { 'N/A' }
            "## Rhythm
        
                    return @{
                    }
                    else { '## Rhythm
                Total      = $total
            } else { '' }

            $sysSection = if ($sys) {
                "## System Health
            InProgress = $inProgress
    } else { '## System Health
                        Completed  = $completed

                        $actionsSection = @('## Next Actions', ($actions | ForEach-Object { "- $_" }) -join "`n") -join "`n"

                        if ($Format -eq 'concise') {
                            return (@($header -join "`n", $triSection, $goalSection, $rhythmSection, $sysSection, $actionsSection) -join "`n`n").Trim()
                        }

                        # detailed ì¶”ê°€ ì •ë³´
                        $detailExtras = @()
                        if ($trinity.Raw) { $detailExtras += '### Trinity Raw (first 20 lines)'; $detailExtras += (($trinity.Raw -split "`n") | Select-Object -First 20) }
                        if ($goals) { $detailExtras += '### Goal JSON (trimmed keys)'; $detailExtras += ($goals.Raw.goals | Select-Object -First 5 | ConvertTo-Json -Depth 5) }
                        if ($rhythm) { $detailExtras += '### Rhythm Raw (first 15 lines)'; $detailExtras += (($rhythm.Raw -split "`n") | Select-Object -First 15) }
                        if ($sys) { $detailExtras += '### System Health Raw'; $detailExtras += ($sys.Raw | ConvertTo-Json -Depth 6) }
                        $detailSection = $detailExtras -join "`n"
                        return (@($header -join "`n", $triSection, $goalSection, $rhythmSection, $sysSection, $actionsSection, $detailSection) -join "`n`n").Trim()
                    }

                    try {
                        Write-Log 'ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘'
                        $trinity = Get-LatestTrinityResults
                        $goals = Get-GoalTracker
                        $rhythm = if ($IncludeRhythm) { Get-RhythmState } else { $null }
                        $sys = Get-SystemHealth
                        Write-Log 'ìš”ì•½ ìƒì„±'
                        $summary = Build-MarkdownSummary $Format $Hours $trinity $goals $rhythm $sys

                        $outDir = Join-Path $WorkspaceRoot 'outputs'
                        if (!(Test-Path $outDir)) { New-Item -ItemType Directory -Path $outDir -Force | Out-Null }
                        $baseName = if ($Format -eq 'concise') { 'chatgpt_lua_summary.md' } else { 'chatgpt_lua_summary_detailed.md' }
                        $outFile = Join-Path $outDir $baseName
                        $summary | Out-File -LiteralPath $outFile -Encoding UTF8 -Force
                        Write-Log "ìš”ì•½ ì €ì¥: $(Split-Path $outFile -Leaf)" 'Green'

                        Set-ClipboardSafe $summary
                        Write-Log 'í´ë¦½ë³´ë“œ ë³µì‚¬ ì™„ë£Œ' 'Green'

                        if ($OpenChatGPT) {
                            Write-Log 'ChatGPT ë¸Œë¼ìš°ì € íƒ­ ì˜¤í”ˆ ì‹œë„'
                            try { Start-Process 'https://chat.openai.com/' } catch { Write-Log 'ë¸Œë¼ìš°ì € ì˜¤í”ˆ ì‹¤íŒ¨' 'Yellow' }
                        }

                        Write-Log '--- SUMMARY (preview first 25 lines) ---' 'Gray'
                        ($summary -split "`n" | Select-Object -First 25) | ForEach-Object { Write-Host $_ }
                        Write-Log 'Lua ë¶™ì—¬ë„£ê¸° ì¤€ë¹„ ì™„ë£Œ (Ctrl+V)' 'Green'
                    }
                    catch {
                        Write-Log "ì˜¤ë¥˜ ë°œìƒ: $($_.Exception.Message)" 'Red'
                        exit 1
                    }

                    exit 0
                    Failed     = $failed
                    Available  = $true
                }
            }
            return @{ Available = $false }
        }

        function Get-RhythmState {
            $rhythmFiles = Get-ChildItem (Join-Path $WorkspaceRoot "outputs") -Filter "RHYTHM_*.md" -ErrorAction SilentlyContinue | 
            Sort-Object LastWriteTime -Descending | Select-Object -First 1
    
            if ($rhythmFiles) {
                $content = Get-Content $rhythmFiles.FullName -Raw
                if ($content -match 'ê±´ê°•ë„.*?(\d+\.?\d*)%') {
                    $health = $matches[1]
                    if ($content -match '(íœ´ì‹|ì§‘ì¤‘|í™œë™) í˜ì´ì¦ˆ') {
                        $phase = $matches[1]
                        return @{
                            Health    = $health
                            Phase     = $phase
                            Available = $true
                        }
                    }
                }
            }
            return @{ Available = $false }
        }

        function Get-SystemHealth {
            $statusFile = Join-Path $WorkspaceRoot "outputs/quick_status_latest.json"
            if (Test-Path $statusFile) {
                $status = Get-Content $statusFile -Raw | ConvertFrom-Json
                return @{
                    Status    = $status.overall_status
                    Timestamp = $status.timestamp
                    Available = $true
                }
            }
            return @{ Available = $false }
        }

        function Build-ConciseSummary {
            param($Trinity, $Goals, $Rhythm, $Health)
    
            $lines = @()
            $lines += "ğŸ­ Trinity â†’ Lua (ChatGPT) ì „ë‹¬ ìš”ì•½"
            $lines += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            $lines += ""
    
            # Trinity Status
            if ($Trinity.Available) {
                $lines += "ğŸ”„ **Trinity Cycle** (ìµœê·¼ ${Hours}h)"
                $lines += "   ì¢…í•© ì ìˆ˜: $($Trinity.Score)%"
                $lines += ""
            }
    
            # Goal Status
            if ($Goals.Available -and $IncludeGoals) {
                if (-not ($Goals.Available -and $Goals.InProgress -gt 0) -and -not ($Rhythm.Available) -and -not ($Trinity.Available)) {
                    $lines += "   1. ìµœì‹  ì»¨í…ìŠ¤íŠ¸ ìë£Œ ìƒì„± ìœ ë„ (ë³´ê³ ì„œ/ìš”ì•½ ê°±ì‹ )"
                }

                return ($lines -join "`r`n")
                $lines += "ğŸ¯ **Autonomous Goals**"

                function Build-DetailedSummary {
                    param($Trinity, $Goals, $Rhythm, $Health)

                    $lines = @()
                    $lines += "# Trinity â†’ Lua (ChatGPT) ìƒì„¸ ì „ë‹¬"
                    $lines += ""
                    $lines += "## Trinity"
                    if ($Trinity.Available) {
                        $lines += "- ì¢…í•© ì ìˆ˜: $($Trinity.Score)%"
                        $lines += "- ì›ë³¸: outputs/autopoietic_trinity_report_latest.md"
                    }
                    else {
                        $lines += "- ìµœê·¼ Trinity ë¦¬í¬íŠ¸ ì—†ìŒ"
                    }
                    $lines += ""
                    $lines += "## Goals"
                    if ($Goals.Available -and $IncludeGoals) {
                        $lines += "- ì§„í–‰ ì¤‘: $($Goals.InProgress)"
                        $lines += "- ì™„ë£Œ: $($Goals.Completed)"
                        $lines += "- ì‹¤íŒ¨: $($Goals.Failed)"
                    }
                    else {
                        $lines += "- Goal Tracker ì—†ìŒ ë˜ëŠ” ì œì™¸ë¨"
                    }
                    $lines += ""
                    $lines += "## Rhythm"
                    if ($Rhythm.Available -and $IncludeRhythm) {
                        $lines += "- í˜ì´ì¦ˆ: $($Rhythm.Phase)"
                        $lines += "- ê±´ê°•ë„: $($Rhythm.Health)%"
                    }
                    else {
                        $lines += "- Rhythm ìƒíƒœ ì—†ìŒ ë˜ëŠ” ì œì™¸ë¨"
                    }
                    $lines += ""
                    $lines += "## System Health"
                    if ($Health.Available) {
                        $lines += "- ìƒíƒœ: $($Health.Status)"
                        $lines += "- ë§ˆì§€ë§‰ ì²´í¬: $($Health.Timestamp)"
                    }
                    else {
                        $lines += "- quick_status_latest.json ì—†ìŒ"
                    }
                    $lines += ""
                    $lines += "## ì œì•ˆ"
                    if ($Goals.Available -and $Goals.InProgress -gt 0) { $lines += "- ì§„í–‰ ì¤‘ ëª©í‘œ ì ê²€ ë° ë‹¤ìŒ ë‹¨ê³„ êµ¬ì²´í™”" }
                    if ($Rhythm.Available -and [double]$Rhythm.Health -lt 70) { $lines += "- 10~15ë¶„ íœ´ì‹ ë˜ëŠ” ê²½ì¾Œ BPM ìŒì•… ì¬ìƒ" }
                    if ($Trinity.Available -and [double]$Trinity.Score -lt 80) { $lines += "- ë³‘ëª© ì›ì¸(Queue/Worker/LLM) ëª¨ë‹ˆí„°ë§ í›„ íŠœë‹" }

                    return ($lines -join "`r`n")
                }

                # ------------------- Main -------------------
                try {
                    $trinity = Get-LatestTrinityResults
                    $goals = Get-AutonomousGoalStatus
                    $rhythm = Get-RhythmState
                    $health = Get-SystemHealth

                    $summary = if ($Format -eq 'detailed') {
                        Build-DetailedSummary -Trinity $trinity -Goals $goals -Rhythm $rhythm -Health $health
                    }
                    else {
                        Build-ConciseSummary -Trinity $trinity -Goals $goals -Rhythm $rhythm -Health $health
                    }

                    if (-not $summary) {
                        $summary = "(ë¹ˆ ìš”ì•½) ìµœê·¼ ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë³´ê³ ì„œ ìƒì„± í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."
                    }

                    $outDir = Join-Path $WorkspaceRoot 'outputs'
                    if (-not (Test-Path $outDir)) { New-Item -ItemType Directory -Path $outDir | Out-Null }
                    $outPath = Join-Path $outDir 'chatgpt_lua_handoff_latest.md'
                    $summary | Set-Content -Encoding UTF8 -LiteralPath $outPath

                    # Copy to clipboard (single-shot, no loops)
                    $summary | Set-Clipboard

                    Write-Host "âœ… Lua í•¸ë“œì˜¤í”„ ìš”ì•½ì„ í´ë¦½ë³´ë“œë¡œ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤." -ForegroundColor Green
                    Write-Host "   íŒŒì¼: $outPath" -ForegroundColor DarkGray

                    if ($OpenChatGPT) {
                        Start-Process 'https://chat.openai.com/' | Out-Null
                        Write-Host "ğŸŒ ChatGPTë¥¼ ì—´ì—ˆìŠµë‹ˆë‹¤." -ForegroundColor Cyan
                    }
                }
                catch {
                    Write-Host "âŒ ì˜¤ë¥˜: $($_.Exception.Message)" -ForegroundColor Red
                    exit 1
                }
                $lines += "   ì§„í–‰ ì¤‘: $($Goals.InProgress) | ì™„ë£Œ: $($Goals.Completed) | ì‹¤íŒ¨: $($Goals.Failed)"
                if ($Goals.InProgress -gt 0) {
                    $lines += "   âš ï¸ ì§„í–‰ ì¤‘ì¸ ëª©í‘œ ìˆìŒ - ì§€ì†ì  ê´€ì°° í•„ìš”"
                }
                $lines += ""
            }
    
            # Rhythm State
            if ($Rhythm.Available -and $IncludeRhythm) {
                $lines += "ğŸŒŠ **Rhythm State**"
                $lines += "   í˜ì´ì¦ˆ: $($Rhythm.Phase) | ê±´ê°•ë„: $($Rhythm.Health)%"
                $lines += ""
            }
    
            # System Health
            if ($Health.Available) {
                $lines += "ğŸ¥ **System Health**"
                $lines += "   ìƒíƒœ: $($Health.Status)"
                $lines += "   ë§ˆì§€ë§‰ ì²´í¬: $($Health.Timestamp)"
                $lines += ""
            }
    
            # Recommendations
            $lines += "ğŸ’¡ **Luaì—ê²Œ ì œì•ˆ**"
            if ($Goals.Available -and $Goals.InProgress -gt 0) {
                $lines += "   1. ì§„í–‰ ì¤‘ì¸ ëª©í‘œ ê²€í†  ë° í”¼ë“œë°±"
            }
            if ($Rhythm.Available -and [double]$Rhythm.Health -lt 70) {
                $lines += "   2. ë¦¬ë“¬ íšŒë³µì„ ìœ„í•œ íœ´ì‹ ê¶Œì¥"
            }
            if ($Trinity.Available -and [double]$Trinity.Score -lt 80) {
                $lines += "   3. Trinity ìµœì í™” í•„ìš” (í˜„ì¬ $($Trinity.Score)%)"
            }
            $lines += "   4. ëŒ€í™”ë¥¼ í†µí•œ í†µì°° ê³µìœ "
            $lines += ""
    
            $lines += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            $lines += "ğŸ“‹ ì´ ìš”ì•½ì„ ChatGPTì— ë¶™ì—¬ë„£ì–´ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”!"
    
            return $lines -join "`n"
        }

        function Build-DetailedSummary {
            param($Trinity, $Goals, $Rhythm, $Health)
    
            $lines = @()
            $lines += "# ğŸ­ Trinity â†’ Lua (ChatGPT) ìƒì„¸ ë³´ê³ ì„œ"
            $lines += ""
            $lines += "**ìƒì„± ì‹œê°**: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
            $lines += "**ë¶„ì„ ê¸°ê°„**: ìµœê·¼ ${Hours}ì‹œê°„"
            $lines += ""
    
            # Trinity Cycle
            if ($Trinity.Available) {
                $lines += "## ğŸ”„ Trinity Cycle (ìê¸° ìƒì„±ì  ìˆœí™˜)"
                $lines += ""
                $lines += "- **ì¢…í•© ì ìˆ˜**: $($Trinity.Score)%"
                $lines += "- **ìƒíƒœ**: " + $(if ([double]$Trinity.Score -ge 90) { "EXCELLENT âœ¨" } 
                    elseif ([double]$Trinity.Score -ge 80) { "GOOD âœ…" }
                    elseif ([double]$Trinity.Score -ge 70) { "FAIR âš ï¸" }
                    else { "NEEDS ATTENTION ğŸ”§" })
                $lines += "- **íŒŒì¼**: $($Trinity.Path -replace [regex]::Escape($WorkspaceRoot), '.')"
                $lines += ""
            }
    
            # Autonomous Goals
            if ($Goals.Available -and $IncludeGoals) {
                $lines += "## ğŸ¯ Autonomous Goal System"
                $lines += ""
                $lines += "| ìƒíƒœ | ê°œìˆ˜ |"
                $lines += "|------|------|"
                $lines += "| ì§„í–‰ ì¤‘ | $($Goals.InProgress) |"
                $lines += "| ì™„ë£Œ | $($Goals.Completed) |"
                $lines += "| ì‹¤íŒ¨ | $($Goals.Failed) |"
                $lines += "| **ì´ê³„** | **$($Goals.Total)** |"
                $lines += ""
        
                if ($Goals.InProgress -gt 0) {
                    $lines += "### âš ï¸ ì£¼ì˜ í•„ìš”"
                    $lines += "- $($Goals.InProgress)ê°œì˜ ëª©í‘œê°€ í˜„ì¬ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤"
                    $lines += "- Luaì˜ ê´€ì°°ê³¼ í”¼ë“œë°±ì´ ë„ì›€ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤"
                    $lines += ""
                }
            }
    
            # Rhythm State
            if ($Rhythm.Available -and $IncludeRhythm) {
                $lines += "## ğŸŒŠ Rhythm State (ìƒì²´ ë¦¬ë“¬)"
                $lines += ""
                $lines += "- **í˜„ì¬ í˜ì´ì¦ˆ**: $($Rhythm.Phase)"
                $lines += "- **ê±´ê°•ë„**: $($Rhythm.Health)%"
                $lines += "- **ê¶Œì¥ í–‰ë™**: " + $(
                    if ($Rhythm.Phase -eq "íœ´ì‹") { "ëª…ìƒ, ì‚°ì±…, ê°€ë²¼ìš´ ì‘ì—…" }
                    elseif ($Rhythm.Phase -eq "ì§‘ì¤‘") { "ì¤‘ìš”í•œ ì‘ì—…, ê¹Šì€ ì‚¬ê³ " }
                    else { "ì¼ë°˜ ì‘ì—…, ìš´ë™" }
                )
                $lines += ""
            }
    
            # System Health
            if ($Health.Available) {
                $lines += "## ğŸ¥ System Health"
                $lines += ""
                $lines += "- **ì „ì²´ ìƒíƒœ**: $($Health.Status)"
                $lines += "- **ë§ˆì§€ë§‰ ì²´í¬**: $($Health.Timestamp)"
                $lines += ""
            }
    
            # Recommendations
            $lines += "## ğŸ’¡ Luaì—ê²Œ ì œì•ˆí•˜ëŠ” ëŒ€í™” ì£¼ì œ"
            $lines += ""
            $lines += "1. **ì§„í–‰ ì¤‘ì¸ ëª©í‘œì— ëŒ€í•œ í†µì°°**"
            $lines += "   - ëª©í‘œê°€ ì˜¬ë°”ë¥¸ ë°©í–¥ì¸ì§€"
            $lines += "   - ì ‘ê·¼ ë°©ì‹ ê°œì„ ì "
            $lines += ""
            $lines += "2. **ë¦¬ë“¬ ìµœì í™”**"
            if ($Rhythm.Available) {
                $lines += "   - í˜„ì¬ $($Rhythm.Phase) í˜ì´ì¦ˆì— ì í•©í•œ í™œë™"
                $lines += "   - ê±´ê°•ë„ $($Rhythm.Health)% ê°œì„  ë°©ì•ˆ"
            }
            $lines += ""
            $lines += "3. **Trinity ìˆœí™˜ ê°•í™”**"
            if ($Trinity.Available) {
                $lines += "   - í˜„ì¬ $($Trinity.Score)%ì—ì„œ ë” ë‚˜ì•„ê°€ê¸°"
            }
            $lines += "   - ìê¸° ìƒì„±ì  íŒ¨í„´ ë°œê²¬"
            $lines += ""
            $lines += "4. **ìƒˆë¡œìš´ ê°€ëŠ¥ì„± íƒìƒ‰**"
            $lines += "   - Luaì˜ ê´€ì ì—ì„œ ë³¸ ì‹œìŠ¤í…œ"
            $lines += "   - ì˜ˆìƒì¹˜ ëª»í•œ ì—°ê²°ê³ ë¦¬"
            $lines += ""
    
            $lines += "---"
            $lines += ""
            $lines += "ğŸ“‹ **ì‚¬ìš© ë°©ë²•**: ì´ ì „ì²´ í…ìŠ¤íŠ¸ë¥¼ ChatGPTì— ë¶™ì—¬ë„£ê³  ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”!"
    
            return $lines -join "`n"
        }

        # Main execution
        Write-Host "ğŸ­ Trinity â†’ Lua (ChatGPT) ë¸Œë¦¿ì§€ ì‹œì‘..." -ForegroundColor Cyan
        Write-Host ""

        try {
            # Gather data
            $trinityData = Get-LatestTrinityResults
            $goalsData = Get-AutonomousGoalStatus
            $rhythmData = Get-RhythmState
            $healthData = Get-SystemHealth

            # Validate: at least one data source available
            if (-not ($trinityData.Available -or $goalsData.Available -or $rhythmData.Available -or $healthData.Available)) {
                Write-Host "âš ï¸ ê²½ê³ : ëª¨ë“  ë°ì´í„° ì†ŒìŠ¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤." -ForegroundColor Yellow
                Write-Host "   ìµœì†Œí•œì˜ ê¸°ë³¸ ìš”ì•½ì„ ìƒì„±í•©ë‹ˆë‹¤..." -ForegroundColor Yellow
            }

            # Build summary
            Write-Host "ğŸ“Š ë°ì´í„° ìˆ˜ì§‘ ì¤‘..." -ForegroundColor Yellow
            if ($Format -eq "concise") {
                $summary = Build-ConciseSummary -Trinity $trinityData -Goals $goalsData -Rhythm $rhythmData -Health $healthData
            }
            else {
                $summary = Build-DetailedSummary -Trinity $trinityData -Goals $goalsData -Rhythm $rhythmData -Health $healthData
            }

            # Ensure we have something to output
            if ([string]::IsNullOrWhiteSpace($summary)) {
                $summary = @"
# ğŸ­ Trinity â†’ Lua (ChatGPT) ìš”ì•½

**ìƒì„± ì‹œê°**: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')

âš ï¸ **ë°ì´í„° ë¶€ì¡±**: í˜„ì¬ ì‚¬ìš© ê°€ëŠ¥í•œ ì‹œìŠ¤í…œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.

**ê¶Œì¥ ì¡°ì¹˜**:
1. Trinity Cycle ì‹¤í–‰: ``ğŸ”„ Trinity: Autopoietic Cycle (24h, open)``
2. Goal Generator ì‹¤í–‰: ``ğŸ¯ Goal: Generate + Open (24h)``
3. System Health ì²´í¬: ``ğŸ¥ System: Health Check (Quick)``

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ ì´ ë©”ì‹œì§€ë¥¼ ChatGPTì— ë¶™ì—¬ë„£ê³  ì‹œìŠ¤í…œ ë³µêµ¬ë¥¼ ë…¼ì˜í•˜ì„¸ìš”!
"@
            }

            # Copy to clipboard
            Write-Host "ğŸ“‹ í´ë¦½ë³´ë“œì— ë³µì‚¬ ì¤‘..." -ForegroundColor Yellow
            try {
                Set-Clipboard -Value $summary
                Write-Host "âœ… í´ë¦½ë³´ë“œ ë³µì‚¬ ì™„ë£Œ!" -ForegroundColor Green
            }
            catch {
                Write-Host "âš ï¸ í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨: $($_.Exception.Message)" -ForegroundColor Yellow
                Write-Host "   íŒŒì¼ë¡œ ì €ì¥ì€ ê³„ì†ë©ë‹ˆë‹¤..." -ForegroundColor Yellow
            }

            # Save to file (Markdown)
            $outFile = Join-Path $WorkspaceRoot "outputs/chatgpt_lua_summary_latest.md"
            Write-Host "âœ… íŒŒì¼ ì €ì¥ (MD): $outFile" -ForegroundColor Green

            # Save to file (JSON)
            $jsonData = @{
                timestamp = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
                hours     = $Hours
                format    = $Format
                trinity   = @{
                    available = $trinityData.Available
                    score     = if ($trinityData.Available) { $trinityData.Score } else { $null }
                    path      = if ($trinityData.Available) { $trinityData.Path } else { $null }
                }
                goals     = @{
                    available  = $goalsData.Available
                    total      = if ($goalsData.Available) { $goalsData.Total } else { 0 }
                    inProgress = if ($goalsData.Available) { $goalsData.InProgress } else { 0 }
                    completed  = if ($goalsData.Available) { $goalsData.Completed } else { 0 }
                    failed     = if ($goalsData.Available) { $goalsData.Failed } else { 0 }
                }
                rhythm    = @{
                    available = $rhythmData.Available
                    phase     = if ($rhythmData.Available) { $rhythmData.Phase } else { $null }
                    health    = if ($rhythmData.Available) { $rhythmData.Health } else { $null }
                }
                health    = @{
                    try {
                        Write-Host "Preparing ChatGPT handoff context..." -ForegroundColor Cyan

                        # í”„ë¡œì íŠ¸ ë£¨íŠ¸ í™•ì¸
                        $projectRoot = Resolve-Path "$PSScriptRoot\.."
                        if (-not (Test-Path "$projectRoot\outputs\session_continuity_latest.md")) {
                            Write-Warning "session_continuity_latest.md not found. Run session restore first."
                            $summaryMd = "# Session Continuity`n`nNo recent session snapshot found."
                        } else {
                            $summaryMd = Get-Content "$projectRoot\outputs\session_continuity_latest.md" -Raw -ErrorAction SilentlyContinue
                        }

                        # Goal Tracker ë°ì´í„°
                        $goalTrackerPath = "$projectRoot\fdo_agi_repo\memory\goal_tracker.json"
                        $goalData = Get-GoalTrackerSummary -JsonPath $goalTrackerPath

                        # Rhythm ìƒíƒœ
                        $rhythmData = Get-RhythmStatus -ProjectRoot $projectRoot

                        # ì‹œìŠ¤í…œ ìƒíƒœ
                        $systemData = Get-SystemStatus -ProjectRoot $projectRoot

                        # ì—ì´ì „íŠ¸ í•¸ë“œì˜¤í”„
                        $agentHandoffPath = "$projectRoot\docs\AGENT_HANDOFF.md"
                        $agentHandoff = if (Test-Path $agentHandoffPath) { Get-Content $agentHandoffPath -Raw } else { "" }

                        # Markdown í¬ë§· (Lua ì¹œí™”)
                        $mdReport = @"
        # ğŸ”— ChatGPT Handoff Context

        ## ğŸ“ Session Continuity Snapshot

        $summaryMd

        ## ğŸ¯ Autonomous Goal Tracker

        **Active Goals:** $($goalData.ActiveGoals)
        **Completed (Recent):** $($goalData.CompletedRecent)
        **Failed (Recent):** $($goalData.FailedRecent)
        **Next Action:** $($goalData.NextAction)

        ## ğŸŒŠ Rhythm Status

        **Current Phase:** $($rhythmData.Phase)
        **Health Score:** $($rhythmData.HealthScore)
        **Recent Trend:** $($rhythmData.Trend)

        ## âš™ï¸ System Status

        **Queue Server (8091):** $($systemData.QueueServer)
        **RPA Worker:** $($systemData.RpaWorker)
        **Watchdog:** $($systemData.Watchdog)
        **Monitoring:** $($systemData.Monitoring)

        ## ğŸ“ Agent Handoff

        $agentHandoff

        ---

        **Generated:** $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
        **Context Source:** session_continuity_latest.md, goal_tracker.json, RHYTHM_*.md, quick_status_latest.json
        **Recommended Action:** ì´ ì»¨í…ìŠ¤íŠ¸ë¥¼ ChatGPTì— ë¶™ì—¬ë„£ê³  "ë³µì›" ë˜ëŠ” "ì´ì–´ì„œ ì‘ì—…"ì„ ìš”ì²­í•˜ì„¸ìš”.
        "@

            # JSON ì¶œë ¥ (ì„ íƒì )
            if ($OutputJson) {
                $jsonReport = @{
                    timestamp = Get-Date -Format 'yyyy-MM-ddTHH:mm:ss'
                    session = @{
                        continuity_snapshot = ($summaryMd -split "`n" | Select-Object -First 10) -join " "
                    }
                    goals = @{
                        active = $goalData.ActiveGoals
                        completed_recent = $goalData.CompletedRecent
                        failed_recent = $goalData.FailedRecent
                        next_action = $goalData.NextAction
                    }
                    rhythm = @{
                        phase = $rhythmData.Phase
                        health_score = $rhythmData.HealthScore
                        trend = $rhythmData.Trend
                    }
                    system = @{
                        queue_server = $systemData.QueueServer
                        rpa_worker = $systemData.RpaWorker
                        watchdog = $systemData.Watchdog
                        monitoring = $systemData.Monitoring
                    }
                }
                $jsonOutputPath = "$projectRoot\outputs\chatgpt_handoff_latest.json"
                $jsonReport | ConvertTo-Json -Depth 10 | Out-File -FilePath $jsonOutputPath -Encoding UTF8 -Force
                Write-Host "âœ… JSON report saved: $jsonOutputPath" -ForegroundColor Green
            }

            # Markdown ì¶œë ¥
            $outputPath = "$projectRoot\outputs\chatgpt_handoff_latest.md"
            $mdReport | Out-File -FilePath $outputPath -Encoding UTF8 -Force
            Write-Host "âœ… Markdown report saved: $outputPath" -ForegroundColor Green

            # í´ë¦½ë³´ë“œ ë³µì‚¬
            $mdReport | Set-Clipboard
            Write-Host "ğŸ“‹ Context copied to clipboard!" -ForegroundColor Green
            Write-Host "" -ForegroundColor Cyan
            Write-Host "ğŸ‘‰ Now paste into ChatGPT with: 'Ctrl+V' â†’ 'Enter'" -ForegroundColor Yellow
            Write-Host "" -ForegroundColor Cyan

            # ìš”ì•½ ì¶œë ¥
            Write-Host "--- Summary ---" -ForegroundColor Magenta
            Write-Host "Active Goals: $($goalData.ActiveGoals)" -ForegroundColor White
            Write-Host "Rhythm Phase: $($rhythmData.Phase) ($($rhythmData.HealthScore))" -ForegroundColor White
            Write-Host "Queue Server: $($systemData.QueueServer)" -ForegroundColor White
            Write-Host "RPA Worker: $($systemData.RpaWorker)" -ForegroundColor White
            Write-Host "---" -ForegroundColor Magenta

            exit 0
        } catch {
            Write-Error "âŒ Error generating ChatGPT handoff context: $_"
            Write-Host "Stack Trace:" -ForegroundColor Red
            Write-Host $_.ScriptStackTrace -ForegroundColor Red
            exit 1
        }
                    status = if ($healthData.Available) { $healthData.Status } else { $null }
                    timestamp = if ($healthData.Available) { $healthData.Timestamp } else { $null }
                }
                summary_text = $summary
            }
            $jsonFile = Join-Path $WorkspaceRoot "outputs/chatgpt_lua_summary_latest.json"
            $jsonData | ConvertTo-Json -Depth 10 | Out-File -FilePath $jsonFile -Encoding UTF8
            Write-Host "âœ… íŒŒì¼ ì €ì¥ (JSON): $jsonFile" -ForegroundColor Green

            # Display summary
            Write-Host ""
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
            Write-Host $summary
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
            Write-Host ""

            Write-Host "âœ… ìš”ì•½ ìƒì„± ì™„ë£Œ!" -ForegroundColor Green
            Write-Host "   ì´ì œ ChatGPTì—ì„œ Ctrl+Vë¡œ ë¶™ì—¬ë„£ê¸°í•˜ì„¸ìš”!" -ForegroundColor Yellow

            # Open ChatGPT if requested
            if ($OpenChatGPT) {
                Write-Host ""
                Write-Host "ğŸŒ ChatGPT ì—´ê¸°..." -ForegroundColor Cyan
                Start-Process "https://chat.openai.com"
                Start-Sleep -Seconds 2
                Write-Host "âœ… ChatGPTê°€ ë¸Œë¼ìš°ì €ì—ì„œ ì—´ë ¸ìŠµë‹ˆë‹¤!" -ForegroundColor Green
            }

            Write-Host ""
            Write-Host "ğŸ’¡ Tip: ë‹¤ìŒì—ë„ ì‚¬ìš©í•˜ë ¤ë©´ VS Code Task 'ChatGPT: Send to Lua'ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”!" -ForegroundColor Magenta

        }
        catch {
            Write-Host ""
            Write-Host "âŒ ì˜¤ë¥˜ ë°œìƒ: $($_.Exception.Message)" -ForegroundColor Red
            Write-Host "   ìœ„ì¹˜: $($_.InvocationInfo.ScriptName):$($_.InvocationInfo.ScriptLineNumber)" -ForegroundColor Red
            Write-Host ""
            Write-Host "ğŸ“‹ ë””ë²„ê¹… ì •ë³´:" -ForegroundColor Yellow
            Write-Host "   - Trinity: $($trinityData.Available)" -ForegroundColor DarkGray
            Write-Host "   - Goals: $($goalsData.Available)" -ForegroundColor DarkGray
            Write-Host "   - Rhythm: $($rhythmData.Available)" -ForegroundColor DarkGray
            Write-Host "   - Health: $($healthData.Available)" -ForegroundColor DarkGray
            exit 1
        }
