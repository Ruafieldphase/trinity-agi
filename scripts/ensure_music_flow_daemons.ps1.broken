<#!
    Ensure / Heal Music & Flow Observer Daemons (Unified)
    -----------------------------------------------------
    Clean repaired version (2025-11-10).

    Scope:
      ‚Ä¢ Music Daemon (Python script: scripts/music_daemon.py)
      ‚Ä¢ Flow Observer Daemon (PowerShell job: scripts/start_flow_observer_daemon.ps1)

    Features:
      - Idempotent process/job detection (no duplicates)
      - Optional hung detection (age >= HungMinutes & CPU < 1s)
      - Force restart; selective scope (-MusicOnly / -FlowOnly)
      - Structured JSON output (-JsonOnly) & quiet mode (-Silent)
      - Lightweight retry (up to 3 attempts)
      - Logging to outputs/ensure_music_flow_daemons.log

    Exit Codes:
      0 = All requested daemons ensured
      1 = Some requested daemons not ensured
      2 = Fatal script error
!#>
param(
    [switch]$ForceRestart,
    [switch]$KillIfHung,
    [int]$HungMinutes = 45,
    [switch]$MusicOnly,
    [switch]$FlowOnly,
    [switch]$JsonOnly,
    [switch]$Silent
)

Set-StrictMode -Version Latest
$ErrorActionPreference = 'Stop'

$workspaceRoot = Split-Path -Parent $PSScriptRoot
$outDir = Join-Path $workspaceRoot 'outputs'
if (-not (Test-Path -LiteralPath $outDir)) { New-Item -ItemType Directory -Path $outDir -Force | Out-Null }
$logPath = Join-Path $outDir 'ensure_music_flow_daemons.log'

function Append-Log { param([string]$Message, [string]$Level = 'INFO') $ts = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'; Add-Content -Path $logPath -Value "[$ts] [$Level] $Message" -Encoding UTF8 }
function Write-Info { param([string]$m) if (-not $Silent -and -not $JsonOnly) { Write-Host $m -ForegroundColor Cyan }; Append-Log $m 'INFO' }
function Write-Warn { param([string]$m) if (-not $JsonOnly) { Write-Host $m -ForegroundColor Yellow }; Append-Log $m 'WARN' }
function Write-Err { param([string]$m) Write-Host $m -ForegroundColor Red; Append-Log $m 'ERROR' }
function Write-Ok { param([string]$m) if (-not $Silent -and -not $JsonOnly) { Write-Host $m -ForegroundColor Green }; Append-Log $m 'OK' }

$scriptsDir = Join-Path $workspaceRoot 'scripts'
$musicScript = Join-Path $scriptsDir 'music_daemon.py'
$flowStartPs1 = Join-Path $scriptsDir 'start_flow_observer_daemon.ps1'

function Get-PythonExe {
    $candidates = @(
        (Join-Path $workspaceRoot 'fdo_agi_repo/.venv/Scripts/python.exe'),
        (Join-Path $workspaceRoot 'LLM_Unified/.venv/Scripts/python.exe'),
        'python'
    )
    foreach ($c in $candidates) { if (Test-Path -LiteralPath $c) { return $c } }
    return 'python'
}

function Get-MusicProcesses {
    try {
        return (Get-Process -Name 'python' -ErrorAction SilentlyContinue | Where-Object { $_.CommandLine -and $_.CommandLine -like '*music_daemon.py*' })
    }
    catch { return @() }
}

function Get-FlowProcesses {
    try {
        return (Get-Process -Name 'powershell', 'pwsh' -ErrorAction SilentlyContinue | Where-Object { $_.CommandLine -and ($_.CommandLine -like '*flow_observer_daemon_loop.ps1*' -or $_.CommandLine -like '*start_flow_observer_daemon.ps1*') })
    }
    catch { return @() }
}

function Get-FlowJobs {
    try {
        return (Get-Job -ErrorAction SilentlyContinue | Where-Object { ($_.Name -like '*Flow*' -or $_.Name -like '*Observer*') -or ($_.Command -like '*flow_observer_daemon*') })
    }
    catch { return @() }
}

function Is-HungProcess {
    param([System.Diagnostics.Process]$Proc, [int]$AgeMinThreshold)
    try {
        if (-not $Proc) { return $false }
        $ageMin = [int]([datetime]::Now - $Proc.StartTime).TotalMinutes
        $cpuSec = 0
        if ($Proc.PSObject.Properties.Match('CPU').Count -gt 0 -and $null -ne $Proc.CPU) { $cpuSec = [double]$Proc.CPU }
        return ($ageMin -ge $AgeMinThreshold -and $cpuSec -lt 1.0)
    }
    catch { return $false }
}

function Stop-ProcsSafe {
    param([System.Diagnostics.Process[]]$Procs)
    if (-not $Procs) { return }
    foreach ($p in $Procs) { try { Write-Warn "Stopping PID=$($p.Id) Name=$($p.ProcessName)"; Stop-Process -Id $p.Id -Force -ErrorAction SilentlyContinue } catch { Write-Err "Failed stop PID=$($p.Id): $($_.Exception.Message)" } }
}

function Stop-FlowSafe {
    $jobs = Get-FlowJobs
    foreach ($j in $jobs) { try { Write-Warn "Stopping Job=$($j.Id) Name=$($j.Name)"; Stop-Job -Id $j.Id -Force -ErrorAction SilentlyContinue; Remove-Job -Id $j.Id -Force -ErrorAction SilentlyContinue } catch { Write-Err "Failed stop Job $($j.Id): $($_.Exception.Message)" } }
    $procs = Get-FlowProcesses
    Stop-ProcsSafe -Procs $procs
}

function Start-MusicDaemon {
    $py = Get-PythonExe
    if (-not (Test-Path -LiteralPath $musicScript)) { throw "music_daemon.py not found at $musicScript" }
    Write-Info "Starting Music Daemon with $py"
    $p = Start-Process -FilePath $py -ArgumentList @($musicScript) -WorkingDirectory $workspaceRoot -WindowStyle Hidden -PassThru -ErrorAction Stop
    Start-Sleep -Milliseconds 400
    return $p
}

function Start-FlowDaemon {
    if (-not (Test-Path -LiteralPath $flowStartPs1)) { throw "start_flow_observer_daemon.ps1 not found at $flowStartPs1" }
    Write-Info "Starting Flow Observer via start_flow_observer_daemon.ps1"
    & $flowStartPs1 | Out-Null
    Start-Sleep -Milliseconds 500
}

function Ensure-Music {
    param([switch]$Force, [switch]$KillHung, [int]$AgeMin)
    $result = @{ ensured = $false; running = 0; started = $false; pids = @(); killed = @(); message = '' }
    $procs = Get-MusicProcesses
    if ($Force) { if ($procs) { $result.killed += ($procs | ForEach-Object Id); Stop-ProcsSafe -Procs $procs; $procs = @() } }
    elseif ($KillHung -and $procs) {
        $hung = @($procs | Where-Object { Is-HungProcess -Proc $_ -AgeMinThreshold $AgeMin })
        if ($hung.Count -gt 0) { $result.killed += ($hung | ForEach-Object Id); Stop-ProcsSafe -Procs $hung; $procs = Get-MusicProcesses }
    }
    if (-not $procs) {
        $attempts = 0; $max = 3; $started = $false
        while ($attempts -lt $max -and -not $started) {
            $attempts++
            try { $p = Start-MusicDaemon; $started = $true } catch { Write-Warn "Music start attempt #$attempts failed: $($_.Exception.Message)"; Start-Sleep -Milliseconds (200 * $attempts) }
        }
    }
    $procs = Get-MusicProcesses
    $result.running = ($procs | Measure-Object).Count
    $result.pids = ($procs | ForEach-Object Id)
    $result.started = ($result.running -gt 0)
    $result.ensured = ($result.running -gt 0)
    if ($result.ensured) { Write-Ok "Music Daemon running (PIDs: $($result.pids -join ', '))" } else { Write-Warn 'Music Daemon not running' }
    return $result
}

function Ensure-Flow {
    param([switch]$Force, [switch]$KillHung, [int]$AgeMin)
    $result = @{ ensured = $false; runningJobs = 0; runningProcs = 0; started = $false; jobNames = @(); pids = @(); killedPids = @(); message = '' }
    $jobs = Get-FlowJobs
    $procs = Get-FlowProcesses
    if ($Force) { if ($jobs) { foreach ($j in $jobs) { try { Stop-Job -Id $j.Id -Force -ErrorAction SilentlyContinue; Remove-Job -Id $j.Id -Force -ErrorAction SilentlyContinue; $result.killedPids += "job:$($j.Id)" } catch { } } }; if ($procs) { $result.killedPids += ($procs | ForEach-Object Id); Stop-ProcsSafe -Procs $procs } }
    elseif ($KillHung -and $procs) {
        $hung = @($procs | Where-Object { Is-HungProcess -Proc $_ -AgeMinThreshold $AgeMin })
        if ($hung.Count -gt 0) { $result.killedPids += ($hung | ForEach-Object Id); Stop-ProcsSafe -Procs $hung }
    }
    $jobs = Get-FlowJobs
    $procs = Get-FlowProcesses
    if (-not $jobs -and -not $procs) { try { Start-FlowDaemon } catch { Write-Warn "Flow start failed: $($_.Exception.Message)" } }
    $jobs = Get-FlowJobs
    $procs = Get-FlowProcesses
    $result.runningJobs = ($jobs  | Measure-Object).Count
    $result.runningProcs = ($procs | Measure-Object).Count
    $result.jobNames = ($jobs | ForEach-Object Name)
    $result.pids = ($procs | ForEach-Object Id)
    $result.started = ($result.runningJobs -gt 0 -or $result.runningProcs -gt 0)
    $result.ensured = $result.started
    if ($result.ensured) { Write-Ok "Flow Observer running (Jobs: $($result.jobNames -join ', ') | PIDs: $($result.pids -join ', '))" } else { Write-Warn 'Flow Observer not running' }
    return $result
}

$stopwatch = [System.Diagnostics.Stopwatch]::StartNew()
$exitCode = 0
$scope = if ($MusicOnly) { 'music' } elseif ($FlowOnly) { 'flow' } else { 'both' }

$musicRes = $null; $flowRes = $null
try {
    if (-not $FlowOnly) { $musicRes = Ensure-Music -Force:$ForceRestart -KillHung:$KillIfHung -AgeMin:$HungMinutes }
    if (-not $MusicOnly) { $flowRes = Ensure-Flow  -Force:$ForceRestart -KillHung:$KillIfHung -AgeMin:$HungMinutes }
}
catch { Write-Err "Fatal error: $($_.Exception.Message)"; $exitCode = 2 }
$stopwatch.Stop()

$result = @{ ok = $true; scope = $scope; forceRestart = [bool]$ForceRestart; killIfHung = [bool]$KillIfHung; hungMinutes = [int]$HungMinutes; music = $musicRes; flow = $flowRes; elapsedMs = $stopwatch.ElapsedMilliseconds }
if ($MusicOnly -and ($musicRes -and -not $musicRes.ensured)) { $result.ok = $false }
elseif ($FlowOnly -and ($flowRes -and -not $flowRes.ensured)) { $result.ok = $false }
elseif (-not $MusicOnly -and -not $FlowOnly) { if (($musicRes -and -not $musicRes.ensured) -or ($flowRes -and -not $flowRes.ensured)) { $result.ok = $false } }

if (-not $result.ok -and $exitCode -eq 0) { $exitCode = 1 }

if ($JsonOnly) { $result | ConvertTo-Json -Depth 6 | Write-Output }
else {
    if ($result.ok) { Write-Ok    "Ensure OK (scope=$scope) in $($result.elapsedMs) ms" }
    else { Write-Warn  "Ensure PARTIAL/FAIL (scope=$scope) in $($result.elapsedMs) ms" }
}

exit $exitCode

$target = '*scripts*music_daemon.py*'
$running = Test-ProcessRunning -MatchCommand $target -ProcessNames @('python')

if ($Force -and $running) {
    Write-Log 'ForceRestart: stopping existing Music Daemon...' -Level Warn
    Stop-ProcessesSafe -Processes $running
    Start-Sleep -Seconds 1
    $running = @()
}

if ($running -and $running.Count -gt 0) {
    Write-Log "Music Daemon already running (count=$($running.Count))"
    return @{ name = 'music'; running = $true; restarted = $false; pids = ($running | Select-Object -ExpandProperty Id) }
}

Write-Log 'Starting Music Daemon...' -Level Info
$scriptPath = Join-Path $root 'scripts\music_daemon.py'
if (-not (Test-Path -LiteralPath $scriptPath)) {
    Write-Log "Missing: $scriptPath" -Level Error
    return @{ name = 'music'; running = $false; restarted = $false; error = 'script_missing' }
}

try {
    $psi = New-Object System.Diagnostics.ProcessStartInfo
    $psi.FileName = $py
    $psi.Arguments = '"' + $scriptPath + '"'
    $psi.WorkingDirectory = (Get-WorkspaceRoot)
    $psi.UseShellExecute = $false
    $psi.CreateNoWindow = $true
    [void][System.Diagnostics.Process]::Start($psi)
    Start-Sleep -Milliseconds 600
    $running = Test-ProcessRunning -MatchCommand $target -ProcessNames @('python')
    if ($running) {
        Write-Log "Music Daemon started (PID=$(($running | Select-Object -First 1).Id))" -Level Info
        return @{ name = 'music'; running = $true; restarted = $true; pids = ($running | Select-Object -ExpandProperty Id) }
    }
    else {
        Write-Log 'Failed to start Music Daemon' -Level Error
        return @{ name = 'music'; running = $false; restarted = $false; error = 'start_failed' }
    }
}
catch {
    Write-Log "Music start exception: $($_.Exception.Message)" -Level Error
    return @{ name = 'music'; running = $false; restarted = $false; error = 'exception' }
}
}

function Ensure-FlowObserver {
    param(
        [switch]$Force
    )
    $root = Get-WorkspaceRoot
    $match = '*flow_observer_daemon_loop.ps1*'
    $running = Test-ProcessRunning -MatchCommand $match -ProcessNames @('pwsh', 'powershell')

    if ($Force -and $running) {
        Write-Log 'ForceRestart: stopping existing Flow Observer...' -Level Warn
        Stop-ProcessesSafe -Processes $running
        Start-Sleep -Seconds 1
        $running = @()
    }

    if ($running -and $running.Count -gt 0) {
        Write-Log "Flow Observer already running (count=$($running.Count))"
        return @{ name = 'flow'; running = $true; restarted = $false; pids = ($running | Select-Object -ExpandProperty Id) }
    }

    Write-Log 'Starting Flow Observer...' -Level Info
    $starter = Join-Path $root 'scripts\start_flow_observer_daemon.ps1'
    if (-not (Test-Path -LiteralPath $starter)) {
        Write-Log "Missing: $starter" -Level Error
        return @{ name = 'flow'; running = $false; restarted = $false; error = 'starter_missing' }
    }

    try {
        $job = Start-Process -FilePath 'powershell' -ArgumentList @(
            '-NoProfile', '-ExecutionPolicy', 'Bypass', '-File', $starter
        ) -PassThru -WindowStyle Hidden
        Start-Sleep -Milliseconds 800
        $running = Test-ProcessRunning -MatchCommand $match -ProcessNames @('pwsh', 'powershell')
        if ($running) {
            Write-Log "Flow Observer started (PID=$(($running | Select-Object -First 1).Id))" -Level Info
            return @{ name = 'flow'; running = $true; restarted = $true; pids = ($running | Select-Object -ExpandProperty Id) }
        }
        else {
            Write-Log 'Failed to start Flow Observer' -Level Error
            return @{ name = 'flow'; running = $false; restarted = $false; error = 'start_failed' }
        }
    }
    catch {
        Write-Log "Flow start exception: $($_.Exception.Message)" -Level Error
        return @{ name = 'flow'; running = $false; restarted = $false; error = 'exception' }
    }
}

function Build-ResultJson {
    param(
        [hashtable]$Music,
        [hashtable]$Flow
    )
    $out = [ordered]@{
        ok        = ($Music.running -and $Flow.running)
        music     = $Music
        flow      = $Flow
        timestamp = (Get-Date).ToString('s')
    }
    return ($out | ConvertTo-Json -Depth 6)
}

#
# Main
#
try {
    $ensureMusic = -not $FlowOnly
    $ensureFlow = -not $MusicOnly

    $mResult = @{ name = 'music'; running = $false; restarted = $false; error = 'skipped' }
    $fResult = @{ name = 'flow'; running = $false; restarted = $false; error = 'skipped' }

    if ($ensureMusic) { $mResult = Ensure-MusicDaemon -Force:$ForceRestart }
    if ($ensureFlow) { $fResult = Ensure-FlowObserver -Force:$ForceRestart }

    $json = Build-ResultJson -Music $mResult -Flow $fResult
    if ($JsonOnly) {
        Write-Output $json
    }
    else {
        Write-Log '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ Ensure Music + Flow Daemons ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ' -Level Info
        Write-Host $json
    }

    if (-not ($mResult.running -and $fResult.running)) { exit 1 }
    exit 0
}
catch {
    $err = [ordered]@{
        ok    = $false
        error = $_.Exception.Message
        when  = (Get-Date).ToString('s')
    } | ConvertTo-Json
    if ($JsonOnly) { Write-Output $err } else { Write-Log $err -Level Error }
    exit 1
}

# ===================
# Clean repaired version (2025-11-10)
# ===================
# Lint-friendly, idempotent, JSON-able, silent-aware.
# Validate basic syntax quickly
if ($PSCommandPath) {
    try {
        $null = Invoke-ScriptAnalyzer -Path $PSCommandPath -Recurse -Severity Error -ErrorAction SilentlyContinue
    }
    catch {}
}
$hung = $proc | Where-Object { Test-IsHungProcess -Proc $_ -AgeMinutes $HungThresholdMinutes }
if ($hung) { Write-Warn 'Hung Flow Observer process detected -> restarting'; Stop-ProcessSafe $hung 'FlowObserverHung'; if ($job) { Stop-Job -Id $job.Id -ErrorAction SilentlyContinue; Remove-Job -Id $job.Id -ErrorAction SilentlyContinue }; $running = @(); $restarted = $true }
}
if ($running.Count -gt 0) {
    $pid = if ($proc) { $proc[0].Id } else { $null }
    Write-Ok "‚úÖ Flow Observer daemon healthy (job/process count: $($running.Count))"
    return @{ name = 'flow'; ensured = $true; started = $false; restarted = $restarted; pid = $pid; jobId = ($job?.Id) }
}
$startScript = Join-Path $workspaceRoot 'scripts/start_flow_observer_daemon.ps1'
if (-not (Test-Path -LiteralPath $startScript)) {
    Write-Err "start_flow_observer_daemon.ps1 missing: $startScript"
    return @{ name = 'flow'; ensured = $false; started = $false; restarted = $restarted; pid = $null; error = 'flow_script_missing' }
}
Write-Info "üåä Starting Flow Observer Daemon (interval=$FlowIntervalSeconds s)..."
try {
    & $startScript -IntervalSeconds $FlowIntervalSeconds | Out-Null
    Start-Sleep -Milliseconds 800
    $job2 = Get-Job -Name 'FlowObserverDaemon' -ErrorAction SilentlyContinue
    $proc2 = Get-Process -Name 'pwsh', 'powershell' -ErrorAction SilentlyContinue | Where-Object { $_.CommandLine -like '*flow_observer_daemon_loop.ps1*' }
    if ($job2 -or $proc2) {
        $pid = if ($proc2) { $proc2[0].Id } else { $null }
        Write-Ok "‚úÖ Flow Observer started (PID: $pid Job: $($job2?.Id))"
        return @{ name = 'flow'; ensured = $true; started = $true; restarted = $restarted; pid = $pid; jobId = ($job2?.Id) }
    }
    Write-Err 'Failed to verify Flow Observer startup'
    return @{ name = 'flow'; ensured = $false; started = $true; restarted = $restarted; pid = $null; error = 'start_failed' }
}
catch {
    Write-Err "Flow Observer start error: $_"
    return @{ name = 'flow'; ensured = $false; started = $true; restarted = $restarted; pid = $null; error = 'exception' }
}
}

Append-Log '--- ensure_music_flow_daemons invocation ---'
Append-Log "Params: MusicOnly=$MusicOnly FlowOnly=$FlowOnly KillIfHung=$KillIfHung ForceRestart=$ForceRestart MusicInterval=$MusicIntervalSeconds FlowInterval=$FlowIntervalSeconds"

$results = @()
if (-not $FlowOnly) { $results += (Ensure-MusicDaemon -Force:$ForceRestart -CheckHung:$KillIfHung) }
if (-not $MusicOnly) { $results += (Ensure-FlowDaemon -Force:$ForceRestart -CheckHung:$KillIfHung) }

$summary = [ordered]@{
    timestamp    = (Get-Date).ToString('s')
    workspace    = $workspaceRoot
    scope        = if ($MusicOnly) { 'music-only' } elseif ($FlowOnly) { 'flow-only' } else { 'both' }
    killIfHung   = [bool]$KillIfHung
    forceRestart = [bool]$ForceRestart
    results      = $results
    ok           = ($results | Where-Object { -not $_.ensured }).Count -eq 0
}

if ($JsonOnly) {
    $summary | ConvertTo-Json -Depth 6 | Write-Output
}
else {
    Write-Info 'Summary:'
    foreach ($r in $results) {
        $status = if ($r.ensured) { 'OK' } else { 'ISSUE' }
        Write-Host " ‚Ä¢ ${($r.name)}: $status (pid=$($r.pid))" -ForegroundColor (if ($r.ensured) { 'Green' } else { 'Red' })
    }
    Write-Host (ConvertTo-Json $summary -Depth 6) -ForegroundColor Gray
}

exit (if ($summary.ok) { 0 } else { 1 })
return @{ ensured = $true; started = $true; pid = $running3[0].Id }
}
Write-Err '‚ùå Failed to start Music Daemon'
return @{ ensured = $false; started = $false; pid = $null; error = 'start_failed' }
}

function Get-FlowJobs {
    @(
        (Get-Job -Name 'FlowObserverDaemon' -ErrorAction SilentlyContinue);
        (Get-Job -Name 'FlowTelemetry' -ErrorAction SilentlyContinue)
    ) | Where-Object { $_ }
}

function Ensure-FlowDaemon {
    $startScript = Join-Path $PSScriptRoot 'start_flow_observer_daemon.ps1'
    $loopScript = Join-Path $PSScriptRoot 'flow_observer_daemon_loop.ps1'
    $runningProc = Get-Process -Name 'pwsh', 'powershell' -ErrorAction SilentlyContinue | Where-Object { $_.CommandLine -like '*flow_observer_daemon_loop.ps1*' }
    $jobs = Get-FlowJobs
    if ($runningProc -or $jobs) {
        Write-Ok "‚úÖ Flow Observer already running"
        return @{ ensured = $true; started = $false; jobs = @($jobs | Select-Object -ExpandProperty Id -ErrorAction SilentlyContinue) }
    }
    if (-not (Test-Path -LiteralPath $startScript)) {
        if (-not (Test-Path -LiteralPath $loopScript)) {
            Write-Warn "‚ö†Ô∏è Flow observer scripts not found. Skipping."
            return @{ ensured = $false; started = $false; error = 'flow_scripts_missing' }
        }
        Write-Info "üåä Starting Flow Observer (direct loop)..."
        Start-Process -FilePath 'powershell' -ArgumentList "-NoProfile", "-ExecutionPolicy", "Bypass", "-File", "$loopScript", "-IntervalSeconds", "$FlowIntervalSeconds" -WindowStyle Hidden -WorkingDirectory $workspaceRoot | Out-Null
        Start-Sleep -Milliseconds 800
        $runningProc = Get-Process -Name 'pwsh', 'powershell' -ErrorAction SilentlyContinue | Where-Object { $_.CommandLine -like '*flow_observer_daemon_loop.ps1*' }
        if ($runningProc) { Write-Ok '‚úÖ Flow Observer started'; return @{ ensured = $true; started = $true } } else { Write-Err '‚ùå Failed to start Flow Observer'; return @{ ensured = $false; started = $false; error = 'start_failed' } }
    }
    Write-Info 'üåä Starting Flow Observer daemon...'
    try {
        & powershell -NoProfile -ExecutionPolicy Bypass -File $startScript -IntervalSeconds $FlowIntervalSeconds | Out-Null
    }
    catch { }
    Start-Sleep -Milliseconds 800
    $jobs = Get-FlowJobs
    $runningProc = Get-Process -Name 'pwsh', 'powershell' -ErrorAction SilentlyContinue | Where-Object { $_.CommandLine -like '*flow_observer_daemon_loop.ps1*' }
    if ($runningProc -or $jobs) { Write-Ok '‚úÖ Flow Observer started'; return @{ ensured = $true; started = $true; jobs = @($jobs | Select-Object -ExpandProperty Id -ErrorAction SilentlyContinue) } } else { Write-Err '‚ùå Failed to start Flow Observer'; return @{ ensured = $false; started = $false; error = 'start_failed' } }
}

$result = @{}
if (-not $FlowOnly) { $result.Music = Ensure-MusicDaemon }
if (-not $MusicOnly) { $result.Flow = Ensure-FlowDaemon }

if ($JsonOnly) { $result | ConvertTo-Json -Depth 6 | Write-Output }
else { Write-Info ("Result: " + ($result | ConvertTo-Json -Depth 6)) }
force_restart = [bool]$ForceRestart
killed_hung = [bool]$KillIfHung
timestamp = (Get-Date).ToString('o')
log = $logPath
}

$json = $status | ConvertTo-Json -Depth 5
if (-not $Silent -and -not $JsonOnly) {
    Write-Host "\n=== Music + Flow Daemon Status ===" -ForegroundColor Cyan
    Write-Host "Music: $($status.music_running) PID=$($status.music_pid)" -ForegroundColor Gray
    Write-Host "Flow Jobs: $((($status.flow_jobs).Count))" -ForegroundColor Gray
    Write-Host "Flow Processes: $((($status.flow_processes).Count))" -ForegroundColor Gray
}
Write-Output $json

