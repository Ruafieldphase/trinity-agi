#requires -Version 5.1
param(
    [string]$Source = 'D:\nas_backup',
    [string]$Target = 'C:\workspace\agi',
    [string[]]$Folders = @('scripts', 'outputs', 'session_memory', 'docs', 'configs', 'knowledge_base'),
    [switch]$DryRun,
    [string]$ReportPath = ''
)

$ErrorActionPreference = 'Stop'

function Write-Info($msg) { Write-Host $msg -ForegroundColor Cyan }
function Write-Ok($msg) { Write-Host $msg -ForegroundColor Green }
function Write-Warn($msg) { Write-Host $msg -ForegroundColor Yellow }
function Write-Err($msg) { Write-Host $msg -ForegroundColor Red }

if (-not (Test-Path -LiteralPath $Source)) { Write-Err "‚ùå Source not found: $Source"; exit 1 }
if (-not (Test-Path -LiteralPath $Target)) { Write-Warn "üìÅ Target missing. Creating: $Target"; New-Item -ItemType Directory -Path $Target -Force | Out-Null }

$nowTag = (Get-Date -Format 'yyyyMMdd_HHmmss')
if (-not $ReportPath -or [string]::IsNullOrWhiteSpace($ReportPath)) {
    $outDir = Join-Path $Source 'outputs'
    if (-not (Test-Path -LiteralPath $outDir)) { New-Item -ItemType Directory -Path $outDir -Force | Out-Null }
    $ReportPath = Join-Path $outDir ("migration_conflicts_" + $nowTag + ".csv")
}

Write-Info "üîé Safe Migration (non-destructive)"
Write-Host  "    Source: $Source"
Write-Host  "    Target: $Target"
Write-Host  "    Folders: $($Folders -join ', ')"
Write-Host  "    Mode:    $(if($DryRun){'DRY-RUN (no copy)'}else{'COPY missing only'})"

$conflicts = New-Object System.Collections.Generic.List[object]
$stats = @()

foreach ($f in $Folders) {
    $s = Join-Path $Source $f
    $d = Join-Path $Target $f
    if (-not (Test-Path -LiteralPath $s)) { Write-Warn "‚ö†Ô∏è  Skip missing folder: $s"; continue }
    if (-not (Test-Path -LiteralPath $d)) { New-Item -ItemType Directory -Path $d -Force | Out-Null }

    $srcFiles = Get-ChildItem -LiteralPath $s -Recurse -File -ErrorAction SilentlyContinue
    $missing = 0; $same = 0; $conf = 0; $copied = 0

    foreach ($sf in $srcFiles) {
        $rel = $sf.FullName.Substring($s.Length).TrimStart('\')
        $df = Join-Path $d $rel
        $dp = Split-Path -Path $df -Parent

        if (-not (Test-Path -LiteralPath $df)) {
            $missing++
            if (-not $DryRun) {
                if (-not (Test-Path -LiteralPath $dp)) { New-Item -ItemType Directory -Path $dp -Force | Out-Null }
                Copy-Item -LiteralPath $sf.FullName -Destination $df -Force
                $copied++
            }
            continue
        }

        $di = Get-Item -LiteralPath $df
        if (($sf.Length -eq $di.Length) -and ($sf.LastWriteTimeUtc -eq $di.LastWriteTimeUtc)) { $same++ }
        else {
            $conf++
            $conflicts.Add([pscustomobject]@{
                    Folder          = $f
                    RelativePath    = $rel
                    SourceSize      = $sf.Length
                    TargetSize      = $di.Length
                    SourceTime      = $sf.LastWriteTimeUtc.ToString('o')
                    TargetTime      = $di.LastWriteTimeUtc.ToString('o')
                    SuggestedAction = 'Review (no overwrite by default)'
                }) | Out-Null
        }
    }

    $stats += [pscustomobject]@{ Folder = $f; Total = $srcFiles.Count; Missing = $missing; Copied = $copied; Conflicts = $conf; Same = $same }
}

# Save conflicts report
if ($conflicts.Count -gt 0) {
    $conflicts | Export-Csv -Path $ReportPath -Encoding UTF8 -NoTypeInformation
    Write-Warn "‚ö†Ô∏è  Conflicts detected: $($conflicts.Count)"
    Write-Host "üìÑ Conflict report: $ReportPath"
}

Write-Host "\nüìà Summary:" -ForegroundColor Cyan
$stats | Format-Table -AutoSize

Write-Ok "\n‚úÖ Safe migration completed. $(if($DryRun){'No files copied.'} else {'Missing files copied.'})"
exit 0
