<#
.SYNOPSIS
    VS Codeì—ì„œ í„°ë¯¸ë„ ë°©í•´ ì—†ì´ ì‘ì—…í•˜ëŠ” ì„¤ì •

.DESCRIPTION
    í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ PowerShell Jobì„ ì •ë¦¬í•˜ê³ 
    ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰ìœ¼ë¡œ ì „í™˜

.EXAMPLE
    .\cleanup_terminal_jobs.ps1
#>

[CmdletBinding()]
param()
. "$PSScriptRoot\Get-WorkspaceRoot.ps1"
$WorkspaceRoot = Get-WorkspaceRoot

$ErrorActionPreference = 'Stop'

Write-Host "`nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
Write-Host "â•‘  í„°ë¯¸ë„ ì •ë¦¬ ë° ë°±ê·¸ë¼ìš´ë“œ ì „í™˜          â•‘" -ForegroundColor Cyan
Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`n" -ForegroundColor Cyan

# 1. í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ Job í™•ì¸
Write-Host "ğŸ“Š í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ Jobs:" -ForegroundColor Cyan
$jobs = Get-Job | Where-Object { $_.Name -like 'AGI_*' }

if ($jobs.Count -eq 0) {
    Write-Host "   âœ… ì‹¤í–‰ ì¤‘ì¸ Job ì—†ìŒ" -ForegroundColor Green
}
else {
    Write-Host "   ë°œê²¬: $($jobs.Count)ê°œ`n" -ForegroundColor Yellow
    
    foreach ($job in $jobs) {
        Write-Host "   ğŸ”¹ $($job.Name)" -ForegroundColor White
        Write-Host "      ìƒíƒœ: $($job.State)" -ForegroundColor Gray
        Write-Host "      ì‹œì‘: $($job.PSBeginTime)" -ForegroundColor Gray
    }
    
    # 2. ìƒíƒœ ì €ì¥
    Write-Host "`nğŸ’¾ í˜„ì¬ ìƒíƒœ ì €ì¥ ì¤‘..." -ForegroundColor Cyan
    $statusFile = Join-Path $WorkspaceRoot "outputs\job_state_before_cleanup.json"
    
    $state = @{
        timestamp = (Get-Date).ToString("o")
        jobs      = $jobs | ForEach-Object {
            @{
                name      = $_.Name
                state     = $_.State
                startTime = $_.PSBeginTime
                id        = $_.Id
            }
        }
    }
    
    $state | ConvertTo-Json -Depth 3 | Out-File -FilePath $statusFile -Encoding UTF8
    Write-Host "   âœ… ì €ì¥ ì™„ë£Œ: job_state_before_cleanup.json" -ForegroundColor Green
    
    # 3. Job ì •ë¦¬
    Write-Host "`nğŸ§¹ Job ì •ë¦¬ ì¤‘..." -ForegroundColor Cyan
    
    $runningJobs = $jobs | Where-Object { $_.State -eq 'Running' }
    $completedJobs = $jobs | Where-Object { $_.State -eq 'Completed' -or $_.State -eq 'Failed' }
    
    if ($runningJobs.Count -gt 0) {
        Write-Host "   ì¤‘ì§€: $($runningJobs.Count)ê°œ" -ForegroundColor Yellow
        $runningJobs | Stop-Job
        Start-Sleep -Seconds 1
    }
    
    Write-Host "   ì œê±°: $($jobs.Count)ê°œ" -ForegroundColor Yellow
    $jobs | Remove-Job -Force
    
    Write-Host "   âœ… ì •ë¦¬ ì™„ë£Œ" -ForegroundColor Green
}

# 4. ë°±ê·¸ë¼ìš´ë“œ ì „í™˜ ì œì•ˆ
Write-Host "`nğŸš€ ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰ ì˜µì…˜:" -ForegroundColor Cyan
Write-Host ""
Write-Host "   [ê¶Œì¥] Task Schedulerë¡œ ì „í™˜:" -ForegroundColor Green
Write-Host "   .\scripts\start_24h_silent.ps1" -ForegroundColor White
Write-Host ""
Write-Host "   ë˜ëŠ” ìˆ¨ê¹€ ì°½ìœ¼ë¡œ ì‹¤í–‰:" -ForegroundColor Yellow
Write-Host "   .\scripts\start_24h_silent.ps1 -Method hidden" -ForegroundColor White
Write-Host ""

# 5. VS Code ì„¤ì • ì œì•ˆ
Write-Host "ğŸ’¡ VS Code í„°ë¯¸ë„ ì„¤ì • ê°œì„ :" -ForegroundColor Cyan
Write-Host ""
Write-Host "   1. Ctrl+, (ì„¤ì • ì—´ê¸°)" -ForegroundColor Gray
Write-Host "   2. ê²€ìƒ‰: 'terminal.integrated.automationProfile.windows'" -ForegroundColor Gray
Write-Host "   3. ë˜ëŠ” settings.jsonì— ì¶”ê°€:" -ForegroundColor Gray
Write-Host '      "terminal.integrated.hideOnStartup": "whenEmpty"' -ForegroundColor DarkGray
Write-Host '      "terminal.integrated.defaultProfile.windows": "PowerShell"' -ForegroundColor DarkGray
Write-Host ""

# 6. í˜„ì¬ í„°ë¯¸ë„ ìƒíƒœ
Write-Host "ğŸ“Š í˜„ì¬ í„°ë¯¸ë„ ìƒíƒœ:" -ForegroundColor Cyan
$currentJobs = Get-Job
if ($currentJobs.Count -eq 0) {
    Write-Host "   âœ… ê¹¨ë—í•¨ (ì‹¤í–‰ ì¤‘ì¸ Job ì—†ìŒ)" -ForegroundColor Green
}
else {
    Write-Host "   âš ï¸  $($currentJobs.Count)ê°œ Job ë‚¨ì•„ìˆìŒ" -ForegroundColor Yellow
}

Write-Host "`nâœ… ì •ë¦¬ ì™„ë£Œ!" -ForegroundColor Green
Write-Host "   ì´ì œ í„°ë¯¸ë„ ë°©í•´ ì—†ì´ ì‘ì—…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." -ForegroundColor White
Write-Host ""
