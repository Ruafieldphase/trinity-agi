#Requires -Version 5.1
<#
.SYNOPSIS
    Lua Trinity Bridge - ChatGPT í•¸ë“œì˜¤í”„ ë¦¬í¬íŠ¸ ìƒì„± ë° í´ë¦½ë³´ë“œ ìë™ ë³µì‚¬
.DESCRIPTION
    Lua ëª¨ë“ˆ(ì„¸ì…˜/ë¦¬ë“¬/ëª©í‘œ)ì˜ í˜„ì¬ ìƒíƒœë¥¼ ì½ì–´ì„œ ChatGPTì—ê²Œ ì „ë‹¬í• 
    í•¸ë“œì˜¤í”„ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. Markdownê³¼ JSON í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•˜ë©°,
    í´ë¦½ë³´ë“œì— ìë™ìœ¼ë¡œ ë³µì‚¬í•˜ì—¬ ìƒˆ ì±„íŒ…ì°½ì— ë°”ë¡œ ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥í•©ë‹ˆë‹¤.
.PARAMETER Silent
    ì½˜ì†” ì¶œë ¥ì„ ìµœì†Œí™”í•©ë‹ˆë‹¤.
.PARAMETER NoClipboard
    í´ë¦½ë³´ë“œ ë³µì‚¬ë¥¼ ìƒëµí•©ë‹ˆë‹¤.
.PARAMETER OutMd
    Markdown ì¶œë ¥ íŒŒì¼ ê²½ë¡œë¥¼ ì§€ì •í•©ë‹ˆë‹¤. (ê¸°ë³¸: outputs/lua_handoff_latest.md)
.PARAMETER OutJson
    JSON ì¶œë ¥ íŒŒì¼ ê²½ë¡œë¥¼ ì§€ì •í•©ë‹ˆë‹¤. (ê¸°ë³¸: outputs/lua_handoff_latest.json)
.EXAMPLE
    .\send_to_chatgpt_lua.ps1
    .\send_to_chatgpt_lua.ps1 -Silent
    .\send_to_chatgpt_lua.ps1 -NoClipboard -OutMd "custom.md"
#>

[CmdletBinding()]
param(
    [switch]$Silent,
    [switch]$NoClipboard,
    [string]$OutMd = "",
    [string]$OutJson = ""
)

$ErrorActionPreference = "Stop"
Set-StrictMode -Version Latest

# ============================================================================
# ì„¤ì •
# ============================================================================

$WorkspaceRoot = Split-Path -Parent $PSScriptRoot
$OutputsDir = Join-Path $WorkspaceRoot "outputs"

if (-not $OutMd) {
    $OutMd = Join-Path $OutputsDir "lua_handoff_latest.md"
}
if (-not $OutJson) {
    $OutJson = Join-Path $OutputsDir "lua_handoff_latest.json"
}

# ì…ë ¥ íŒŒì¼ ê²½ë¡œ
$SessionFile = Join-Path $OutputsDir "session_continuity_latest.md"
$RhythmFile = Join-Path $OutputsDir "RHYTHM_SYSTEM_STATUS_REPORT.md"
$GoalFile = Join-Path $WorkspaceRoot "fdo_agi_repo" "memory" "goal_tracker.json"

# ============================================================================
# ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
# ============================================================================

function Write-Log {
    param([string]$Message, [string]$Level = "INFO")
    if (-not $Silent) {
        $timestamp = Get-Date -Format "HH:mm:ss"
        $color = switch ($Level) {
            "ERROR" { "Red" }
            "WARN" { "Yellow" }
            "SUCCESS" { "Green" }
            default { "Cyan" }
        }
        Write-Host "[$timestamp] $Message" -ForegroundColor $color
    }
}

function Get-SafeContent {
    param([string]$Path)
    if (Test-Path -LiteralPath $Path) {
        try {
            return Get-Content -LiteralPath $Path -Raw -Encoding UTF8
        } catch {
            Write-Log "íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: $Path - $_" "WARN"
            return $null
        }
    }
    return $null
}

function Get-SessionSummary {
    $content = Get-SafeContent $SessionFile
    if (-not $content) {
        return @{
            status = "âŒ ì„¸ì…˜ ë¦¬í¬íŠ¸ ì—†ìŒ"
            summary = "ì„¸ì…˜ ì—°ì†ì„± ë¦¬í¬íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            raw = ""
        }
    }

    # í•µì‹¬ ì •ë³´ ì¶”ì¶œ (ê°„ë‹¨í•œ íŒŒì‹±)
    $lines = $content -split "`n"
    $statusLine = $lines | Where-Object { $_ -match "í˜„ì¬ ìƒíƒœ|Status" } | Select-Object -First 1
    $summaryLines = $lines | Select-Object -First 20 | Out-String

    return @{
        status = if ($statusLine) { $statusLine.Trim() } else { "âœ… ì„¸ì…˜ ë¦¬í¬íŠ¸ ì¡´ì¬" }
        summary = $summaryLines.Trim()
        raw = $content
    }
}

function Get-RhythmSummary {
    $content = Get-SafeContent $RhythmFile
    if (-not $content) {
        return @{
            status = "âŒ ë¦¬ë“¬ ë¦¬í¬íŠ¸ ì—†ìŒ"
            phase = "ì•Œ ìˆ˜ ì—†ìŒ"
            summary = "ë¦¬ë“¬ ë¦¬í¬íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            raw = ""
        }
    }

    # ë¦¬ë“¬ í˜ì´ì¦ˆ ì¶”ì¶œ
    $phaseLine = $content -split "`n" | Where-Object { $_ -match "Phase|í˜ì´ì¦ˆ|PHASE" } | Select-Object -First 1
    $phase = if ($phaseLine -match "(REST|FOCUS|RHYTHM)") { $matches[1] } else { "ì•Œ ìˆ˜ ì—†ìŒ" }

    $summaryLines = ($content -split "`n") | Select-Object -First 15 | Out-String

    return @{
        status = "âœ… ë¦¬ë“¬ ë™ê¸°í™” ì™„ë£Œ"
        phase = $phase
        summary = $summaryLines.Trim()
        raw = $content
    }
}

function Get-GoalSummary {
    $content = Get-SafeContent $GoalFile
    if (-not $content) {
        return @{
            status = "âŒ ëª©í‘œ ì¶”ì  ì—†ìŒ"
            total = 0
            active = 0
            completed = 0
            failed = 0
            goals = @()
            raw = ""
        }
    }

    try {
        $data = $content | ConvertFrom-Json
        $goals = if ($data.goals) { $data.goals } else { @() }
        
        return @{
            status = "âœ… ëª©í‘œ ì¶”ì  í™œì„±"
            total = $goals.Count
            active = @($goals | Where-Object { $_.status -eq "in_progress" }).Count
            completed = @($goals | Where-Object { $_.status -eq "completed" }).Count
            failed = @($goals | Where-Object { $_.status -eq "failed" }).Count
            goals = $goals | Select-Object -First 5
            raw = $content
        }
    } catch {
        Write-Log "ëª©í‘œ JSON íŒŒì‹± ì‹¤íŒ¨: $_" "WARN"
        return @{
            status = "âš ï¸ ëª©í‘œ íŒŒì‹± ì˜¤ë¥˜"
            total = 0
            active = 0
            completed = 0
            failed = 0
            goals = @()
            raw = $content
        }
    }
}

# ============================================================================
# ë©”ì¸ ë¡œì§
# ============================================================================

try {
    Write-Log "ğŸ”„ Lua Trinity Bridge ì‹œì‘..." "INFO"

    # ë°ì´í„° ìˆ˜ì§‘
    Write-Log "ğŸ“– ì„¸ì…˜ ì—°ì†ì„± ë¦¬í¬íŠ¸ ë¡œë“œ ì¤‘..." "INFO"
    $session = Get-SessionSummary

    Write-Log "ğŸŒŠ ë¦¬ë“¬ ì‹œìŠ¤í…œ ìƒíƒœ ë¡œë“œ ì¤‘..." "INFO"
    $rhythm = Get-RhythmSummary

    Write-Log "ğŸ¯ ììœ¨ ëª©í‘œ íŠ¸ë˜ì»¤ ë¡œë“œ ì¤‘..." "INFO"
    $goal = Get-GoalSummary

    # Markdown ìƒì„±
    Write-Log "ğŸ“ Markdown ë¦¬í¬íŠ¸ ìƒì„± ì¤‘..." "INFO"
    
    $mdContent = @"
# ğŸ”— Lua Trinity Bridge - ChatGPT í•¸ë“œì˜¤í”„ ë¦¬í¬íŠ¸

> **ìƒì„± ì‹œê°**: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")
> **ì›Œí¬ìŠ¤í˜ì´ìŠ¤**: $WorkspaceRoot

---

## ğŸ“Š í†µí•© ìƒíƒœ ìš”ì•½

| ëª¨ë“ˆ | ìƒíƒœ | ìš”ì•½ |
|------|------|------|
| ì„¸ì…˜ ì—°ì†ì„± | $($session.status) | ìµœê·¼ ì„¸ì…˜ ìŠ¤ëƒ…ìƒ· ë¡œë“œ |
| ë¦¬ë“¬ ì‹œìŠ¤í…œ | $($rhythm.status) | Phase: **$($rhythm.phase)** |
| ììœ¨ ëª©í‘œ | $($goal.status) | í™œì„± $($goal.active) / ì™„ë£Œ $($goal.completed) / ì‹¤íŒ¨ $($goal.failed) |

---

## ğŸ“– 1. ì„¸ì…˜ ì—°ì†ì„±

$($session.summary)

---

## ğŸŒŠ 2. ë¦¬ë“¬ ì‹œìŠ¤í…œ

$($rhythm.summary)

---

## ğŸ¯ 3. ììœ¨ ëª©í‘œ íŠ¸ë˜ì»¤

**ì´ ëª©í‘œ**: $($goal.total)ê°œ
- **ì§„í–‰ ì¤‘**: $($goal.active)ê°œ
- **ì™„ë£Œ**: $($goal.completed)ê°œ
- **ì‹¤íŒ¨**: $($goal.failed)ê°œ

### ìµœê·¼ ëª©í‘œ (ìµœëŒ€ 5ê°œ)

"@

    if ($goal.goals.Count -gt 0) {
        foreach ($g in $goal.goals) {
            $mdContent += "`n- [$($g.status)] $($g.title)"
        }
    } else {
        $mdContent += "`n*(ëª©í‘œ ì—†ìŒ)*"
    }

    $mdContent += @"


---

## ğŸ’¡ ì¶”ì²œ ë‹¤ìŒ í–‰ë™

1. ë¦¬ë“¬ ìƒíƒœ í™•ì¸ ë° ì ì‘
2. í™œì„± ëª©í‘œ ì§„í–‰ ìƒí™© ê²€í† 
3. ì„¸ì…˜ ì—°ì†ì„± ìœ ì§€

---

**ì‚¬ìš© ë°©ë²•**: ì´ ë¦¬í¬íŠ¸ë¥¼ ìƒˆ ChatGPT ì±„íŒ…ì°½ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”!
"@

    # JSON ìƒì„±
    Write-Log "ğŸ“‹ JSON ë¦¬í¬íŠ¸ ìƒì„± ì¤‘..." "INFO"
    
    $jsonData = @{
        timestamp = Get-Date -Format "o"
        workspace = $WorkspaceRoot
        modules = @{
            session = $session
            rhythm = $rhythm
            goal = $goal
        }
        summary = @{
            session_status = $session.status
            rhythm_phase = $rhythm.phase
            goals_active = $goal.active
            goals_completed = $goal.completed
            goals_failed = $goal.failed
        }
    }

    # íŒŒì¼ ì €ì¥
    if (-not (Test-Path $OutputsDir)) {
        New-Item -ItemType Directory -Path $OutputsDir -Force | Out-Null
    }

    Write-Log "ğŸ’¾ íŒŒì¼ ì €ì¥ ì¤‘..." "INFO"
    $mdContent | Out-File -FilePath $OutMd -Encoding UTF8 -NoNewline
    $jsonData | ConvertTo-Json -Depth 10 | Out-File -FilePath $OutJson -Encoding UTF8

    # í´ë¦½ë³´ë“œ ë³µì‚¬
    if (-not $NoClipboard) {
        Write-Log "ğŸ“‹ í´ë¦½ë³´ë“œ ë³µì‚¬ ì¤‘..." "INFO"
        try {
            Set-Clipboard -Value $mdContent
            Write-Log "âœ… í´ë¦½ë³´ë“œ ë³µì‚¬ ì™„ë£Œ! Ctrl+Vë¡œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”!" "SUCCESS"
        } catch {
            Write-Log "âš ï¸ í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨: $_" "WARN"
        }
    }

    # ì™„ë£Œ ë©”ì‹œì§€
    Write-Log "" "INFO"
    Write-Log "âœ… Lua Trinity Bridge ì™„ë£Œ!" "SUCCESS"
    Write-Log "" "INFO"
    Write-Log "ğŸ“„ ì¶œë ¥ íŒŒì¼:" "INFO"
    Write-Log "  - Markdown: $OutMd" "INFO"
    Write-Log "  - JSON: $OutJson" "INFO"
    
    if (-not $NoClipboard) {
        Write-Log "" "INFO"
        Write-Log "ğŸ‰ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!" "SUCCESS"
        Write-Log "   ìƒˆ ChatGPT ì±„íŒ…ì°½ì„ ì—´ê³  Ctrl+Vë¡œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”!" "SUCCESS"
    }

    exit 0

} catch {
    Write-Log "âŒ ì˜¤ë¥˜ ë°œìƒ: $_" "ERROR"
    Write-Log $_.ScriptStackTrace "ERROR"
    exit 1
}
