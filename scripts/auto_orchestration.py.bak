#!/usr/bin/env python3
"""
ìë™í™”ëœ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸
í˜ë¥´ì†Œë‚˜ í˜‘ì—…ì„ ìë™ìœ¼ë¡œ ì‹¤í–‰í•˜ê³  í†µí•© ì†”ë£¨ì…˜ì„ ë„ì¶œí•©ë‹ˆë‹¤.
"""

import requests
from utils.request_guard import post_json
from utils.validator import lumen_chat_schema

import json
from datetime import datetime
from pathlib import Path
from typing import List, Dict, Any

# ì„¤ì •
LUMEN_GATEWAY = "https://lumen-gateway-x4qvsargwa-uc.a.run.app/chat"
OUTPUT_DIR = Path(__file__).parent.parent / "outputs"
OUTPUT_DIR.mkdir(exist_ok=True)

def query_persona(persona_name: str, question: str) -> str:
    """í˜ë¥´ì†Œë‚˜ì—ê²Œ ì§ˆë¬¸"""
    prompt = f"{persona_name}, {question}"
    payload = {"message": prompt}
    
    try:
        response = post_json(LUMEN_GATEWAY, payload, schema=lumen_chat_schema, headers={'Content-Type': 'application/json; charset=utf-8'}, timeout=30)
        response.raise_for_status()
        result = response.json()
        return result.get('response', 'No response')
    except Exception as e:
        return f"Error: {str(e)}"

def orchestrate_analysis(topic: str) -> Dict[str, Any]:
    """3ë‹¨ê³„ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ ì‹¤í–‰"""
    print(f"\nğŸ¯ ì£¼ì œ: {topic}\n")
    print("=" * 60)
    
    results = {
        "topic": topic,
        "timestamp": datetime.now().isoformat(),
        "personas": {}
    }
    
    # 1ë‹¨ê³„: ì„¸ë‚˜ - í˜„ì¬ ìƒíƒœ ë¶„ì„
    print("\n1ï¸âƒ£ ì„¸ë‚˜ (âœ’ï¸) - í˜„ì¬ ìƒíƒœ ë¶„ì„...")
    sena_response = query_persona("ì„¸ë‚˜", f"{topic}ì— ëŒ€í•œ í˜„ì¬ ìƒíƒœë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”.")
    results["personas"]["sena"] = sena_response
    print(f"   ì‘ë‹µ: {sena_response[:100]}...")
    
    # 2ë‹¨ê³„: ë£¨ë¹— - ê¸°ìˆ ì  ì ‘ê·¼ ë°©ë²•
    print("\n2ï¸âƒ£ ë£¨ë¹— (ğŸª¨) - ê¸°ìˆ ì  ì ‘ê·¼ ë°©ë²•...")
    rubit_prompt = f"{topic}ì— ëŒ€í•´, ì„¸ë‚˜ê°€ ë‹¤ìŒê³¼ ê°™ì´ ë¶„ì„í–ˆìŠµë‹ˆë‹¤:\n\n{sena_response[:300]}...\n\n3ê°€ì§€ ê¸°ìˆ ì  ì ‘ê·¼ ë°©ë²•ì„ ì œì‹œí•´ì£¼ì„¸ìš”."
    rubit_response = query_persona("ë£¨ë¹—", rubit_prompt)
    results["personas"]["rubit"] = rubit_response
    print(f"   ì‘ë‹µ: {rubit_response[:100]}...")
    
    # 3ë‹¨ê³„: ë¹„ë…¸ìŠˆ - í†µí•© ê¶Œì¥ì•ˆ
    print("\n3ï¸âƒ£ ë¹„ë…¸ìŠˆ (ğŸ”®) - ìµœì¢… í†µí•© ê¶Œì¥ì•ˆ...")
    binoche_prompt = f"""
    {topic}ì— ëŒ€í•´:
    
    ì„¸ë‚˜ì˜ ë¶„ì„: {sena_response[:200]}...
    ë£¨ë¹—ì˜ ì œì•ˆ: {rubit_response[:200]}...
    
    ì´ ë‘ ê´€ì ì„ í†µí•©í•˜ì—¬ ìµœì¢… ê¶Œì¥ì•ˆì„ ì œì‹œí•´ì£¼ì„¸ìš”.
    """
    binoche_response = query_persona("ë¹„ë…¸ìŠˆ", binoche_prompt)
    results["personas"]["binoche"] = binoche_response
    print(f"   ì‘ë‹µ: {binoche_response[:100]}...")
    
    return results

def save_orchestration_result(results: Dict[str, Any]):
    """ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ ê²°ê³¼ ì €ì¥"""
    # JSONL ë¡œê·¸
    log_file = OUTPUT_DIR / "orchestration_log.jsonl"
    with open(log_file, 'a', encoding='utf-8') as f:
        f.write(json.dumps(results, ensure_ascii=False) + '\n')
    
    # ë§ˆí¬ë‹¤ìš´ ë¦¬í¬íŠ¸
    report_file = OUTPUT_DIR / "orchestration_latest.md"
    
    with open(report_file, 'w', encoding='utf-8') as f:
        f.write(f"""# ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ ë¦¬í¬íŠ¸

**ì£¼ì œ**: {results['topic']}
**ìƒì„± ì‹œê°**: {results['timestamp']}

---

## 1ï¸âƒ£ ì„¸ë‚˜ (âœ’ï¸) - í˜„ì¬ ìƒíƒœ ë¶„ì„

{results['personas'].get('sena', 'N/A')}

---

## 2ï¸âƒ£ ë£¨ë¹— (ğŸª¨) - ê¸°ìˆ ì  ì ‘ê·¼ ë°©ë²•

{results['personas'].get('rubit', 'N/A')}

---

## 3ï¸âƒ£ ë¹„ë…¸ìŠˆ (ğŸ”®) - ìµœì¢… í†µí•© ê¶Œì¥ì•ˆ

{results['personas'].get('binoche', 'N/A')}

---

*ì´ ë¦¬í¬íŠ¸ëŠ” ìë™í™”ëœ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ ì‹œìŠ¤í…œì— ì˜í•´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*
""")
    
    print(f"\nâœ… ê²°ê³¼ ì €ì¥:")
    print(f"   ë¡œê·¸: {log_file}")
    print(f"   ë¦¬í¬íŠ¸: {report_file}")

def main():
    import sys
    
    if len(sys.argv) < 2:
        print("\nì‚¬ìš©ë²•: python auto_orchestration.py '<ì£¼ì œ>'")
        print("\nì˜ˆì‹œ:")
        print("  python auto_orchestration.py 'AGI ì‹œìŠ¤í…œ ìµœì í™” ë°©ë²•'")
        print("  python auto_orchestration.py 'ë£¨ë©˜ í†µí•© ë‹¤ìŒ ë‹¨ê³„'")
        return
    
    topic = " ".join(sys.argv[1:])
    
    print("\nğŸ­ ìë™í™”ëœ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ ì‹œì‘")
    print("=" * 60)
    
    # ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ ì‹¤í–‰
    results = orchestrate_analysis(topic)
    
    # ê²°ê³¼ ì €ì¥
    save_orchestration_result(results)
    
    print("\n" + "=" * 60)
    print("ğŸŠ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ ì™„ë£Œ!\n")

if __name__ == "__main__":
    main()
