# Lumen Gateway v1.0 - Alertmanager Configuration
#
# Usage:
#   1. Install Alertmanager:
#      - Windows: Download from https://prometheus.io/download/
#      - Extract to: C:\prometheus\alertmanager\
#   2. Copy this file to: C:\prometheus\alertmanager\alertmanager.yml
#   3. Start Alertmanager: alertmanager --config.file=alertmanager.yml
#   4. Configure Prometheus to send alerts to: http://localhost:9093
#
# Environment Variables Required:
#   - SLACK_WEBHOOK_URL: Slack incoming webhook URL
#   - SMTP_PASSWORD: Email account password (if using email)

global:
  # How long to wait before sending a notification about new alert
  resolve_timeout: 5m

  # SMTP configuration (optional, comment out if not using email)
  smtp_smarthost: "smtp.gmail.com:587"
  smtp_from: "lumen-gateway@naeda-genesis.iam.gserviceaccount.com"
  smtp_auth_username: "your-email@gmail.com"
  smtp_auth_password: "${SMTP_PASSWORD}"
  smtp_require_tls: true

# Templates for custom notification formatting
templates:
  - "templates/*.tmpl"

# Route tree for alert dispatching
route:
  # Default receiver for all alerts
  receiver: "lumen-default"

  # How long to wait before sending notification about new alert
  group_wait: 10s

  # How long to wait before sending notification about new alerts
  # in an already-notified group
  group_interval: 10s

  # How long to wait before re-sending a notification
  repeat_interval: 12h

  # Group alerts by these labels
  group_by: ["alertname", "severity", "component"]

  # Child routes
  routes:
    # Critical alerts -> Slack + Email (if configured)
    - match:
        severity: critical
      receiver: "lumen-critical"
      group_wait: 5s
      repeat_interval: 1h
      continue: true # Also send to default receiver

    # Warning alerts -> Slack only
    - match:
        severity: warning
      receiver: "lumen-warnings"
      group_wait: 30s
      repeat_interval: 6h

    # Info alerts -> Log only (no notifications)
    - match:
        severity: info
      receiver: "lumen-info"
      group_wait: 5m
      repeat_interval: 24h

# Inhibition rules (suppress alerts based on other alerts)
inhibit_rules:
  # If ION API is down, suppress all other ION-related alerts
  - source_match:
      alertname: "IONAPIDown"
    target_match_re:
      alertname: "(MockModeDetected|LowConfidence|HighResponseTime|ModerateResponseTime)"
    equal: ["component"]

  # If Gateway is unlocked, suppress resonance alerts
  - source_match:
      alertname: "GatewayUnlocked"
    target_match_re:
      alertname: "(HighPhaseDiff|HighEntropyRate|HighRiskBand|LowCreativeBand)"
    equal: ["component"]

  # If metrics are stale, suppress all other alerts
  - source_match:
      alertname: "GatewayMetricsStale"
    target_match_re:
      alertname: ".*"
    equal: ["instance"]

# Receivers (notification destinations)
receivers:
  # ========================================
  # Default receiver (all alerts)
  # ========================================
  - name: "lumen-default"
    webhook_configs:
      - url: "http://localhost:9999/alertmanager-webhook"
        send_resolved: true

  # ========================================
  # Critical alerts receiver
  # ========================================
  - name: "lumen-critical"
    slack_configs:
      - api_url: "${SLACK_WEBHOOK_URL}"
        channel: "#lumen-alerts-critical"
        title: "üö® CRITICAL: {{ .GroupLabels.alertname }}"
        text: |
          *Alert:* {{ .GroupLabels.alertname }}
          *Severity:* {{ .CommonLabels.severity }}
          *Component:* {{ .CommonLabels.component }}
          *Team:* {{ .CommonLabels.team }}

          {{ range .Alerts }}
          *Description:*
          {{ .Annotations.description }}

          *Playbook:* {{ .Annotations.playbook }}
          {{ end }}
        color: "danger"
        send_resolved: true

    # Email notifications (optional)
    # Uncomment and configure if you want email alerts
    # email_configs:
    #   - to: 'oncall@your-company.com'
    #     subject: 'üö® CRITICAL: {{ .GroupLabels.alertname }}'
    #     html: |
    #       <h2>{{ .GroupLabels.alertname }}</h2>
    #       <p><strong>Severity:</strong> {{ .CommonLabels.severity }}</p>
    #       <p><strong>Component:</strong> {{ .CommonLabels.component }}</p>
    #       {{ range .Alerts }}
    #       <hr>
    #       <pre>{{ .Annotations.description }}</pre>
    #       {{ end }}
    #     send_resolved: true

  # ========================================
  # Warning alerts receiver
  # ========================================
  - name: "lumen-warnings"
    slack_configs:
      - api_url: "${SLACK_WEBHOOK_URL}"
        channel: "#lumen-alerts-warnings"
        title: "‚ö†Ô∏è WARNING: {{ .GroupLabels.alertname }}"
        text: |
          *Alert:* {{ .GroupLabels.alertname }}
          *Severity:* {{ .CommonLabels.severity }}
          *Component:* {{ .CommonLabels.component }}

          {{ range .Alerts }}
          *Summary:* {{ .Annotations.summary }}

          {{ .Annotations.description }}
          {{ end }}
        color: "warning"
        send_resolved: true

  # ========================================
  # Info alerts receiver (minimal notifications)
  # ========================================
  - name: "lumen-info"
    slack_configs:
      - api_url: "${SLACK_WEBHOOK_URL}"
        channel: "#lumen-alerts-info"
        title: "‚ÑπÔ∏è INFO: {{ .GroupLabels.alertname }}"
        text: |
          *Alert:* {{ .GroupLabels.alertname }}
          {{ range .Alerts }}
          {{ .Annotations.summary }}
          {{ end }}
        color: "good"
        send_resolved: false # Don't spam with resolved notifications
