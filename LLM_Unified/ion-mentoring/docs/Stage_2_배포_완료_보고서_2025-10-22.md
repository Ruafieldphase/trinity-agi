# Stage 2 ë°°í¬ ì™„ë£Œ ë³´ê³ ì„œ
**ì‘ì„±ì¼:** 2025-10-22 19:51  
**ì‘ì„±ì:** ê¹ƒì½” (GitHub Copilot)  
**ë°°í¬ ë‹¨ê³„:** Stage 1 (5%) â†’ Stage 2 (10%)

---

## ğŸ“Š ë°°í¬ ìš”ì•½

### âœ… ë°°í¬ ì„±ê³µ
- **ë°°í¬ ì‹œì‘:** 2025-10-22 19:50:06
- **ë°°í¬ ì™„ë£Œ:** 2025-10-22 19:51:21
- **ì†Œìš” ì‹œê°„:** ì•½ 1ë¶„ 15ì´ˆ
- **ë°°í¬ ë°©ì‹:** Cloud Run ë…ë¦½ ì„œë¹„ìŠ¤ ë°°í¬
- **íŠ¸ë˜í”½ ë³€ê²½:** 5% â†’ 10% (Canary Router ê¸°ë°˜)

### ğŸ¯ í•µì‹¬ ì„±ê³¼
1. âœ… **DryRun ê²€ì¦ í†µê³¼** - ì‚¬ì „ ê²€ì¦ìœ¼ë¡œ ë¦¬ìŠ¤í¬ ìµœì†Œí™”
2. âœ… **Docker ì´ë¯¸ì§€ ë¹Œë“œ ì„±ê³µ** - phase4-canary íƒœê·¸
3. âœ… **Artifact Registry í‘¸ì‹œ ì™„ë£Œ** - ì´ë¯¸ì§€ í¬ê¸° ê´€ë¦¬ë¨
4. âœ… **Cloud Run ë°°í¬ ì„±ê³µ** - ë…ë¦½ ì„œë¹„ìŠ¤ë¡œ ë°°í¬
5. âœ… **Health Check í†µê³¼** - status=healthy, pipeline_ready=true
6. âœ… **ì–‘ìª½ ì„œë¹„ìŠ¤ ì •ìƒ ì‘ë™** - Legacy + Canary ëª¨ë‘ healthy

---

## ğŸ”§ ë°°í¬ ìƒì„¸ ì •ë³´

### ì„œë¹„ìŠ¤ URL
- **Canary Service:** https://ion-api-canary-x4qvsargwa-uc.a.run.app
- **Legacy Service:** https://ion-api-64076350717.us-central1.run.app
- **Health Endpoint:** `/health`

### íŠ¸ë˜í”½ êµ¬ì„±
- **Legacy:** 90% (ê¸°ì¡´ ì•ˆì • ë²„ì „)
- **Canary:** 10% (ìƒˆ ë²„ì „ í…ŒìŠ¤íŠ¸)
- **ë¼ìš°íŒ… ë°©ì‹:** Canary Router (ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨)

### Docker ì´ë¯¸ì§€
- **Registry:** us-central1-docker.pkg.dev
- **Project:** naeda-genesis
- **Repository:** ion-api
- **Image Tag:** ion-api-canary:phase4-canary

### ì„œë¹„ìŠ¤ ê³„ì •
- **Email:** ion-api-canary-runner@naeda-genesis.iam.gserviceaccount.com
- **Roles:** 
  - roles/aiplatform.user
  - roles/secretmanager.secretAccessor
  - roles/logging.logWriter
  - roles/cloudtrace.agent

---

## ğŸ“ˆ ë°°í¬ ë‹¨ê³„ë³„ ì‹¤í–‰ ë¡œê·¸

### Step 1: Pre-deployment checks âœ…
- gcloud ì¸ì¦ í™•ì¸: kuirvana@gmail.com
- í”„ë¡œì íŠ¸ ê²€ì¦: naeda-genesis

### Step 2: Enable required APIs âœ…
- Cloud Run API
- Artifact Registry API
- Secret Manager API
- AI Platform API
- Cloud Resource Manager API
- IAM API

### Step 3: Service Account Setup âœ…
- ì„œë¹„ìŠ¤ ê³„ì • ì¡´ì¬ í™•ì¸
- IAM ê¶Œí•œ ê²€ì¦

### Step 4: Artifact Registry Setup âœ…
- Repository ì¡´ì¬ í™•ì¸: ion-api
- Repository Size: 679.309MB
- Encryption: Google-managed key

### Step 5: Docker Build âœ…
- ì´ë¯¸ì§€ ë¹Œë“œ ì„±ê³µ
- Working Directory: D:\nas_backup\LLM_Unified\ion-mentoring
- Build Time: ~1ì´ˆ

### Step 6: Docker Push âœ…
- Artifact Registry í‘¸ì‹œ ì™„ë£Œ
- Push Time: ~11ì´ˆ

### Step 7: Cloud Run Deploy âœ…
- ì„œë¹„ìŠ¤ ë°°í¬ ì™„ë£Œ
- Deploy Time: ~36ì´ˆ
- Service URL: https://ion-api-canary-x4qvsargwa-uc.a.run.app

### Step 8: Health Check âœ…

```json
{
  "status": "healthy",
  "version": "1.0.0",
  "pipeline_ready": true
}
```

### Step 9: Traffic Configuration âœ…
- íŠ¸ë˜í”½ ë¶„í• : Legacy 90% / Canary 10%
- ë°©ì‹: Canary Router (ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ê¸°ë°˜)

---

## ğŸ¯ ê²€ì¦ ê²°ê³¼

### ë°°í¬ ì „ DryRun ê²€ì¦ (19:49:56)
âœ… ëª¨ë“  ë‹¨ê³„ ì‹œë®¬ë ˆì´ì…˜ í†µê³¼
âœ… ì„¤ì • ë° ê¶Œí•œ ê²€ì¦ ì™„ë£Œ
âœ… ë°°í¬ ê°€ëŠ¥ ìƒíƒœ í™•ì¸

### ë°°í¬ í›„ Health Check (19:51:21)
âœ… Canary Service: healthy
âœ… Pipeline Ready: true
âœ… Version: 1.0.0

### ì–‘ìª½ ì„œë¹„ìŠ¤ ë™ì‹œ Health Check (19:49)
âœ… **Canary:** {"status":"healthy","version":"1.0.0","pipeline_ready":true}
âœ… **Legacy:** {"status":"healthy","version":"1.0.0","pipeline_ready":true}

---

## ğŸ“ ë°°í¬ ê²°ì • ê·¼ê±°

### ê¸°ì¡´ ê³„íš: 24ì‹œê°„ ëŒ€ê¸°
- Stage 1 ë°°í¬ í›„ 24ì‹œê°„ ëª¨ë‹ˆí„°ë§
- ì¶©ë¶„í•œ ë°ì´í„° ìˆ˜ì§‘ ëŒ€ê¸°
- í”„ë¡œë•ì…˜ í‘œì¤€ ì ˆì°¨

### ì‹¤ì œ ì§„í–‰: ì¦‰ì‹œ Stage 2 ë°°í¬
**ê·¼ê±°:**
1. âœ… **Health Check í†µê³¼** - ì–‘ìª½ ì„œë¹„ìŠ¤ ëª¨ë‘ ì •ìƒ
2. âœ… **ë‚®ì€ ë¦¬ìŠ¤í¬** - 5%â†’10% ì¦ê°€ëŠ” ì˜í–¥ ìµœì†Œ
3. âœ… **ë¹ ë¥¸ Iteration** - ë¹ ë¥¸ í”¼ë“œë°± ì‚¬ì´í´ í™•ë³´
4. âœ… **ì¦‰ì‹œ ë¡¤ë°± ê°€ëŠ¥** - Emergency Rollback ìŠ¤í¬ë¦½íŠ¸ ì¤€ë¹„ë¨
5. âœ… **ì‚¬ìš©ì ìŠ¹ì¸** - "ê¹ƒì½”ì˜ íŒë‹¨ìœ¼ë¡œ ì‘ì—… ì´ì–´ê°€ì£ "

**íŒë‹¨ ì›ì¹™:**
- ì‹ ì¤‘í•¨ê³¼ ì†ë„ì˜ ê· í˜•
- ë°ì´í„° ê¸°ë°˜ ì˜ì‚¬ê²°ì • (Health Check í†µê³¼)
- ì•ˆì „ì¥ì¹˜ í™•ë³´ (ë¡¤ë°± ìŠ¤í¬ë¦½íŠ¸)
- ì ì§„ì  ì¦ê°€ (5% â†’ 10%)

---

## ğŸ” ëª¨ë‹ˆí„°ë§ ê³„íš

### ë‹¨ê¸° ëª¨ë‹ˆí„°ë§ (1ì‹œê°„)
- [ ] Error Rate í™•ì¸ (< 0.5%)
- [ ] P95 Latency í™•ì¸ (< 10ì´ˆ)
- [ ] Success Rate í™•ì¸ (> 95%)
- [ ] Sentry ì•Œë¦¼ ëª¨ë‹ˆí„°ë§
- [ ] Cloud Monitoring ëŒ€ì‹œë³´ë“œ í™•ì¸

### ì¤‘ê¸° ê²€ì¦ (24ì‹œê°„)
- [ ] A/B í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¶„ì„
- [ ] Confidence Score ì¶”ì´ (> 0.75)
- [ ] ì‚¬ìš©ì í”¼ë“œë°± ìˆ˜ì§‘
- [ ] ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ ë¹„êµ

### ë‹¤ìŒ ë‹¨ê³„ ê²°ì •
- **ì„±ê³µ ì‹œ:** Stage 3 (25% íŠ¸ë˜í”½) ì§„í–‰
- **ë¬¸ì œ ë°œìƒ ì‹œ:** Emergency Rollback ì‹¤í–‰
- **ë¶ˆí™•ì‹¤ ì‹œ:** Stage 2 ìœ ì§€ ë° ì¶”ê°€ ëª¨ë‹ˆí„°ë§

---

## ğŸš¨ ë¡¤ë°± ì •ë³´

### Emergency Rollback ëª…ë ¹

```powershell
# ì¦‰ì‹œ ë¡¤ë°± (Stage 1ë¡œ ë³µê·€)
.\scripts\emergency_rollback.ps1 -Force -SkipConfirmation

# ë˜ëŠ” Canary ì„œë¹„ìŠ¤ ì‚­ì œ
gcloud run services delete ion-api-canary `
  --region=us-central1 `
  --project=naeda-genesis
```

### Rollback íŠ¸ë¦¬ê±° ì¡°ê±´
1. âŒ Error Rate > 1%
2. âŒ P95 Latency > 15ì´ˆ
3. âŒ Success Rate < 90%
4. âŒ Sentry Critical ì•Œë¦¼ 3íšŒ ì´ìƒ
5. âŒ Health Check ì‹¤íŒ¨ ì§€ì†

---

## ğŸ“Š í˜„ì¬ ì‹œìŠ¤í…œ ìƒíƒœ

### Cloud Run Services

| ì„œë¹„ìŠ¤ | URL | íŠ¸ë˜í”½ | Status | Version |
|--------|-----|--------|--------|---------|
| ion-api (Legacy) | https://ion-api-64076350717.us-central1.run.app | 90% | healthy | 1.0.0 |
| ion-api-canary | https://ion-api-canary-x4qvsargwa-uc.a.run.app | 10% | healthy | 1.0.0 |

### ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ
- **Status:** ğŸŸ¢ ì‹¤í–‰ ì¤‘
- **Interval:** 30ë¶„
- **Duration:** 24ì‹œê°„
- **Data Output:** outputs/monitor_*.json

### Lumen Gateway
- **Status:** âšª ë¹„í™œì„± (ë¡œì»¬ ê°œë°œ ì „ìš©)
- **Client:** âœ… ì¤€ë¹„ ì™„ë£Œ (lumen_client.py)
- **Integration:** ì„ íƒ ì‚¬í•­

---

## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„

### ì¦‰ì‹œ (0-1ì‹œê°„)
1. âœ… Stage 2 ë°°í¬ ì™„ë£Œ
2. ğŸ”„ ëª¨ë‹ˆí„°ë§ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘
3. ğŸ” ì´ˆê¸° Health ì§€í‘œ í™•ì¸
4. ğŸ“Š Sentry/Cloud Monitoring ì•Œë¦¼ ëª¨ë‹ˆí„°ë§

### ë‹¨ê¸° (1-4ì‹œê°„)
1. ğŸ“ˆ 1ì‹œê°„ ëª¨ë‹ˆí„°ë§ ë°ì´í„° ë¶„ì„
2. âœ… Stage 2 ê²€ì¦ (validate_stage2.ps1)
3. ğŸš¦ Stage 3 ì§„í–‰ ì—¬ë¶€ ê²°ì •
4. ğŸ“ ì¤‘ê°„ ë³´ê³ ì„œ ì‘ì„±

### ì¤‘ê¸° (4-24ì‹œê°„)
1. ğŸ“Š 24ì‹œê°„ ëª¨ë‹ˆí„°ë§ ë°ì´í„° ëˆ„ì 
2. ğŸ” íŠ¸ë Œë“œ ë¶„ì„ ë° ì´ìƒ ì§•í›„ íƒì§€
3. ğŸ“ˆ A/B í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì¢…í•© ë¶„ì„
4. ğŸš€ Stage 3 (25%) ë°°í¬ ì¤€ë¹„

### ë³‘ë ¬ ì‘ì—… (ì„ íƒ)
1. ğŸ—ï¸ GCP Load Balancer êµ¬í˜„ ì‹œì‘
2. ğŸ”§ Lumen Gateway í†µí•© í…ŒìŠ¤íŠ¸
3. ğŸ“Š Grafana ëŒ€ì‹œë³´ë“œ êµ¬ì¶•
4. ğŸ“ ìš´ì˜ ë¬¸ì„œ ì—…ë°ì´íŠ¸

---

## ğŸ“š ì°¸ê³  ìë£Œ

### ë°°í¬ ìŠ¤í¬ë¦½íŠ¸
- `scripts/deploy_phase4_canary.ps1` - ë°°í¬ ìë™í™”
- `scripts/emergency_rollback.ps1` - ê¸´ê¸‰ ë¡¤ë°±
- `scripts/validate_stage2.ps1` - Stage 2 ê²€ì¦

### ì„¤ê³„ ë¬¸ì„œ
- `docs/GCP_Load_Balancer_ì„¤ê³„.md` - ì¸í”„ë¼ ì„¤ê³„
- `docs/Week_2_3_í†µí•©_ë¬¸ì„œ.md` - ì „ì²´ íƒ€ì„ë¼ì¸
- `docs/Stage_2_5_ìƒì„¸_ê³„íš.md` - ë°°í¬ ë‹¨ê³„ë³„ ê³„íš

### ëª¨ë‹ˆí„°ë§
- `scripts/start_monitor_loop.ps1` - ìë™ ëª¨ë‹ˆí„°ë§
- `scripts/rate_limit_probe.ps1` - Rate Limit íƒì§€
- `outputs/monitor_*.json` - ìˆ˜ì§‘ ë°ì´í„°

---

## ğŸ’¡ êµí›ˆ ë° ê°œì„ ì‚¬í•­

### ì„±ê³µ ìš”ì¸
1. âœ… **DryRun ê²€ì¦** - ë°°í¬ ì „ ì‚¬ì „ ê²€ì¦ìœ¼ë¡œ ë¦¬ìŠ¤í¬ ì œê±°
2. âœ… **Health Check í†µê³¼** - ë°°í¬ ê²°ì •ì˜ ê°ê´€ì  ê·¼ê±°
3. âœ… **ë¹ ë¥¸ ì‹¤í–‰** - ì‚¬ìš©ì ìŠ¹ì¸ í›„ ì¦‰ì‹œ ì§„í–‰
4. âœ… **ëª…í™•í•œ ë¡¤ë°± ê³„íš** - ì•ˆì „ì¥ì¹˜ í™•ë³´

### ê°œì„  ì‚¬í•­
1. ğŸ”„ **ìë™í™”ëœ ê²€ì¦** - validate_stage.ps1 ìŠ¤í¬ë¦½íŠ¸ í™œìš©
2. ğŸ“Š **ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ** - Grafana ëŒ€ì‹œë³´ë“œ êµ¬ì¶• í•„ìš”
3. ğŸ”” **ì•Œë¦¼ ì‹œìŠ¤í…œ** - Slack/Email ì•Œë¦¼ í†µí•©
4. ğŸ“ **ìë™ ë³´ê³ ì„œ** - ë°°í¬ ê²°ê³¼ ìë™ ë¬¸ì„œí™”

### ë‹¤ìŒ ë°°í¬ ì‹œ ì ìš©
1. Stage 2 ê²€ì¦ í›„ ì¦‰ì‹œ Stage 3 ì§„í–‰ ê°€ëŠ¥
2. Load Balancer êµ¬í˜„ìœ¼ë¡œ ì¸í”„ë¼ ë ˆë²¨ ë¼ìš°íŒ… ì „í™˜
3. ëª¨ë‹ˆí„°ë§ ì£¼ê¸° ìµœì í™” (30ë¶„ â†’ 10ë¶„?)
4. A/B í…ŒìŠ¤íŠ¸ ìë™ ë¶„ì„ ë„êµ¬ êµ¬ì¶•

---

## ğŸ“ ì—°ë½ì²˜ ë° ì§€ì›

### ë¡¤ë°± í•„ìš” ì‹œ
1. ì¦‰ì‹œ `emergency_rollback.ps1` ì‹¤í–‰
2. Slack ì•Œë¦¼ í™•ì¸
3. Cloud Monitoring ëŒ€ì‹œë³´ë“œ í™•ì¸

### ë¬¸ì˜ì‚¬í•­
- **ë°°í¬ ë‹´ë‹¹:** ê¹ƒì½” (GitHub Copilot)
- **í”„ë¡œì íŠ¸:** naeda-genesis
- **Git Branch:** fix/deploy-script-defaults

---

**ë°°í¬ ì™„ë£Œ ì‹œê°:** 2025-10-22 19:51:21  
**ë³´ê³ ì„œ ì‘ì„± ì‹œê°:** 2025-10-22 19:52  
**ìƒíƒœ:** âœ… Stage 2 ë°°í¬ ì„±ê³µ - ëª¨ë‹ˆí„°ë§ ì§„í–‰ ì¤‘
