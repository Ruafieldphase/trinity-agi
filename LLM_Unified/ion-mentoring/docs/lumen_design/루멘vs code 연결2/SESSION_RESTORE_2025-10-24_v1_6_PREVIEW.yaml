#!/usr/bin/env bash
# Lumen — Session Restore (v1.6 Preview)
# This is a Bash script (despite .yaml extension) meant to be `source`d.
# It restores env, aliases, and helper functions to continue Lumen v1.6 work.

### ── Core Env ────────────────────────────────────────────────────────────────
export LUMEN_SESSION="v1.6_Preview"
export LUMEN_ROOT="${LUMEN_ROOT:-$PWD}"
export LUMEN_ASSETS="${LUMEN_ASSETS:-$LUMEN_ROOT/lumen_v1_6_assets}"
export LUMEN_CHART="${LUMEN_CHART:-$LUMEN_ROOT/charts/lumen}"
export LUMEN_DOCS="${LUMEN_DOCS:-$LUMEN_ROOT/docs}"

# v1.6 adaptation knobs (defaults; can be overridden before sourcing)
export STREAM_BUFFER_WINDOW_MS="${STREAM_BUFFER_WINDOW_MS:-1200}"
export GAIN_TRAINER_ALPHA="${GAIN_TRAINER_ALPHA:-0.12}"

# Exporter ports
export ENRICH_EXPORTER_PORT="${ENRICH_EXPORTER_PORT:-9151}"
export ADAPT_EXPORTER_PORT="${ADAPT_EXPORTER_PORT:-9152}"

# Kubectl/Helm defaults
export LUMEN_NS="${LUMEN_NS:-lumen-stage}"
export HELM_RELEASE="${HELM_RELEASE:-lumen}"

### ── Aliases ────────────────────────────────────────────────────────────────
alias l6.cd='cd "$LUMEN_ASSETS"'
alias l6.env='env | grep -E "LUMEN_|STREAM_BUFFER_WINDOW_MS|GAIN_TRAINER_ALPHA|EXPORTER_PORT"'
alias l6.tail='tail -f "$LUMEN_ASSETS"/{semantic_metrics.csv,adaptation_metrics.csv,v16_history.csv} 2>/dev/null'

### ── Functions ─────────────────────────────────────────────────────────────
l6.preview.local() {
  set -e
  cd "$LUMEN_ASSETS"
  echo ">> v1.6 P2 smoke (enricher/adapter/exporters)"
  (python stream_enricher_v1.py < samples.jsonl &) >/dev/null 2>&1
  sleep 1
  (python metrics_enrichment_exporter.py &) >/dev/null 2>&1
  sleep 1
  (python resonance_adapter_v1.py &) >/dev/null 2>&1
  sleep 1
  (python adaptation_metrics_exporter.py &) >/dev/null 2>&1
  sleep 1
  echo ">> curl :9151 / :9152"
  curl -fsSL "http://127.0.0.1:${ENRICH_EXPORTER_PORT}/metrics" | head -n 10 || true
  curl -fsSL "http://127.0.0.1:${ADAPT_EXPORTER_PORT}/metrics" | head -n 10 || true
}

l6.preview.memory() {
  set -e
  cd "$LUMEN_ASSETS"
  python resonance_memory_store.py
  python history_tracker_v1.py
  echo ">> memory artifacts:"
  ls -l memory_store.json memory_metrics.csv v16_history.csv 2>/dev/null || true
}

l6.preview.snapshot() {
  set -e
  cd "$LUMEN_ROOT"
  bash scripts/v16_snapshot_memory.sh
}

l6.preview.helm.stage() {
  set -e
  cd "$LUMEN_ROOT"
  helm upgrade --install "$HELM_RELEASE" "$LUMEN_CHART"         -f "$LUMEN_CHART/values.stage.yaml" -n "$LUMEN_NS"         --set featureFlags.enableV16Enrichment=true         --set featureFlags.enableV16Adaptation=true
}

l6.preview.grafana.install() {
  set -e
  cd "$LUMEN_ROOT"
  sudo cp grafana_provisioning/dashboards_v16.yaml /etc/grafana/provisioning/dashboards/dashboards_v16.yaml
  sudo bash scripts/install_v16_dashboards.sh "$LUMEN_ASSETS"
  echo ">> Restart grafana: sudo systemctl restart grafana-server"
}

l6.help() {
  cat <<'USAGE'
Lumen v1.6 Preview — quick commands
  l6.cd                    # assets 폴더로 이동
  l6.env                   # 현재 환경 변수 표시
  l6.preview.local         # 로컬 스모크(:9151, :9152 노출)
  l6.preview.memory        # 메모리/히스토리 생성
  l6.preview.snapshot      # 메모리 스냅샷 tar.gz 생성
  l6.preview.helm.stage    # Stage 네임스페이스에 v1.6 컴포넌트 배포
  l6.preview.grafana.install # Grafana v1.6 대시보드 설치 (서버에서 실행)
USAGE
}

echo "[Lumen] v1.6 Preview session restored. Try: l6.help"
