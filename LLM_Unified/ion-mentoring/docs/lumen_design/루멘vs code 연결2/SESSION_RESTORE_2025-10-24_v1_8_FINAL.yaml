#!/usr/bin/env bash
# Lumen — Session Restore (v1.8 Final)
export LUMEN_SESSION="v1.8_Final"
export LUMEN_ROOT="${LUMEN_ROOT:-$PWD}"
export LUMEN_V16="${LUMEN_V16:-$LUMEN_ROOT/lumen_v1_6_assets}"
export LUMEN_V17="${LUMEN_V17:-$LUMEN_ROOT/lumen_v1_7_assets}"
export LUMEN_V18="${LUMEN_V18:-$LUMEN_ROOT/lumen_v1_8_assets}"

l8.full.run() {
  set -e
  # 1) Analyzer → Policy
  (cd "$LUMEN_V18" && python ledger_analyzer_v18.py)
  # 2) Export policy
  (cd "$LUMEN_V18" && (python policy_trace_exporter_v18.py &) && sleep 1)
  # 3) Start stacks
  (cd "$LUMEN_V16" && (python stream_enricher_v1.py < samples.jsonl &) && sleep 1 && (python metrics_enrichment_exporter.py &) && sleep 1 && (python resonance_adapter_v1_native_matrix.py &) && sleep 2 && (python adaptation_metrics_exporter.py &) && sleep 1)
  (cd "$LUMEN_V17" && (python metrics_feedback_graph_exporter.py &) && sleep 1)
  # 4) Adaptive gate
  (cd "$LUMEN_V18" && python v18_gate_runner.py --metrics http://127.0.0.1:9153/metrics) || {     echo ">> Gate FAILED — rollback";     (cd "$LUMEN_V17" && python v17_gate_rollback.py --state-file "$LUMEN_V16/adaptation_state.json" --window 1200 --alpha 0.12);     return 2;   }
  # 5) Ledger ingest
  (cd "$LUMEN_V17" && python ledger_v17_ingestor.py && ls -lh ledger_v17.db)
  echo ">> v1.8 full loop PASS"
}

echo "[Lumen] v1.8 Final session restored. Run: l8.full.run"
