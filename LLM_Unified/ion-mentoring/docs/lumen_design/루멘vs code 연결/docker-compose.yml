
version: "3.9"
services:
  alertmanager:
    image: prom/alertmanager:latest
    container_name: alertmanager
    ports: ['9093:9093']
    volumes:
      - ./provisioning/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - ./provisioning/alertmanager/alertmanager_slack_url:/etc/alertmanager/alertmanager_slack_url:ro
      - ./provisioning/alertmanager/templates:/etc/alertmanager/templates:ro
    command: ['--config.file=/etc/alertmanager/alertmanager.yml']
    restart: unless-stopped

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports: ["9090:9090"]
    volumes:
      - ./provisioning/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./provisioning/prometheus/rules:/etc/prometheus/rules:ro
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports: ["3000:3000"]
    environment:
      - GF_PATHS_PROVISIONING=/etc/grafana/provisioning
    volumes:
      - ./provisioning/grafana/datasources:/etc/grafana/provisioning/datasources:ro
      - ./provisioning/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./grafana:/var/lib/grafana/dashboards:ro
    depends_on:
      - prometheus
    restart: unless-stopped

  fractal-exporter:
    build:
      context: .
      dockerfile: Dockerfile.fractal_exporter
    container_name: fractal-exporter
    ports: ["9109:9109"]
    volumes:
      - ./:/app
    restart: unless-stopped

  fractal-sync-scheduler:
    image: python:3.11-slim
    container_name: fractal-sync-scheduler
    volumes:
      - ./:/app
    working_dir: /app
    command: >
      bash -lc 'while true; do
        python fractal_sync_bus.py || true;
        python fractal_charts.py || true;
        sleep ${SYNC_INTERVAL:-60};
      done'
    environment:
      - SYNC_INTERVAL=60
    depends_on:
      - fractal-exporter
    restart: unless-stopped
