# BQI Phase 5: User Feedback Prediction

**목표**: AGI가 BQI 좌표를 통해 사용자의 피드백을 예측하고 응답을 사전 조정합니다.

## 핵심 아이디어

레전드의 과거 데이터에서 **BQI 좌표와 사용자 만족도의 상관관계**를 학습:

```text
BQI 좌표 → 사용자 만족도
(priority=4, emotion=['urgent'], rhythm='debug') → quality=0.65 (낮음)
(priority=2, emotion=['curiosity'], rhythm='reflection') → quality=0.92 (높음)
```

응답 생성 전 만족도를 예측하여 **낮은 만족도가 예상되면 응답을 조정**합니다.

## 학습 데이터 소스

### Ledger의 피드백 시그널

| 시그널 | 의미 | 가중치 |
|--------|------|--------|
| `quality` | 사용자 만족도 직접 지표 | 1.0 |
| `second_pass` | 2차 패스 발동 (품질 불만족) | -0.3 |
| `confidence` < 0.6 | AGI 자신감 낮음 | -0.1 |
| `evidence_ok` | 증거 충분성 | +0.05 |

### 만족도 계산 예시

```python
satisfaction = quality
if had_second_pass:
    satisfaction *= 0.7  # 페널티
if confidence < 0.6:
    satisfaction *= 0.9  # 페널티
```

## 아키텍처

```text
┌────────────────────────────────────────────────────┐
│ UserFeedbackPredictor                              │
├────────────────────────────────────────────────────┤
│ learn_from_ledger()                                │
│  └─> BQI 패턴별 평균 만족도 학습                   │
│                                                    │
│ predict_satisfaction(bqi_coord, response_draft)    │
│  ├─> BQI 패턴으로 만족도 예측 (0.0-1.0)           │
│  └─> 만족도 < 0.6 시 조정 힌트 반환               │
│      ["reduce_priority", "add_empathy", ...]      │
└────────────────────────────────────────────────────┘
```

## 통합 포인트

### Pipeline에 통합 (Phase 5)

```python
# 1. 응답 생성 전 만족도 예측
predictor = UserFeedbackPredictor()
predicted_satisfaction, hints = predictor.predict_satisfaction(
    bqi_coord=self.bqi_coord,
    response_draft=initial_response
)

# 2. 낮은 만족도 시 조정
if predicted_satisfaction < 0.6:
    if "add_empathy" in hints:
        response = add_empathy_layer(initial_response)
    if "reduce_priority" in hints:
        self.bqi_coord['priority'] = max(1, self.bqi_coord['priority'] - 1)
        # RAG 재실행 (덜 긴급한 문서 가중치)
    if "add_explanation" in hints:
        response = add_detailed_explanation(initial_response)
```

### 조정 전략

| Hint | 조정 방법 |
|------|----------|
| `reduce_priority` | BQI priority 낮춤 (4→3), RAG 재실행 |
| `add_empathy` | "이해합니다", "공감합니다" 같은 표현 추가 |
| `add_explanation` | 기술적 근거, 예시 추가 |
| `simplify_language` | 전문용어 제거, 쉬운 설명 |

## 사용법

### 1단계: 학습 실행

```powershell
# 레전드에서 BQI→만족도 패턴 학습
cd d:\nas_backup\fdo_agi_repo
.\.venv\Scripts\python.exe scripts\rune\feedback_predictor.py

# 출력 예시:
# [Feedback] Learned from 267 tasks, 189 samples
# [Feedback] Generated 34 BQI patterns
# 
# [Low Satisfaction Patterns]
#   p4_e:urgent,concern_r:debug: 0.58
#     Adjustments: reduce_priority, add_empathy
```

### 2단계: 모델 확인

```powershell
# 생성된 모델 JSON 확인
code d:\nas_backup\fdo_agi_repo\outputs\feedback_prediction_model.json
```

모델 구조:

```json
{
  "version": "1.0.0",
  "last_updated": "2025-10-29T...",
  "samples_count": 189,
  "satisfaction_by_bqi": {
    "p4_e:urgent_r:debug": {
      "mean": 0.58,
      "stdev": 0.12,
      "count": 12
    },
    "p2_e:curiosity_r:reflection": {
      "mean": 0.92,
      "stdev": 0.05,
      "count": 23
    }
  },
  "adjustment_rules": [
    {
      "pattern": "p4_e:urgent_r:debug",
      "mean_satisfaction": 0.58,
      "adjustments": ["reduce_priority", "add_empathy"]
    }
  ]
}
```

### 3단계: Python에서 예측

```python
from scripts.rune.feedback_predictor import UserFeedbackPredictor

predictor = UserFeedbackPredictor()

# 예측
bqi_coord = {"priority": 4, "emotion": ["urgent"], "rhythm": "debug"}
response = "에러가 발생했습니다. 로그를 확인하세요."

satisfaction, hints = predictor.predict_satisfaction(bqi_coord, response)
print(f"Predicted Satisfaction: {satisfaction:.2f}")
print(f"Adjustment Hints: {hints}")

# 출력:
# Predicted Satisfaction: 0.58
# Adjustment Hints: ['reduce_priority', 'add_empathy']
```

## VS Code Tasks

```json
{
  "label": "🤖 BQI: Learn Feedback Patterns",
  "type": "shell",
  "command": "powershell",
  "args": [
    "-NoProfile", "-ExecutionPolicy", "Bypass", "-Command",
    "cd d:\\nas_backup\\fdo_agi_repo; .venv\\Scripts\\python.exe scripts\\rune\\feedback_predictor.py"
  ]
},
{
  "label": "🤖 BQI: Open Feedback Model",
  "type": "shell",
  "command": "powershell",
  "args": [
    "-NoProfile", "-ExecutionPolicy", "Bypass", "-Command",
    "code d:\\nas_backup\\fdo_agi_repo\\outputs\\feedback_prediction_model.json"
  ]
}
```

## 일일 자동화

Phase 4 learner와 함께 실행:

```powershell
# scripts/run_bqi_learner.ps1에 추가
& "$RepoRoot\.venv\Scripts\python.exe" "$RepoRoot\scripts\rune\feedback_predictor.py"
if ($LASTEXITCODE -ne 0) {
    Write-Host "[BQI] Feedback predictor failed: exit $LASTEXITCODE" -ForegroundColor Red
}
```

## 성과 지표

### Phase 5 성공 메트릭

| 메트릭 | 목표 | 측정 방법 |
|--------|------|-----------|
| 예측 정확도 | RMSE < 0.15 | 예측 vs 실제 만족도 비교 |
| 2차 패스 감소율 | -20% | second_pass 이벤트 빈도 |
| 평균 만족도 향상 | +10% | quality 평균 증가 |
| False Positive Rate | < 15% | 잘못된 조정 비율 |

### 검증 방법

```python
# 학습 데이터와 테스트 데이터 분리 (8:2)
train_tasks = tasks[:int(len(tasks) * 0.8)]
test_tasks = tasks[int(len(tasks) * 0.8):]

# 모델 학습
predictor.learn_from_ledger(train_tasks)

# 테스트 세트에서 예측
predictions = []
actuals = []
for task in test_tasks:
    predicted, _ = predictor.predict_satisfaction(task.bqi_coord, task.response)
    actual = task.quality
    predictions.append(predicted)
    actuals.append(actual)

# RMSE 계산
rmse = sqrt(mean((predicted - actual)^2))
print(f"RMSE: {rmse:.3f}")
```

## 다음 단계

### Phase 5a: 기본 예측 (1주)

- [x] `feedback_predictor.py` 구현
- [ ] Ledger 분석 → BQI 패턴 추출
- [ ] 만족도 예측 모델 생성
- [ ] VS Code Tasks 통합

### Phase 5b: Pipeline 통합 (1주)

- [ ] `Pipeline.run()` 수정: 응답 전 예측 추가
- [ ] 조정 로직 구현 (empathy layer, explanation adder)
- [ ] A/B 테스트: 조정 유무 비교

### Phase 5c: 고도화 (1개월)

- [ ] 머신러닝 모델 적용 (scikit-learn LinearRegression)
- [ ] 다중 피처 활용 (BQI + 응답 길이 + 키워드 + 시간대)
- [ ] 온라인 학습 (실시간 피드백 반영)

## 기대 효과

1. **사용자 만족도 향상**:
   - 낮은 만족도 예상 시 사전 조정
   - 2차 패스 발동 빈도 감소

2. **AGI 자기 개선**:
   - 과거 실패 패턴 학습
   - 반복 실수 자동 방지

3. **운영 비용 절감**:
   - LLM 재실행 (2차 패스) 감소
   - 토큰 사용량 최적화

4. **개인화**:
   - 사용자별 선호 패턴 학습 가능
   - BQI 좌표 자동 튜닝

## 주의사항

### 과적합 방지

- 최소 샘플 수: 패턴당 5개 이상
- Cross-validation으로 일반화 성능 검증

### 윤리적 고려

- 조정이 **명확한 정보 왜곡**이 되어서는 안 됨
- 투명성 유지: 조정 사실 로그 기록

### 한계

- 초기에는 데이터 부족으로 휴리스틱에 의존
- 사용자 피드백 시그널이 명확하지 않은 경우 한계

---

**Phase 5는 BQI 시스템을 단순한 검색 최적화 도구에서 사용자 경험 예측/개인화 엔진으로 진화시킵니다.**
