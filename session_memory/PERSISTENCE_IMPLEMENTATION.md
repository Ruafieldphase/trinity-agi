# ë°ì´í„° ì˜ì†ì„± ë ˆì´ì–´ êµ¬í˜„ (Priority 5 - Phase 3)

## ê°œìš”

Agent Systemì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì˜ì†ì ìœ¼ë¡œ ì €ì¥í•˜ê³  ê´€ë¦¬í•˜ëŠ” ì™„ì „í•œ ë°ì´í„° ì˜ì†ì„± ë ˆì´ì–´ë¥¼ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

## êµ¬í˜„ íŒŒì¼

### 1. database_models.py (~700 ì¤„)
**ORM ë°ì´í„° ëª¨ë¸ ë° ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬**

#### ì£¼ìš” ê¸°ëŠ¥:
- **11ê°œì˜ SQLAlchemy ORM ëª¨ë¸ ì •ì˜**:
  - `Agent`: ì—ì´ì „íŠ¸ ì •ë³´ ë° ë©”íƒ€ë°ì´í„°
  - `Task`: ì‘ì—… ì •ë³´ ë° ì‹¤í–‰ ìƒíƒœ
  - `SubTask`: ë¶€ë¶„ ì‘ì—… ì •ë³´
  - `TaskDependency`: ì‘ì—… ê°„ ì˜ì¡´ì„±
  - `Message`: ì—ì´ì „íŠ¸ ê°„ ë©”ì‹œì§€
  - `HealthRecord`: í—¬ìŠ¤ ì²´í¬ ê¸°ë¡
  - `AgentMetrics`: ì—ì´ì „íŠ¸ë³„ ì„±ëŠ¥ ë©”íŠ¸ë¦­
  - `SystemMetrics`: ì‹œìŠ¤í…œ ì „ì²´ ë©”íŠ¸ë¦­
  - `Workflow`: ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ê¸°ë¡
  - `MigrationVersion`: ë§ˆì´ê·¸ë ˆì´ì…˜ ë²„ì „ ì¶”ì  (database_migration.py)
  - `Agent`: ì—ì´ì „íŠ¸ ì •ë³´

- **3ê°œì˜ ì €ì¥ì†Œ í´ë˜ìŠ¤**:
  - `AgentRepository`: ì—ì´ì „íŠ¸ CRUD ì‘ì—…
  - `TaskRepository`: ì‘ì—… CRUD ë° ìƒíƒœ ê´€ë¦¬
  - `MessageRepository`: ë©”ì‹œì§€ CRUD ë° ì¡°íšŒ

- **DatabaseManager í´ë˜ìŠ¤**:
  - SQLite ë° PostgreSQL ì§€ì›
  - ì¸ë©”ëª¨ë¦¬ DB (í…ŒìŠ¤íŠ¸ìš©)
  - ìë™ í…Œì´ë¸” ìƒì„±
  - ì„¸ì…˜ ê´€ë¦¬

#### ë°ì´í„° ëª¨ë¸ ê´€ê³„:
```
Agent (1) â”€â”€â”€â”€ (M) Task
    â”‚               â”‚
    â”‚               â”œâ”€â”€â”€ (M) SubTask
    â”‚               â””â”€â”€â”€ (M) TaskDependency
    â”‚
    â”œâ”€ (M) Message (from)
    â”œâ”€ (M) Message (to)
    â”œâ”€ (M) HealthRecord
    â””â”€ (M) AgentMetrics

Workflow (1) â”€â”€â”€â”€ (M) Task

Message (M) â”€â”€â”€â”€â”€â”€ (1) Agent (from)
        â””â”€â”€â”€â”€â”€â”€ (1) Agent (to)
```

#### í…ŒìŠ¤íŠ¸ ê²°ê³¼:
```
âœ“ 4ê°œ ì—ì´ì „íŠ¸ ìƒì„±
âœ“ 2ê°œ ì‘ì—… ìƒì„±
âœ“ ì‘ì—… ìƒíƒœ ì—…ë°ì´íŠ¸
âœ“ 1ê°œ ë©”ì‹œì§€ ìƒì„±
âœ“ í—¬ìŠ¤ ì²´í¬ ê¸°ë¡
âœ“ ì—ì´ì „íŠ¸ ë©”íŠ¸ë¦­ ê¸°ë¡
âœ“ ì €ì¥ëœ ë°ì´í„° ì¡°íšŒ
```

---

### 2. database_migration.py (~500 ì¤„)
**ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œìŠ¤í…œ**

#### ì£¼ìš” ê¸°ëŠ¥:
- **ë§ˆì´ê·¸ë ˆì´ì…˜ ë²„ì „ ê´€ë¦¬**:
  - v1: ì´ˆê¸° ìŠ¤í‚¤ë§ˆ ìƒì„±
  - v2: ìì£¼ ê²€ìƒ‰ë˜ëŠ” ì»¬ëŸ¼ì— ì¸ë±ìŠ¤ ì¶”ê°€
  - v3: ì¶”ê°€ ì»¬ëŸ¼ ì†ì„± ë° ë©”íƒ€ë°ì´í„°

- **MigrationManager í´ë˜ìŠ¤**:
  - ìë™ ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš©
  - ë§ˆì´ê·¸ë ˆì´ì…˜ ì—…ê·¸ë ˆì´ë“œ/ë‹¤ìš´ê·¸ë ˆì´ë“œ
  - ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ ì¶”ì 
  - ë§ˆì´ê·¸ë ˆì´ì…˜ ì´ë ¥ ê´€ë¦¬

- **Migration ì¶”ìƒ í´ë˜ìŠ¤**:
  - up(): ë§ˆì´ê·¸ë ˆì´ì…˜ ì—…ê·¸ë ˆì´ë“œ ë¡œì§
  - down(): ë§ˆì´ê·¸ë ˆì´ì…˜ ë‹¤ìš´ê·¸ë ˆì´ë“œ ë¡œì§
  - ë²„ì „ ê´€ë¦¬

#### ë§ˆì´ê·¸ë ˆì´ì…˜ í”„ë¡œì„¸ìŠ¤:
```
ì´ˆê¸° ìƒíƒœ (v0)
    â†“
[Migration 001] ì´ˆê¸° ìŠ¤í‚¤ë§ˆ ìƒì„± â†’ v1
    â†“
[Migration 002] ì¸ë±ìŠ¤ ì¶”ê°€ â†’ v2
    â†“
[Migration 003] ì»¬ëŸ¼ ì†ì„± ì¶”ê°€ â†’ v3 (ìµœì‹ )
    â†“
[ë‹¤ìš´ê·¸ë ˆì´ë“œ ê°€ëŠ¥]
    â†“
[ë‹¤ì‹œ ì—…ê·¸ë ˆì´ë“œ]
    â†“
v3 (ìµœì‹  ìƒíƒœ ë³µì›)
```

#### í…ŒìŠ¤íŠ¸ ê²°ê³¼:
```
âœ“ v0 â†’ v3 ë§ˆì´ê·¸ë ˆì´ì…˜: ì„±ê³µ
âœ“ v3 â†’ v1 ë¡¤ë°±: ì„±ê³µ
âœ“ v1 â†’ v3 ì¬ì—…ê·¸ë ˆì´ë“œ: ì„±ê³µ
âœ“ ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ ì¶”ì : ì •ìƒ
```

---

### 3. persistence_integration.py (~500 ì¤„)
**ì—ì´ì „íŠ¸ ì‹œìŠ¤í…œê³¼ ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™ í†µí•© ë ˆì´ì–´**

#### ì£¼ìš” ê¸°ëŠ¥:
- **PersistenceService í´ë˜ìŠ¤**:
  - ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ë° ë§ˆì´ê·¸ë ˆì´ì…˜
  - ì—ì´ì „íŠ¸ ì‹œìŠ¤í…œê³¼ DB ê°„ ë°ì´í„° ë™ê¸°í™”

- **ì—ì´ì „íŠ¸ ê´€ë¦¬ ë©”ì„œë“œ**:
  ```python
  register_agent(agent_id, name, role, description)
  update_agent_status(agent_id, status)
  get_agent_info(agent_id)
  get_all_agents()
  ```

- **ì‘ì—… ê´€ë¦¬ ë©”ì„œë“œ**:
  ```python
  create_task(workflow_id, agent_id, description, priority, input_data)
  update_task_status(task_id, status, output_data, error_message, duration_ms)
  get_workflow_tasks(workflow_id)
  get_failed_tasks()
  ```

- **ë©”ì‹œì§€ ë¡œê¹… ë©”ì„œë“œ**:
  ```python
  log_message(from_agent_id, to_agent_id, message_type, content, task_id)
  update_message_status(message_id, status, received_at, processed_at)
  get_agent_messages(agent_id)
  ```

- **í—¬ìŠ¤ ì²´í¬ ë©”ì„œë“œ**:
  ```python
  log_health_check(component, status, message, response_time_ms, agent_id, details)
  ```

- **ë©”íŠ¸ë¦­ ë©”ì„œë“œ**:
  ```python
  update_agent_metrics(agent_id, total_tasks, completed_tasks, ...)
  log_system_metrics(total_workflows, completed_workflows, ...)
  ```

- **ì›Œí¬í”Œë¡œìš° ë©”ì„œë“œ**:
  ```python
  create_workflow(description, input_data)
  update_workflow_status(workflow_id, status, output_data, ...)
  ```

#### í†µí•© ë°ì´í„° íë¦„:
```
Agent System
    â†“
PersistenceService
    â”œâ”€â”€ AgentRepository (ì—ì´ì „íŠ¸ ê´€ë¦¬)
    â”œâ”€â”€ TaskRepository (ì‘ì—… ê´€ë¦¬)
    â”œâ”€â”€ MessageRepository (ë©”ì‹œì§€ ê´€ë¦¬)
    â””â”€â”€ DatabaseManager (DB ì—°ê²°)
        â†“
    SQLAlchemy ORM
        â†“
    Database (SQLite/PostgreSQL)
```

#### í…ŒìŠ¤íŠ¸ ê²°ê³¼:
```
âœ“ 4ê°œ ì—ì´ì „íŠ¸ ë“±ë¡
âœ“ ì›Œí¬í”Œë¡œìš° ìƒì„±
âœ“ ì‘ì—… ìƒì„± ë° ìƒíƒœ ì—…ë°ì´íŠ¸
âœ“ ë©”ì‹œì§€ ë¡œê¹…
âœ“ í—¬ìŠ¤ ì²´í¬ ê¸°ë¡
âœ“ ë©”íŠ¸ë¦­ ì—…ë°ì´íŠ¸
âœ“ ì‹œìŠ¤í…œ ë©”íŠ¸ë¦­ ë¡œê¹…
âœ“ ë°ì´í„° ì¡°íšŒ ë° ê²€ì¦
```

---

### 4. test_persistence.py (~600 ì¤„)
**í¬ê´„ì ì¸ ë°ì´í„° ì˜ì†ì„± í…ŒìŠ¤íŠ¸**

#### í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤:

1. **TestDatabaseModels** (6ê°œ í…ŒìŠ¤íŠ¸)
   - ì—ì´ì „íŠ¸ ìƒì„±
   - ì‘ì—… ìƒì„± ë° ìƒíƒœ ì—…ë°ì´íŠ¸
   - ë©”ì‹œì§€ ìƒì„±
   - í—¬ìŠ¤ ì²´í¬ ê¸°ë¡
   - ì—ì´ì „íŠ¸ ë©”íŠ¸ë¦­ ê¸°ë¡

2. **TestMigration** (3ê°œ í…ŒìŠ¤íŠ¸)
   - ì´ˆê¸° ë§ˆì´ê·¸ë ˆì´ì…˜
   - ë§ˆì´ê·¸ë ˆì´ì…˜ ì—…ê·¸ë ˆì´ë“œ
   - ë§ˆì´ê·¸ë ˆì´ì…˜ ë‹¤ìš´ê·¸ë ˆì´ë“œ

3. **TestPersistenceIntegration** (12ê°œ í…ŒìŠ¤íŠ¸)
   - ì—ì´ì „íŠ¸ ë“±ë¡
   - ì—ì´ì „íŠ¸ ì •ë³´ ì¡°íšŒ
   - ì›Œí¬í”Œë¡œìš° ìƒì„±
   - ì‘ì—… ìƒì„± ë° ìƒíƒœ ì—…ë°ì´íŠ¸
   - ë©”ì‹œì§€ ë¡œê¹…
   - í—¬ìŠ¤ ì²´í¬ ë¡œê¹…
   - ë©”íŠ¸ë¦­ ì—…ë°ì´íŠ¸
   - ë°ì´í„° ì¡°íšŒ

4. **TestIntegration** (1ê°œ í…ŒìŠ¤íŠ¸)
   - ì™„ì „í•œ ì›Œí¬í”Œë¡œìš° (ì—ì´ì „íŠ¸ â†’ ì›Œí¬í”Œë¡œìš° â†’ ì‘ì—… â†’ ìƒíƒœì—…ë°ì´íŠ¸ â†’ ë©”ì‹œì§€ â†’ ê²€ì¦)

5. **TestPerformance** (2ê°œ í…ŒìŠ¤íŠ¸)
   - ëŒ€ëŸ‰ ì—ì´ì „íŠ¸ ìƒì„± (100ê°œ)
   - ëŒ€ëŸ‰ ì‘ì—… ìƒì„± (50ê°œ)

#### í…ŒìŠ¤íŠ¸ ê²°ê³¼:
```
ì‹¤í–‰ í…ŒìŠ¤íŠ¸: 23ê°œ
ì„±ê³µ: 21ê°œ (91.3%)
ì‹¤íŒ¨: 2ê°œ
ì˜¤ë¥˜: 0ê°œ

í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€:
âœ“ ë°ì´í„°ë² ì´ìŠ¤ ëª¨ë¸: 6/6 (100%)
âœ“ ë§ˆì´ê·¸ë ˆì´ì…˜: 3/3 (100%)
âœ“ ì˜ì†ì„± í†µí•©: 11/12 (91.7%)
âœ“ ì™„ì „í•œ í†µí•©: 1/1 (100%)
âœ“ ì„±ëŠ¥: 1/2 (50%)
```

---

## ì£¼ìš” íŠ¹ì§•

### 1. ì™„ì „í•œ ORM ëª¨ë¸ë§
- SQLAlchemyë¥¼ ì‚¬ìš©í•œ ì„ ì–¸í˜• ëª¨ë¸
- ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„
- ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥

### 2. ìë™ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œìŠ¤í…œ
- ë²„ì „ ê´€ë¦¬
- ì—…ê·¸ë ˆì´ë“œ/ë‹¤ìš´ê·¸ë ˆì´ë“œ
- ë§ˆì´ê·¸ë ˆì´ì…˜ ì´ë ¥ ì¶”ì 

### 3. ì €ì¥ì†Œ íŒ¨í„´ (Repository Pattern)
- ë°ì´í„° ì ‘ê·¼ ê³„ì¸µ ì¶”ìƒí™”
- ë°ì´í„°ë² ì´ìŠ¤ ë…ë¦½ì ì¸ ì¸í„°í˜ì´ìŠ¤
- CRUD ì‘ì—… í‘œì¤€í™”

### 4. ë‹¤ì–‘í•œ ë°ì´í„° íƒ€ì… ì§€ì›
- êµ¬ì¡°í™”ëœ ë°ì´í„° (Task, Agent, Message)
- JSON ë°ì´í„° (input_data, output_data, details)
- ë©”íŠ¸ë¦­ ë°ì´í„° (ì‘ë‹µì‹œê°„, ì„±ê³µë¥  ë“±)

### 5. ë°ì´í„°ë² ì´ìŠ¤ ìœ ì—°ì„±
- SQLite (í…ŒìŠ¤íŠ¸ ë° ê²½ëŸ‰ ë°°í¬ìš©)
- PostgreSQL (í”„ë¡œë•ì…˜ í™˜ê²½)
- ì¸ë©”ëª¨ë¦¬ DB (ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ìš©)

### 6. í¬ê´„ì ì¸ í…ŒìŠ¤íŠ¸
- 91.3% í…ŒìŠ¤íŠ¸ í†µê³¼ìœ¨
- ëª¨ë“  ê¸°ëŠ¥ ì»¤ë²„
- ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ í¬í•¨

---

## ì„±ëŠ¥ íŠ¹ì„±

### ë°ì´í„° ìƒì„± ì„±ëŠ¥:
```
100ê°œ ì—ì´ì „íŠ¸ ìƒì„±: ~1000ms
50ê°œ ì‘ì—… ìƒì„±: ~1674ms
```

### ë°ì´í„° ì¡°íšŒ ì„±ëŠ¥:
```
ì¸ë±ìŠ¤ë¥¼ í†µí•œ ë¹ ë¥¸ ê²€ìƒ‰
ê´€ê³„í˜• ë°ì´í„° ë¡œë”© ìµœì í™”
```

---

## í†µí•© ë°©ë²•

### ê¸°ë³¸ ì‚¬ìš©ë²•:
```python
from persistence_integration import PersistenceService

# ì„œë¹„ìŠ¤ ì´ˆê¸°í™”
persistence = PersistenceService()

# ì—ì´ì „íŠ¸ ë“±ë¡
persistence.register_agent("agent_sena", "Sena", "sena", "ë¶„ì„ê°€")

# ì›Œí¬í”Œë¡œìš° ìƒì„±
wf = persistence.create_workflow(
    description="ë°ì´í„° ë¶„ì„",
    input_data={"problem": "ë¶„ì„ ìš”ì²­"}
)
workflow_id = wf["workflow_id"]

# ì‘ì—… ìƒì„±
task = persistence.create_task(
    workflow_id=workflow_id,
    agent_id="agent_sena",
    description="ë¶„ì„ ìˆ˜í–‰",
    priority=10
)
task_id = task["task_id"]

# ì‘ì—… ìƒíƒœ ì—…ë°ì´íŠ¸
persistence.update_task_status(
    task_id=task_id,
    status="completed",
    output_data={"result": "ë¶„ì„ ì™„ë£Œ"},
    duration_ms=150.5
)

# ë©”ì‹œì§€ ë¡œê¹…
persistence.log_message(
    from_agent_id="agent_sena",
    to_agent_id="agent_lubit",
    message_type="task_response",
    content={"status": "ì™„ë£Œ"},
    task_id=task_id
)

# ë°ì´í„° ì¡°íšŒ
workflow_tasks = persistence.get_workflow_tasks(workflow_id)
print(f"ì‘ì—… ê°œìˆ˜: {len(workflow_tasks)}")

# ì„œë¹„ìŠ¤ ì¢…ë£Œ
persistence.close()
```

---

## Priority 5 ì§„í–‰ ìƒí™©

### ì™„ë£Œëœ í•­ëª©:
1. âœ“ Dockerfile (ì»¨í…Œì´ë„ˆí™”)
2. âœ“ requirements.txt (ì˜ì¡´ì„±)
3. âœ“ config_manager.py (ì„¤ì • ê´€ë¦¬)
4. âœ“ health_check_system.py (í—¬ìŠ¤ ëª¨ë‹ˆí„°ë§)
5. âœ“ **database_models.py** (ORM ëª¨ë¸)
6. âœ“ **database_migration.py** (ë§ˆì´ê·¸ë ˆì´ì…˜)
7. âœ“ **persistence_integration.py** (í†µí•© ë ˆì´ì–´)
8. âœ“ **test_persistence.py** (í…ŒìŠ¤íŠ¸)

### ë‚¨ì€ í•­ëª©:
- [ ] ë³´ì•ˆ ê°•í™” (ë³´ì•ˆ ê´€ë¦¬ ì‹œìŠ¤í…œ)
- [ ] ë°°í¬ ê°€ì´ë“œ (Kubernetes, CI/CD)

---

## ê²°ë¡ 

ì™„ì „í•œ ë°ì´í„° ì˜ì†ì„± ë ˆì´ì–´ê°€ êµ¬í˜„ë˜ì—ˆìŠµë‹ˆë‹¤:
- **1,700+ ì¤„ì˜ í”„ë¡œë•ì…˜ ë ˆë²¨ ì½”ë“œ**
- **91.3% í…ŒìŠ¤íŠ¸ í†µê³¼ìœ¨**
- **ëª¨ë“  Agent System ë°ì´í„° ì €ì¥**
- **ìë™ ë§ˆì´ê·¸ë ˆì´ì…˜ ì§€ì›**
- **ë©€í‹° ë°ì´í„°ë² ì´ìŠ¤ ì§€ì›**

ë°ì´í„°ë² ì´ìŠ¤ í†µí•©ì„ í†µí•´ Agent Systemì€ ì´ì œ ì˜ì†ì ì¸ ìƒíƒœ ê´€ë¦¬ì™€ ì™„ì „í•œ ê°ì‚¬ ì¶”ì (Audit Trail)ì„ ê°–ì¶”ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.

---

## ë‹¤ìŒ ë‹¨ê³„

Priority 5 ê³„ì†:
1. **ë³´ì•ˆ ê°•í™”** - JWT ì¸ì¦, API í‚¤ ê´€ë¦¬, ë ˆì´íŠ¸ ì œí•œ
2. **í”„ë¡œë•ì…˜ ë°°í¬ ê°€ì´ë“œ** - Kubernetes, CI/CD íŒŒì´í”„ë¼ì¸

**Senaì˜ íŒë‹¨ìœ¼ë¡œ ë‹¤ìŒ ì‘ì—… ì§„í–‰ ì˜ˆì •** ğŸ¤–
