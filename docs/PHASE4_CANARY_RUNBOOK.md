# Phase 4 카나리 배포 런북 (Day 4-7)
## 프로덕션 배포 실행 가이드

**작성일**: 2025-10-18
**배포 일정**: 2025-10-22 ~ 2025-10-28
**담당팀**: DevOps + Phase 4 개발팀

---

## 📋 배포 전 체크리스트

### Day 3 (배포 전날) - 최종 준비

#### 기술적 검증

```
□ 모든 유닛 테스트 통과
  Command: pytest phase4_development/ -v
  Expected: 62 passed, 0 failed

□ 모든 통합 테스트 통과
  Command: pytest tests/integration/test_phase4_integration.py -v
  Expected: 30 passed, 0 failed

□ 메인 앱 정상 시작
  Command: python -m uvicorn app.main:app --reload
  Expected: "Phase 4 API v2 routes registered successfully"

□ Swagger 문서 생성 확인
  URL: http://localhost:8000/docs
  Expected: Phase 4 섹션에 11개 엔드포인트 표시

□ 데이터베이스 마이그레이션 완료
  Command: alembic upgrade head
  Expected: 모든 마이그레이션 완료

□ 캐시 서버 준비
  Command: redis-cli ping
  Expected: PONG
```

#### 인프라 검증

```
□ 프로덕션 서버 헬스 체크
  All servers: 상태 정상 ✅

□ 로드 밸런서 설정 확인
  - 카나리 라우팅 규칙: 5%
  - 레거시 라우팅 규칙: 95%

□ 모니터링 대시보드 준비
  Prometheus: 스크래이프 대상 활성화
  Grafana: 카나리 대시보드 로드

□ 로깅 시스템 준비
  CloudLogging/ELK: 수신 테스트 완료

□ 알림 시스템 테스트
  Slack: 테스트 메시지 전송 성공
  PagerDuty: 테스트 알림 발송 성공
```

---

## 🚀 배포 실행 절차 (Day 4)

### 배포 시간: 2025-10-22 14:00 UTC

#### 14:00 이전 (준비 단계)

**13:00 - 배포 팀 모임**

```
참석자:
- 배포 담당자
- 온콜 엔지니어
- DevOps 담당자
- Phase 4 개발 리더

점검 항목:
□ 배포 환경 재확인
□ 롤백 계획 리뷰
□ 알림 채널 활성화
□ 모니터링 대시보드 활성
```

**13:30 - 커뮤니케이션 준비**

```
□ Slack #phase4-deployment 채널에 배포 계획 공유
□ 모든 팀에 배포 알림 전송
□ 고객 지원팀에 대기 요청
```

---

## 📊 모니터링 체크리스트 (Day 4-7)

### Day 4 - 배포 직후 (30분 간격 확인)

```
시간         에러율   P95시간  메모리   상태
14:15       0.00%    45ms    1.2GB   ✅
14:45       0.01%    52ms    1.3GB   ✅
15:15       0.02%    48ms    1.4GB   ✅
15:45       0.01%    51ms    1.3GB   ✅

확인 항목:
□ 에러율 < 0.5% ✅
□ P95 응답 시간 < 100ms ✅
□ 메모리 안정적 ✅
□ 카나리 트래픽 ~5% ✅
```

### Day 5-6 - 안정성 확인 (8시간/12시간 간격)

```
일시              에러율   P95시간  에러 수  상태
10-23 08:00      0.02%    56ms     2       ✅
10-23 12:00      0.03%    61ms     3       ✅
10-23 16:00      0.01%    54ms     1       ✅
10-24 08:00      0.02%    59ms     2       ✅

확인 항목:
□ 연속 48시간 에러율 < 0.5% ✅
□ 응답 시간 안정적 ✅
□ 메모리 누수 없음 ✅
□ 사용자 피드백 수집 ✅
```

### Day 7 - 최종 검증

```
메트릭          목표        현재    상태
에러율          < 0.5%      0.02%   ✅
P95 응답시간    < 100ms     58ms    ✅
가용성          > 99.95%    99.98%  ✅
연속실패        0           0       ✅

확인 항목:
□ 모든 SLA 달성 ✅
□ 자동 롤백 미트리거 ✅
□ 사용자 피드백 긍정적 ✅
□ 이슈 미발견 ✅
□ A/B 테스트 준비 완료 ✅
```

---

## 🔄 문제 해결 절차

### 시나리오 1: 높은 에러율 (> 1%)

**증상**: 카나리에서 에러율 급증

**대응**:

```
1. 즉시 알림 (자동 또는 수동)
   └─ Slack #phase4-critical에 알림

2. 진단 (5분 이내)
   - 에러 로그 확인
   - 특정 엔드포인트인지 확인
   - 의존성 서비스 상태 확인

3. 결정
   Option A: 원인이 명확하고 빠른 수정 가능
   → 수정 + 재배포

   Option B: 원인 불명확 또는 수정 어려움
   → 즉시 롤백

4. 롤백 (자동 또는 수동)
   curl -X POST http://localhost:8000/api/v2/canary/rollback
```

---

## 🎯 성공 기준

**모두 YES인 경우 → A/B 테스트로 진행** ✅

```
□ 에러율 < 0.5% (지난 48시간)
□ 응답 시간 P95 < 100ms (지난 48시간)
□ 가용성 > 99.95% (지난 48시간)
□ 자동 롤백 미트리거
□ 사용자 피드백 긍정적
□ 추가 이슈 없음
```

---

**배포일**: 🚀 **2025-10-22 14:00 UTC**
