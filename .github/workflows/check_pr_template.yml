name: Check PR Template Sections

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]

jobs:
  verify-pr-body:
    name: Verify PR body has required sections
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    steps:
      - name: Check required sections in PR body
        uses: actions/github-script@v7
        env:
          ALLOWED_EVIDENCE_DOMAINS: ${{ vars.ALLOWED_EVIDENCE_DOMAINS || '' }}
          ENFORCE_EVIDENCE_DOMAIN_WHITELIST: ${{ vars.ENFORCE_EVIDENCE_DOMAIN_WHITELIST || '' }}
        with:
          script: |
            const body = context.payload.pull_request?.body || "";
            const isDraft = !!context.payload.pull_request?.draft;
            const lower = body.toLowerCase();

            // 0) Draft PR는 강제 규칙을 스킵 (정보 로그만 남김)
            if (isDraft) {
              core.info("Draft PR detected: skipping strict PR template enforcement.");
              return;
            }

            // 0.1) 비어있는 본문은 즉시 실패 처리
            if (!body.trim()) {
              core.setFailed("PR 본문이 비어 있습니다. 템플릿에 따라 Summary/Decision/Evidence/Action Items를 작성해 주세요.");
              return;
            }

            // 1) 필수 헤더 존재 검사
            const required = ["## Summary", "## Decision", "## Evidence"]; // Evidence (links) 허용
            const missing = required.filter(h => !lower.includes(h.toLowerCase()));

            // Evidence 섹션이 "## Evidence (links)"로 쓰였는지도 허용
            const hasEvidenceAlt = lower.includes("## evidence (links)");
            const finalMissing = missing.filter(h => {
              if (h === "## Evidence" && hasEvidenceAlt) return false;
              return true;
            });

            // Action Items 섹션도 권장 → 필수로 승격
            const hasActions = lower.includes("## action items");
            if (!hasActions) finalMissing.push("## Action Items");

            if (finalMissing.length > 0) {
              core.setFailed(
                `PR 본문에 다음 섹션 헤더가 누락되었습니다: ${finalMissing.join(", ")}\n` +
                `템플릿(.github/PULL_REQUEST_TEMPLATE.md)의 형식을 유지해 주세요.\n` +
                `- 필수 섹션: ## Summary, ## Decision, ## Evidence (또는 ## Evidence (links)), ## Action Items\n` +
                `- 자세한 근거는 내부 링크로 연결하고, PR에는 간결 요약만 남겨 주세요.`
              );
              return;
            }

            // 2) Evidence 섹션에 링크 존재 검사 (http/https)
            function extractSection(text, header) {
              const lines = text.split(/\r?\n/);
              const startIdx = lines.findIndex(l => l.trim().toLowerCase() === header.toLowerCase());
              if (startIdx === -1) return "";
              let buf = [];
              for (let i = startIdx + 1; i < lines.length; i++) {
                const line = lines[i];
                if (/^##\s+/.test(line.trim())) break; // 다음 섹션 만나면 종료
                buf.push(line);
              }
              return buf.join("\n");
            }

            const evidenceSection = extractSection(body, hasEvidenceAlt ? "## Evidence (links)" : "## Evidence");
            const hasUrl = /https?:\/\//i.test(evidenceSection);
            if (!hasUrl) {
              core.setFailed(
                `Evidence 섹션에 최소 1개 이상의 URL 링크가 필요합니다. 내부 리포트/대시보드/로그 링크를 추가해 주세요.`
              );
              return;
            }

            // 2.1) Evidence 도메인 화이트리스트 검사 (옵션)
            // - 리포지토리/환경 변수 ALLOWED_EVIDENCE_DOMAINS="corp.local,internal.example.com" (쉼표 구분)
            // - ENFORCE_EVIDENCE_DOMAIN_WHITELIST="true" 일 때 위반 시 실패, 아니면 경고
            const allowedEnv = (process.env.ALLOWED_EVIDENCE_DOMAINS || "").trim();
            // 오타(WHITELELIST)와 정상 명칭 모두 지원
            const enforceDomain = ((process.env.ENFORCE_EVIDENCE_DOMAIN_WHITELELIST || process.env.ENFORCE_EVIDENCE_DOMAIN_WHITELIST || "").trim().toLowerCase() === "true");
            if (allowedEnv) {
              const allowedDomains = allowedEnv
                .split(",")
                .map(s => s.trim().toLowerCase())
                .filter(Boolean);
              if (allowedDomains.length > 0) {
                const urlRegex = /https?:\/\/[\w\-._~:/?#\[\]@!$&'()*+,;=%]+/gim;
                const urls = evidenceSection.match(urlRegex) || [];
                const disallowed = [];
                for (const u of urls) {
                  try {
                    const h = new URL(u).hostname.toLowerCase();
                    const ok = allowedDomains.some(d => h === d || h.endsWith("." + d) || h.endsWith(d));
                    if (!ok) disallowed.push(u);
                  } catch(e) {
                    // URL 파싱 실패는 무시(이미 hasUrl로 1개 이상은 보장)
                  }
                }
                if (disallowed.length > 0) {
                  const msg = `Evidence 링크가 허용된 도메인을 벗어났습니다. 허용: [${allowedDomains.join(", ")}]\n - 위반: ${disallowed.join("\n - ")}`;
                  if (enforceDomain) {
                    core.setFailed(msg);
                    return;
                  } else {
                    core.warning(msg);
                  }
                }
              }
            } else {
              core.info("ALLOWED_EVIDENCE_DOMAINS 미설정: 도메인 화이트리스트 검증을 스킵합니다.");
            }

            // 3) 길이 권고: 요약/결정 섹션 길이가 너무 길면 경고
            const summarySection = extractSection(body, "## Summary");
            const decisionSection = extractSection(body, "## Decision");
            const summaryLines = summarySection.split(/\r?\n/).filter(l => l.trim() !== "").length;
            const decisionLines = decisionSection.split(/\r?\n/).filter(l => l.trim() !== "").length;
            if (summaryLines > 10) {
              core.warning(`Summary 섹션이 권장 길이(<=10줄)를 초과했습니다. 현재 ${summaryLines}줄입니다.`);
            }
            if (decisionLines > 6) {
              core.warning(`Decision 섹션이 권장 길이(<=6줄)를 초과했습니다. 현재 ${decisionLines}줄입니다.`);
            }

            // 4) Action Items 섹션에 체크박스가 최소 1개 이상인지 확인
            const actionsSection = extractSection(body, "## Action Items");
            const checkboxCount = (actionsSection.match(/^\s*- \[[ xX]\]/gmi) || []).length;
            if (checkboxCount < 1) {
              core.setFailed("Action Items 섹션에 최소 1개 이상의 체크박스 항목이 필요합니다. 예: - [ ] TODO");
              return;
            }

            // 5) Security/PII 섹션 권고 검사: 누락 시 경고, 내용 권고 키워드 유무 경고
            const hasSecPii = lower.includes("## security/pii");
            if (!hasSecPii) {
              core.warning("Security/PII 섹션이 누락되었습니다. 시크릿/개인정보 여부를 명시해 주세요.");
            } else {
              const secPiiSection = extractSection(body, "## Security/PII");
              const okKeywords = /(없음|no pii|none|분리|separate|mask|masked|마스킹|redact|비식별)/i;
              if (!okKeywords.test(secPiiSection)) {
                core.warning("Security/PII 섹션에 '없음/none' 또는 '분리/마스킹' 등의 명시를 추가해 주세요.");
              }
            }

            core.info("PR template checks passed: required sections present and evidence has links.");
